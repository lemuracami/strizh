
//**** Обработчики событий объекта ****//

//Заполнение вспомогательных реквизитов
//
Процедура ПередЗаписью(Отказ)
	
	Если ОбменДанными.Загрузка = Истина Тогда  // Задача № 2418
		Возврат;
	КонецЕсли;	
	
	Если Не ЭтоГруппа Тогда
		КоличествоВыбранныхРайонов = Районы.Количество();
		КатегорииТранспортаСтрокой = новаТранспорт.СформироватьПолноеНаименованиеКатегории(КатегорииТранспорта);		
	КонецЕсли;
	
	
	Если ЗначениеЗаполнено(НомерЛог) Тогда
		//Зап = Новый Запрос;
		//Зап.Текст = "ВЫБРАТЬ
		//|	новаТранспорт.Ссылка
		//|ИЗ
		//|	Справочник.новаТранспорт КАК новаТранспорт
		//|ГДЕ
		//|	новаТранспорт.НомерЛог = &НомерЛог
		//|	И новаТранспорт.Ссылка <> &ВыбСсылка";
		//Зап.УстановитьПараметр("НомерЛог", НомерЛог);
		//Зап.УстановитьПараметр("ВыбСсылка", Ссылка);
		//Рез = Зап.Выполнить();
		//Если Не Рез.Пустой() Тогда
		//	Отказ = Истина;
		//	Выб = Рез.Выбрать();
		//	Если Выб.Следующий() Тогда
		//		#Если Клиент Тогда
		//			Сообщить("Поле ""Номер для выгрузки на ТСД"" не уникально! (" + Выб.Ссылка + ").");
		//		#КонецЕСли
		//	КонецЕСли;
		//КонецеСли;	
	КонецЕСли;
	
КонецПроцедуры

//Синхронизация с КСЛ, очистка норм
//
Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка = Истина Тогда  // Задача № 2418
		Возврат;
	КонецЕсли;	
	
	Если Не ЭтоГруппа Тогда
		// Удаление индивидуальных норм
		Если Не ИндивидуальныеНормы Тогда
			нзНормы = РегистрыСведений.новаНормыРасходаГСМ.СоздатьНаборЗаписей();
			нзНормы.Отбор.МаркаТранспорт.Установить(Ссылка);
			нзНормы.Прочитать();
			Если нзНормы.Количество() <> 0 Тогда
				
				#Если Клиент Тогда			
					Ответ = Вопрос("Индивидуальные нормы этого транспорта будут удалены. Продолжить?",РежимДиалогаВопрос.ОКОтмена);
					Если Ответ = КодВозвратаДиалога.ОК Тогда
						нзНормы.Очистить();
						нзНормы.Записать();
					Иначе
						Отказ = Истина;
						Возврат;
					КонецЕсли;
				#Иначе
					нзНормы.Очистить();
					нзНормы.Записать();
				#КонецЕсли
				
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	
	Если Не ЭтоГруппа Тогда
		Попытка
			новаОбменКСЛ.СохранитьТранспорт(ЭтотОбъект);
			Подкл = Евген.СоздатьПодключениеКИнтернетМагазину();
			
			МаркаТекст = "";
			Если Не Марка.Пустая() Тогда
				МаркаТекст = СокрЛП(Марка.Наименование);
			КонецеСли;	
			
			Евген.ЗапросКИнтернетМагазину("
			|EXEC pb_UpdateCar '" + СокрЛП(НомерГосударственнойРегистрации) + "', '',5,1,'" + МаркаТекст + "'", Подкл);		
		Исключение
			#Если Клиент Тогда			
				новаОбщиеПроцедуры.СообщитьПользователюОбОшибке("ВнутренняОшибкаСервера", ОписаниеОшибки());
			#КонецЕсли
			Отказ = Истина;
		КонецПопытки;
	КонецеСли;
КонецПроцедуры

//Синхронизация с КСЛ
//
Процедура ПередУдалением(Отказ)
	Если Не ЭтоГруппа Тогда
		Попытка
			новаОбменКСЛ.УдалитьТранспорт(ЭтотОбъект);
		Исключение
			#Если Клиент Тогда			
				новаОбщиеПроцедуры.СообщитьПользователюОбОшибке("ВнутренняОшибкаСервера", ОписаниеОшибки());
			#КонецЕсли
			Отказ = Истина;
		КонецПопытки;
	КонецеСли;
	
КонецПроцедуры


