//Бухаров 03.09
//Возвращает Истина, если Москва
Функция ОпределениеМосквы(Широта, Долгота) Экспорт 

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Адреса.Ссылка КАК Адрес,
		|	Ребра.Ссылка КАК Район,
		|	Ребра.Ссылка.Владелец КАК Классификатор
		|ИЗ
		|	(ВЫБРАТЬ
		|		ЗНАЧЕНИЕ(Справочник.новаАдреса.ПустаяСсылка) КАК Ссылка,
		|		&Широта КАК Широта,
		|		&Долгота КАК Долгота) КАК Адреса
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.новаГеоРайоны.Ребра КАК Ребра
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МосковскиеРайоны КАК МосковскиеРайоны
		|			ПО Ребра.Ссылка = МосковскиеРайоны.РайонДоставки
		|		ПО (Адреса.Долгота МЕЖДУ Ребра.Долгота1 И Ребра.Долгота2
		|				ИЛИ Адреса.Долгота МЕЖДУ Ребра.Долгота2 И Ребра.Долгота1)
		|ГДЕ
		|	МосковскиеРайоны.Используется
		|
		|СГРУППИРОВАТЬ ПО
		|	Адреса.Ссылка,
		|	Ребра.Ссылка.Владелец,
		|	Ребра.Ссылка
		|
		|ИМЕЮЩИЕ
		|	КОЛИЧЕСТВО(Ребра.Ссылка) > 0 И
		|	СУММА(ВЫБОР
		|			КОГДА (Ребра.Широта2 - Ребра.Широта1) * (Адреса.Долгота - Ребра.Долгота1) < (Адреса.Широта - Ребра.Широта1) * (Ребра.Долгота2 - Ребра.Долгота1)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ) <> СУММА(ВЫБОР
		|			КОГДА (Ребра.Широта2 - Ребра.Широта1) * (Адреса.Долгота - Ребра.Долгота1) > (Адреса.Широта - Ребра.Широта1) * (Ребра.Долгота2 - Ребра.Долгота1)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ)";

	Запрос.УстановитьПараметр("Долгота", Долгота);
	Запрос.УстановитьПараметр("Широта", Широта);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат Выборка.Количество() > 0;

КонецФункции


Функция ОпределениеПринадлежностиКГруппеРайонов(ГруппаРайонов, Широта, Долгота) Экспорт 

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Адреса.Ссылка КАК Адрес,
		|	Ребра.Ссылка КАК Район,
		|	Ребра.Ссылка.Владелец КАК Классификатор
		|ИЗ
		|	(ВЫБРАТЬ
		|		ЗНАЧЕНИЕ(Справочник.новаАдреса.ПустаяСсылка) КАК Ссылка,
		|		&Широта КАК Широта,
		|		&Долгота КАК Долгота) КАК Адреса
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.новаГеоРайоны.Ребра КАК Ребра
		|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГруппыРайонов.Районы КАК ГруппыРайоновРайоны
		|			ПО Ребра.Ссылка = ГруппыРайоновРайоны.Район
		|		ПО (Адреса.Долгота МЕЖДУ Ребра.Долгота1 И Ребра.Долгота2
		|				ИЛИ Адреса.Долгота МЕЖДУ Ребра.Долгота2 И Ребра.Долгота1)
		|ГДЕ
		|	ГруппыРайоновРайоны.Ссылка = &ГруппаРайонов
		|
		|СГРУППИРОВАТЬ ПО
		|	Адреса.Ссылка,
		|	Ребра.Ссылка.Владелец,
		|	Ребра.Ссылка
		|
		|ИМЕЮЩИЕ
		|	КОЛИЧЕСТВО(Ребра.Ссылка) > 0 И
		|	СУММА(ВЫБОР
		|			КОГДА (Ребра.Широта2 - Ребра.Широта1) * (Адреса.Долгота - Ребра.Долгота1) < (Адреса.Широта - Ребра.Широта1) * (Ребра.Долгота2 - Ребра.Долгота1)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ) <> СУММА(ВЫБОР
		|			КОГДА (Ребра.Широта2 - Ребра.Широта1) * (Адреса.Долгота - Ребра.Долгота1) > (Адреса.Широта - Ребра.Широта1) * (Ребра.Долгота2 - Ребра.Долгота1)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ)";

	Запрос.УстановитьПараметр("Долгота", Долгота);
	Запрос.УстановитьПараметр("Широта", Широта);
	Запрос.УстановитьПараметр("ГруппаРайонов", ГруппаРайонов);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат Выборка.Количество() > 0;

КонецФункции


