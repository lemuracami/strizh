
&НаКлиенте
Процедура СписокФотоПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура СписокФотоПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура СписокФотоПередНачаломИзменения(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьФото(Команда)
	//Д = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	//
	//Д.ПолноеИмяФайла = "";
	//Фильтр = "Картинки (*.jpg)|*.jpg";
	//Д.Фильтр = Фильтр;
	//Д.МножественныйВыбор = Ложь;
	//Д.Заголовок = "Выберите документ";
	//Если Д.Выбрать() Тогда
	//	
	//	НовСтр = МассивПриложенныхФото.Добавить();
	//	НовИд = ЭтаФорма.УникальныйИдентификатор;
	//	
	//	ЛокХранилище = Новый ХранилищеЗначения(Новый ДвоичныеДанные(Д.ПолноеИмяФайла));
	//	АдресПриложения = ПоместитьВоВременноеХранилище(ЛокХранилище, НовИд);
	//	
	//	НовСтр.АдресПриложения = АдресПриложения;
	//	НовСтр.УникальныйИдентификатор = НовИд;
	//	НовСтр.РасширениеДокумента = Прав(Д.ПолноеИмяФайла, 3);
	//	НовСтр.ИмяФайла = ТипПрикрепляемыхДокументов.Наименование + "." + НовСтр.РасширениеДокумента;
	//	Модифицированность = Истина;
	//КонецеСли;		
	//ЗаписатьФотоВБД(ТипПрикрепляемыхДокументов);
	//lem.ОбновлениеДанныхПриложенныхФото(Документ, МассивЗаписанныхФото, ЭтаФорма);
	//ОбновитьДанныеСписка();
	//Оповестить("ОбновитьНадписьФото");
	
	Д = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	Д.ПолноеИмяФайла = "";
	Фильтр = "Картинки (*.jpg)|*.jpg";
	Д.Фильтр = Фильтр;
	Д.МножественныйВыбор = Ложь;
	Д.Заголовок = "Выберите документ";
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеВыбораФайла", ЭтаФорма);
	
	НачатьПомещениеФайла(ОписаниеОповещения,,Д,Истина,ЭтаФорма.УникальныйИдентификатор);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайла(Результат, АдресВХ, ПомещаемыйФайл, ДополнительныеПараметры) Экспорт

	Если НЕ Результат Тогда
		Возврат;
	КонецЕсли; 
	
	Сч = 1;
	ИмяФайла = Прав(ПомещаемыйФайл, Сч);
	
	Пока Лев(ИмяФайла,1) <> "\" Цикл
		ИмяФайла = Прав(ПомещаемыйФайл, Сч);
		Сч = Сч + 1;
	КонецЦикла; 
	
	ИмяФайла = СтрЗаменить(ИмяФайла, "\", "");
	
	НовСтр = МассивПриложенныхФото.Добавить();
	НовИд = ЭтаФорма.УникальныйИдентификатор;
		
	НовСтр.АдресПриложения = АдресВХ;
	НовСтр.УникальныйИдентификатор = НовИд;
	НовСтр.РасширениеДокумента = Прав(ПомещаемыйФайл, 3);
	НовСтр.ИмяФайла = ИмяФайла;
	Модифицированность = Истина;
	
	ЗаписатьФотоВБД(ТипПрикрепляемыхДокументов);
		
	//lem.ОбновлениеДанныхПриложенныхФото(Документ, МассивЗаписанныхФото, ЭтаФорма);
	ОбновлениеДанныхПриложенныхФото();
	ОбновитьДанныеСписка();
	Оповестить("ОбновитьНадписьФото");
	
КонецПроцедуры // ()
 
&НаСервере
Процедура ЗаписатьФотоВБД(ТипПр) 
	Для Каждого Тек Из МассивПриложенныхФото Цикл
		НовСпр = Справочники.ПрикрепленныеФайлы.СоздатьЭлемент();
		НовСпр.РасширениеДокумента = Тек.РасширениеДокумента;
		НовСпр.ТипДокумента = ТипПр;
		НовСпр.ДатаСоздания = ТекущаяДата();
		НовСпр.Данные = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(Тек.АдресПриложения));
		НовСпр.Наименование = СокрЛП(Тек.ИмяФайла);
		НовСпр.Пользователь = глЗначениеПеременной("глТекущийПользователь");
		НовСпр.Записать();
		
		//CeHbKA #3749 14.04.2020
		ИдентификаторВнешнихДанных = ВнешниеДанныеСервер.ЗаписатьДанныеВоВнешнееХранилищеДанных(Тек.ИмяФайла, Тек.РасширениеДокумента, Тек.АдресПриложения,, Документ, ТипПр);
		//CeHbKA #3749 14.04.2020
		
		Наб = РегистрыСведений.ПрикрепленныеФайлы.СоздатьНаборЗаписей();
		
		Наб.Отбор.Документ.Установить(Документ.Ссылка);
		Наб.Отбор.Данные.Установить(НовСпр.Ссылка);
		
		Нов = Наб.Добавить();
		Нов.Данные = НовСпр.Ссылка;
		Нов.Документ = Документ.Ссылка;
		Нов.Заказ = Заказ;
		Нов.ИнтернетМагазин = Заказ.ВладелецТовара;
		//CeHbKA #3749 14.04.2020
		Нов.ИдентификаторВнешнихДанных = ИдентификаторВнешнихДанных;
		//CeHbKA #3749 14.04.2020
		
		Наб.Записать();
				
	КонецЦикла;	
	МассивПриложенныхФото.Очистить();
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьКартинку()
	Тек = Элементы.СписокФото.ТекущиеДанные;
	Если Тек <> Неопределено Тогда
		Струк = Новый Структура;
		Струк.Вставить("Ссылка", Тек.Ссылка);
		Най = МассивЗаписанныхФото.НайтиСтроки(Струк);
		Если Най.Количество() <> 0 тОгда
			//Хр = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(Най[0].АдресПриложения));
			//Дв = Хр.Получить().Получить();
			//Элементы.Фото.Картинка = Новый Картинка(Дв);
			АдресКартинки = Най[0].АдресПриложения;
			Элементы.Фото.РазмерКартинки = РазмерКартинки.Пропорционально;
		КонецеСли;	
	КонецеСли;	
КонецПроцедуры	
&НаКлиенте

Процедура ОбновитьДанныеСписка()
	//СписокФото.Отбор.элементы[0].ПравоеЗначение = Документ;
	//СписокФото.Отбор.элементы[0].Использование = Истина;
	//
	//СписокФото.Отбор.элементы[1].ПравоеЗначение = Заказ;
	//СписокФото.Отбор.элементы[1].Использование = Истина;
	//
	//СписокФото.Отбор.элементы[2].ПравоеЗначение = ТипПрикрепляемыхДокументов;
	//СписокФото.Отбор.элементы[2].Использование = Истина;
	
	Если ЗначениеЗаполнено(Документ) Тогда
		УстановитьОтбор("Документ", Документ);
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(Заказ) Тогда
		УстановитьОтбор("Заказ", Заказ);
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(ТипПрикрепляемыхДокументов) Тогда
		УстановитьОтбор("ТипДокумента", ТипПрикрепляемыхДокументов);
	КонецЕсли; 
	
	Элементы.СписокФото.Обновить();
	//ЗагрузитьКартинку();
КонецПроцедуры	

&НаКлиенте
Процедура УстановитьОтбор(ИмяПоля, ЗначениеОтбора)

	ЭлементОтбора = СписокФото.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(ИмяПоля);
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение = ЗначениеОтбора;
	ЭлементОтбора.Использование = Истина;	

КонецПроцедуры // ()
 
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОбновитьДанныеСписка();
	//lem.ОбновлениеДанныхПриложенныхФото(Документ, МассивЗаписанныхФото, ЭтаФорма);
	ОбновлениеДанныхПриложенныхФото();
	ЗагрузитьКартинку();
КонецПроцедуры

&НаКлиенте
Процедура СписокФотоПриАктивизацииСтроки(Элемент)
	ЗагрузитьКартинку();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьФото(Команда)
	Д = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	Тек = Элементы.СписокФото.ТекущиеДанные;
	
	Если Тек = Неопределено Тогда
		Возврат;
	КонецеСли;
	
	Струк = Новый Структура;
	Струк.Вставить("Ссылка", Тек.Ссылка);
	Най = МассивЗаписанныхФото.НайтиСтроки(Струк);
	Если Най.Количество() <> 0 тОгда
		ПолучитьФайл(Най[0].АдресПриложения, Най[0].ИмяФайла, Истина);
	КонецЕсли;

	//Д.ПолноеИмяФайла = "";
	//Фильтр = "Картинки (*.jpg)|*.jpg";
	//Д.Фильтр = Фильтр;
	//Д.МножественныйВыбор = Ложь;
	//Д.Заголовок = "Выберите документ";
	//Если Д.Выбрать() Тогда
	//	Струк = Новый Структура;
	//	Струк.Вставить("Ссылка", Тек.Ссылка);
	//	Най = МассивЗаписанныхФото.НайтиСтроки(Струк);
	//	Если Най.Количество() <> 0 тОгда
	//		
	//		Хр = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(Най[0].АдресПриложения));
	//		Дв = Хр.Получить();
	//		
	//		Попытка
	//			Дв.Записать(Д.ПолноеИмяФайла,);
	//		Исключение
	//			Предупреждение("Произошла ошибка при записи документа. Возможно, документ открыт.");
	//			Возврат;
	//		КонецПопытки;				
	//	КонецеСли;
	//КонецеСли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ПросмотрФайла(Команда)
	
	Тек = Элементы.СписокФото.ТекущиеДанные;
	
	Если Тек = Неопределено Тогда
		Возврат;
	КонецеСли;

	Струк = Новый Структура;
	Струк.Вставить("Ссылка", Тек.Ссылка);
	Най = МассивЗаписанныхФото.НайтиСтроки(Струк);
	
	Если Най.Количество() <> 0 тОгда
		
		//Хр = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(Най[0].АдресПриложения));
		//
		//ДД = Хр.Получить();
		
		ИмяВрФайла = ПолучитьИмяВременногоФайла(Тек.РасширениеДокумента);
		
		ПолучитьФайл(Най[0].АдресПриложения, ИмяВрФайла, Ложь);
		
		//Попытка
		//	ДД.Записать(ИмяВрФайла);
		//Исключение
		//	Сообщение = Новый СообщениеПользователю;
		//	Сообщение.Текст = "Не удалось сохранить файл! "+ОписаниеОшибки();
		//	Сообщение.Сообщить(); 	
		//	Возврат;	
		//КонецПопытки;
		
	КонецЕсли;
	
	ЗапуститьПриложение(ИмяВрФайла);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьДанныеВХ()
КонецФункции

&НаСервере
Процедура ОбновлениеДанныхПриложенныхФото() 
	Зап = Новый Запрос;
	Зап.Текст = "ВЫБРАТЬ
	|	ПрикрепленныеФайлы.Данные.Ссылка КАК Ссылка,
	|	ПрикрепленныеФайлы.Заказ
	|ПОМЕСТИТЬ ВТДокументы
	|ИЗ
	|	РегистрСведений.ПрикрепленныеФайлы КАК ПрикрепленныеФайлы
	|ГДЕ
	|	ПрикрепленныеФайлы.Документ = &Документ
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрикрепленныеФайлы.Данные.Ссылка,
	|	ПрикрепленныеФайлы.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТДокументы.Ссылка.Данные КАК Данные,
	|	ВТДокументы.Ссылка.Ссылка КАК Ссылка,
	|	ВТДокументы.Ссылка.Наименование + ""___"" + ""."" + ВТДокументы.Ссылка.РасширениеДокумента КАК ИмяФайла,
	|	ВТДокументы.Ссылка.Код КАК Код,
	|	ВТДокументы.Заказ
	|ИЗ
	|	ВТДокументы КАК ВТДокументы
	|ГДЕ
	|	ВТДокументы.Ссылка.ТипДокумента = &ТипДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДокументы";
	Зап.УстановитьПараметр("Документ", Документ.Ссылка);
	Зап.УстановитьПараметр("ТипДокумента", ЭтаФорма.ТипПрикрепляемыхДокументов);
	Рез = Зап.Выполнить().Выгрузить();
	МассивЗаписанныхФото.Очистить();
	Для Каждого Тек Из Рез Цикл
		Нов = МассивЗаписанныхФото.Добавить();
		АдресПриложения = ПоместитьВоВременноеХранилище(Тек.Данные.Получить(),ЭтаФорма.УникальныйИдентификатор);
		Нов.АдресПриложения = АдресПриложения;
		Нов.Ссылка = Тек.Ссылка;
		Нов.ИмяФайла = Тек.имяФайла;
		Нов.ИмяФайла = СтрЗаменить(Нов.ИмяФайла, "___", "_" + Строка(Тек.Код));
		Нов.Заказ = Тек.Заказ;
	КонецЦикла;	
КонецПроцедуры