Функция ОбновитьАдминку(Режим)
	Попытка
		ПодключениеКМагазину = Евген.СоздатьПодключениеКИнтернетМагазину(); 
	Исключение
		НормальныйХодВыполнения = Ложь;
		Возврат Ложь;
	КонецПопытки;
	
	
	Если Режим = "Проведение" Тогда
		Для Каждого Тек Из Транспорт Цикл
			МаркаТекст = "";
			Если Не Тек.Транспорт.Марка.Пустая() Тогда
				МаркаТекст = СокрЛП(Тек.Транспорт.Марка.Наименование);
			КонецеСли;	
			
			
			ЗапросКИнтернетМагазину("EXEC pb_UpdateCar '" + СокрЛП(Тек.Транспорт.НомерГосударственнойРегистрации) + "','" + СокрЛП(Тек.ТА.Телефон) + "', 5, 1,'" + МаркаТекст + "'", ПодключениеКМагазину);
			//|UPDATE dbo._car SET phone='" + СокрЛП(Тек.ТА.Телефон) + "'
			//|WHERE carNumber = '" + СокрЛП(Тек.Транспорт.НомерГосударственнойРегистрации) + "'", ПодключениеКМагазину);
			
			//ЗапросКИнтернетМагазину("
		КонецЦикла;	
	ИначеЕсли Режим = "ОтменаПроведения" Тогда
		//Для Каждого Тек Из Транспорт Цикл
		//	Стр = Новый Структура;
		//	
		//	Стр.Вставить("Транспорт", Тек.Транспорт);
		//	
		//	ТА = РегистрыСведений.ТелефонныеАппаратыТранспорта.ПолучитьПоследнее(Дата-1, Стр).ТА;
		//	
		//	Если ЗначениеЗаполнено(ТА) Тогда
		//		ЗапросКИнтернетМагазину("
		//		|UPDATE dbo._car SET phone='" + СокрЛП(ТА.Телефон) + "'
		//		|WHERE carNumber = '" + СокрЛП(Тек.Транспорт.НомерГосударственнойРегистрации) + "'", ПодключениеКМагазину);
		//	Иначе
		//		ЗапросКИнтернетМагазину("
		//		|UPDATE dbo._car SET phone=''
		//		|WHERE carNumber = '" + СокрЛП(Тек.Транспорт.НомерГосударственнойРегистрации) + "'", ПодключениеКМагазину);
		//	КонецеСли;
		//КонецЦикла;	
		
	КонецеСли;
КонецФункции


Процедура ОбработкаПроведения(Отказ, Режим)
	//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	// регистр ТелефонныеАппаратыТранспорта
	Движения.ТелефонныеАппаратыТранспорта.Записывать = Истина;
	Движения.ТелефонныеАппаратыТранспорта.Очистить();
	Для Каждого ТекСтрокаТранспорт Из Транспорт Цикл
		Движение = Движения.ТелефонныеАппаратыТранспорта.Добавить();
		Движение.Период = Дата;
		Движение.Транспорт = ТекСтрокаТранспорт.Транспорт;
		Движение.ТА = ТекСтрокаТранспорт.ТА;
	КонецЦикла;
    Движения.ТелефонныеАппаратыТранспорта.Записать();
	
	ОбновитьАдминку("Проведение");
	//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры



Функция ЗапросКИнтернетМагазину(ТекстЗапроса, ПодключениеКМагазину) Экспорт
	//Сообщить("======= Запрос =======");
	//Сообщить(ТекстЗапроса);
	Cmd = Новый COMОбъект("ADODB.Command");
	Cmd.ActiveConnection = ПодключениеКМагазину;
	Cmd.CommandText = ТекстЗапроса;
	Cmd.CommandType = 1;
	Возврат Cmd.Execute();
КонецФункции // ЗапросКИнтернетМагазину()

Процедура ОбработкаУдаленияПроведения(Отказ)
	ОбновитьАдминку("ОтменаПроведения");	
КонецПроцедуры


