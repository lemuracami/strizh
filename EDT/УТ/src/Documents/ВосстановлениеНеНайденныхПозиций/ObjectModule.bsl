
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	// Вставить содержимое обработчика.
	Соединение = Евген.СоздатьПодключениеКИнтернетМагазину();
	Для Каждого Тек Из Доставки Цикл
		ИсправитьДоставку(Соединение, Тек, Ложь);
	КонецЦикла;	
КонецПроцедуры



Процедура ИсправитьДоставку(Соединение, Тек_, Режим);
	Если Режим Тогда
		Струк = Новый Структура;
		Струк.Вставить("Доставка", Тек_.Доставка);
		НайСтр = Тек_.Документ.Товары.НайтиСтроки(Струк);
		Кол1 = 0;
		Кол2 = 0;
		
		Для Каждого Стр Из НайСтр Цикл
			Кол1 = Кол1 + Стр.Количество;
			Кол2 = Кол2 + Стр.НеобходимоеКоличество;
		КонецЦикла;	
		Если Кол1 = Кол2 Тогда
			Возврат;
		КонецеСли;	
		Дост = БизнесПроцессы.новаМестнаяДоставка.НайтиПоНомеру(Тек_.Доставка.Номер);
		Для Каждого Тек Из НайСтр Цикл
			Кол = Тек.НеобходимоеКоличество - Тек.Количество;
			Если Кол = 0 Тогда
				Продолжить;
			КонецеСли;	
			КодТовара = Число(Тек.Номенклатура.Код);
			
			
			евген.ЗапросКИнтернетМагазину("DECLARE @t TMissedCount
			|INSERT INTO @t ([skuid],[MissedCount]) VALUES (" + Формат(КодТовара, "ЧГ=") + ", " + Формат(Кол, "ЧН=0; ЧГ=") + ")" + "
			|EXEC sp_setMissedCount " + Формат(Число(Тек.Доставка.Номер), "ЧГ=") + ", @t, 0", Соединение);
			
			
			//Д = Документы.РеализацияТоваровУслуг.НайтиПоНомеру(Тек.Доставка.Номер);
			//ОбД = Д.ПолучитьОбъект();
			//Если Тек.Сумма <> 0 Тогда
			//	Най = ОбД.Товары.Найти(Тек.Номенклатура);
			//	Если Най <> Неопределено Тогда
			//		Если Тек.Количество <= 0 Тогда
			//			ОбД.Товары.Удалить(Най);
			//		Иначе
			//			Най.Количество = Тек.Количество;
			//			Най.Сумма = Най.Количество * Най.Цена;
			//			ОбработкаТабличныхЧастей.РассчитатьСуммуНДСТабЧасти(Най, ОбД);
			//		КонецеСли;	
			//		
			//		ОбД.Записать(РежимЗаписиДокумента.Запись);
			//		Если ОбД.Проведен Тогда
			//			ОбД.Записать(РежимЗаписиДокумента.Проведение);
			//		конецеСли;	
			//	КонецеСли;
			//Иначе
			//	Най = ОбД.ПодарочныеПозиции.Найти(Тек.Номенклатура);
			//	Если Най <> Неопределено Тогда
			//		Если Тек.Количество <= 0 Тогда
			//			ОбД.ПодарочныеПозиции.Удалить(Най);
			//		Иначе
			//			Най.Количество = Тек.Количество;
			//			Най.Сумма = Най.Количество * Най.Цена;
			//		КонецеСли;	
			//		
			//		ОбД.Записать(РежимЗаписиДокумента.Запись);
			//		Если ОбД.Проведен Тогда
			//			ОбД.Записать(РежимЗаписиДокумента.Проведение);
			//		конецеСли;	
			//	КонецеСли;
			//КонецеСли;
			
			//Д = Документы.ПеремещениеТоваров.НайтиПоНомеру(Тек.Доставка.Номер);
			//
			//ОбД = Д.ПолучитьОбъект();
			//Струк = Новый Структура;
			//Струк.Вставить("Номенклатура", тек.Номенклатура);
			//Струк.Вставить("Количество", тек.НеобходимоеКоличество);
			//
			//Най = ОбД.Товары.НайтиСтроки(Струк);
			//Если Най.Количество() <> 0 Тогда
			//	Най_ = Най[0];
			//	Если Най_ <> Неопределено Тогда
			//		Если Тек.Количество = 0 Тогда
			//			ОбД.Товары.Удалить(Най_);
			//		Иначе
			//			Най_.Количество = Тек.Количество;
			//		КонецеСли;	
			//		
			//		ОбД.Записать(РежимЗаписиДокумента.Запись);
			//		Если ОбД.Проведен Тогда
			//			ОбД.Записать(РежимЗаписиДокумента.Проведение);
			//		конецеСли;	
			//	КонецеСли;
			//Иначе
			//	
			//КонецеСли;
			
			//Д = Дост.Груз.Ссылка;
			//Если ЗначениеЗаполнено(Д) Тогда
			//	ОбД = Д.ПолучитьОбъект();
			//	Струк = Новый Структура;
			//	Струк.Вставить("Товар", тек.Номенклатура);
			//	Струк.Вставить("Стоимость", тек.Сумма);
			//	
			//	Най = ОбД.Спецификация.НайтиСтроки(Струк);
			//	Если Най.Количество() <> 0 Тогда
			//		Най_ = Най[0];
			//		Если Най_ <> Неопределено Тогда
			//			Если НАй_.Количество - Кол = 0 Тогда
			//				ОбД.Спецификация.Удалить(Най_);
			//			Иначе
			//				Най_.Количество = НАй_.Количество - Кол;
			//			КонецеСли;	
			//			
			//			ОбД.Записать(РежимЗаписиДокумента.Запись);
			//			Если ОбД.Проведен Тогда
			//				ОбД.Записать(РежимЗаписиДокумента.Проведение);
			//			конецеСли;	
			//		КонецеСли;
			//	Иначе
			//	КонецеСли;
			//КонецеСли;
		КонецЦикла;
	Иначе
		Струк = Новый Структура;
		Струк.Вставить("Доставка", Тек_.Доставка);
		НайСтр = Тек_.Документ.Товары.НайтиСтроки(Струк);
		Кол1 = 0;
		Кол2 = 0;
		
		Для Каждого Стр Из НайСтр Цикл
			Кол1 = Кол1 + Стр.Количество;
			Кол2 = Кол2 + Стр.НеобходимоеКоличество;
		КонецЦикла;	
		Если Кол1 = Кол2 Тогда
			Возврат;
		КонецеСли;	
		Дост = БизнесПроцессы.новаМестнаяДоставка.НайтиПоНомеру(Тек_.Доставка.Номер);
		Д = Документы.РеализацияТоваровУслуг.НайтиПоНомеру(Тек_.Доставка.Номер);
		ОбД = Д.ПолучитьОбъект();
		Д2 = Документы.ПеремещениеТоваров.НайтиПоНомеру(Тек_.Доставка.Номер);
		ОбД2 = Д2.ПолучитьОбъект();
		Если Не Дост.Пустая() Тогда
			Д3 = Дост.Груз.Ссылка;
			ОбД3 = Д3.ПолучитьОбъект();
		Иначе
			Д3 = ДОКУМЕНТЫ.новаГруз.ПустаяСсылка();
		КонецеСли;	
		
		Для Каждого Тек Из НайСтр Цикл
			Кол = Тек.НеобходимоеКоличество;
			Если Кол = 0 Тогда
				Продолжить;
			КонецеСли;	
			КодТовара = Число(Тек.Номенклатура.Код);
			
			евген.ЗапросКИнтернетМагазину("DECLARE @t TMissedCount
			|INSERT INTO @t ([skuid],[MissedCount]) VALUES (" + Формат(КодТовара, "ЧГ=") + ", " + Формат(0, "ЧН=0; ЧГ=") + ")" + "
			|EXEC sp_setMissedCount " + Формат(Число(Тек.Доставка.Номер), "ЧГ=") + ", @t, 1", Соединение);
			
			//Если Тек.Сумма <> 0 Тогда
			//	Най = ОбД.Товары.Найти(Тек.Номенклатура);
			//	Если Най <> Неопределено Тогда
			//		Най.Количество = Тек.НеобходимоеКоличество;
			//		Най.Сумма = Най.Количество * Най.Цена;
			//		ОбработкаТабличныхЧастей.РассчитатьСуммуНДСТабЧасти(Най, ОбД);
			//		
			//	Иначе
			//		Нов = ОбД.Товары.Добавить();
			//		Нов.Номенклатура = Тек.Номенклатура;
			//		Нов.ЕдиницаИзмерения = Нов.Номенклатура.ЕдиницаХраненияОстатков;
			//		Нов.Коэффициент = 1;
			//		Нов.Качество = Справочники.Качество.Новый;
			//		Нов.Количество = Тек.НеобходимоеКоличество;
			//		Если ЗначениеЗаполнено(Тек.Номенклатура) Тогда
			//			Нов.СтавкаНДС = Тек.Номенклатура.СтавкаНДС;
			//		КонецеСли;	
			//		Нов.Сумма = Тек.Сумма;
			//		Нов.Цена = Окр(Нов.Сумма/Нов.Количество, 2);
			//		ОбработкаТабличныхЧастей.РассчитатьСуммуНДСТабЧасти(Нов, ОбД);
			//	КонецеСли;
			//	
			//Иначе
			//	Най = ОбД.ПодарочныеПозиции.Найти(Тек.Номенклатура);
			//	Если Най <> Неопределено Тогда
			//		Най.Количество = Тек.Количество;
			//		Най.Сумма = Най.Количество * Най.Цена;
			//	Иначе
			//		Нов = ОбД.ПодарочныеПозиции.Добавить();
			//		Нов.Номенклатура = Тек.Номенклатура;
			//		Нов.ЕдиницаИзмерения = Нов.Номенклатура.ЕдиницаХраненияОстатков;
			//		Нов.Коэффициент = 1;
			//		Нов.Качество = Справочники.Качество.Новый;
			//		Нов.Количество = Тек.НеобходимоеКоличество;
			//		Если ЗначениеЗаполнено(Тек.Номенклатура) Тогда
			//			Нов.СтавкаНДС = Тек.Номенклатура.СтавкаНДС;
			//		КонецеСли;	
			//		Нов.Сумма = Тек.Сумма;
			//		Нов.Сумма = Тек.Сумма;
			//		Нов.Цена = Тек.Цена;
			//		ОбработкаТабличныхЧастей.РассчитатьСуммуНДСТабЧасти(Нов, ОбД);
			//	КонецеСли;
			//КонецеСли;
			
			
			//Струк = Новый Структура;
			//Струк.Вставить("Номенклатура", тек.Номенклатура);
			//
			//Най = ОбД2.Товары.НайтиСтроки(Струк);
			//Если Най.Количество() <> 0 Тогда
			//	Най_ = Най[0];
			//	Если Най_ <> Неопределено Тогда
			//		Най_.Количество = Тек.НеобходимоеКоличество;
			//	Иначе
			//		Нов = ОбД2.Товары.Добавить();
			//		Нов.Номенклатура = Тек.Номенклатура;
			//		Нов.ЕдиницаИзмерения = Нов.Номенклатура.ЕдиницаХраненияОстатков;
			//		Нов.Коэффициент = 1;
			//		Нов.Качество = Справочники.Качество.Новый;
			//		Нов.Количество = Тек.НеобходимоеКоличество;
			//	КонецеСли;
			//Иначе
			//	Нов = ОбД2.Товары.Добавить();
			//	Нов.Номенклатура = Тек.Номенклатура;
			//	Нов.ЕдиницаИзмерения = Нов.Номенклатура.ЕдиницаХраненияОстатков;
			//	Нов.Коэффициент = 1;
			//	Нов.Качество = Справочники.Качество.Новый;
			//	Нов.Количество = Тек.НеобходимоеКоличество;
			//КонецЕСли;
			
			
			
			//Если ЗначениеЗаполнено(д3) Тогда
			//	Струк = Новый Структура;
			//	Струк.Вставить("Товар", тек.Номенклатура);
			//	Струк.Вставить("Стоимость", тек.Сумма);
			//	
			//	Най = ОбД3.Спецификация.НайтиСтроки(Струк);
			//	Если Най.Количество() <> 0 Тогда
			//		Най_ = Най[0];
			//		Если Най_ <> Неопределено Тогда
			//			Най_.Количество = Тек.НеобходимоеКоличество;						
			//		КонецеСли;
			//	Иначе
			//		Нов = ОбД3.Спецификация.Добавить();
			//		Нов.Товар = Тек.Номенклатура;
			//		Нов.Стоимость = Тек.Сумма;
			//		Нов.Количество = Тек.НеобходимоеКоличество;
			//	КонецеСли;
			//КонецеСли;
		КонецЦикла;
		//ОбД.Записать(РежимЗаписиДокумента.Запись);
		//Если ОбД.Проведен Тогда
		//	ОбД.Записать(РежимЗаписиДокумента.Проведение);
		//конецеСли;
		//
		//lem.ОтразитьСоставЗаказаВИстории(Ссылка, ОбД.Ссылка);
		//
		//ОбД2.Записать(РежимЗаписиДокумента.Запись);
		//Если ОбД2.Проведен Тогда
		//	ОбД2.Записать(РежимЗаписиДокумента.Проведение);
		//конецеСли;
		//Если ЗначениеЗаполнено(д3) Тогда
		//ОбД3.Записать(РежимЗаписиДокумента.Запись);
		//Если ОбД3.Проведен Тогда
		//	ОбД3.Записать(РежимЗаписиДокумента.Проведение);
		//конецеСли;	
		//КонецеСли;
		
	КонецеСли;
КонецПроцедуры	

