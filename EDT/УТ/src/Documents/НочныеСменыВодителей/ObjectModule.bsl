
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	// Вставить содержимое обработчика.
	Движения.СводПоЗарплате.Очистить();
	Движения.СводПоЗарплате.Записывать = Истина;
	
	Для Каждого Тек Из Водители Цикл
		Нов = Движения.СводПоЗарплате.Добавить();
		Нов.ТипРасчетаЗарплаты = Перечисления.ТипыРасчетаЗарплаты.НочныеСмены;
		Нов.Период = Дата;
		Нов.ПоказательКоличества = Тек.ОтработаноСмен;
		Нов.Сумма = Тариф * Тек.КоличествоСтавок*Тек.ОтработаноСмен;
		Нов.УчастникЭкипажа = Перечисления.УчастникЭкипажа.Водитель;
		Нов.ФизЛицо = Тек.Водитель;
        //+++++Серегин М.В. 29.02.2016 12:15:46 
        Нов.ТипНУ = Перечисления.ТипыНУЭкипажей.РасчетЗП;
        //-----Серегин М.В. 29.02.2016 12:15:47 
	КонецЦикла;	
	
	// Миго-групп ШушлебинДА {
	//Движения.мгЗарплатаНачисления.Записывать = Истина;
	//Движения.мгЗарплатаНачисления.Очистить();
	//Для каждого ТекСтрокаВодители Из Водители Цикл
	//	Движение = Движения.мгЗарплатаНачисления.Добавить();
	//	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	//	Движение.Период = ПериодРегистрации;
	//	Движение.Организация = ТекСтрокаВодители.мгОрганизация;
	//	Движение.Терминал = мгТерминал;
	//	Движение.ВидНачисления = ПредопределенноеЗначение("Справочник.мгНачисленияУдержания.НочнойВодитель");
	//	Движение.Сотрудник = ТекСтрокаВодители.Водитель;
	//	Движение.Тариф = Тариф;
	//КонецЦикла;
	//} ШушлебинДА
	
	
	// регистр мгЗарплатаНачисления Приход
	Движения.мгЗарплатаНачисления.Записать();
	Движения.мгЗарплатаНачисления.Записывать = Истина;
	Движения.мгЗарплатаНачисления.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НочныеСменыВодителейВодители.НомерСтроки КАК НомерСтроки,
		|	НочныеСменыВодителейВодители.Водитель КАК Водитель,
		|	НочныеСменыВодителейВодители.мгОрганизация КАК мгОрганизация,
		|	НочныеСменыВодителейВодители.ДатаСмены КАК ДатаСмены
		|ПОМЕСТИТЬ вт_мгПодработкаНаСкладе
		|ИЗ
		|	Документ.НочныеСменыВодителей.Водители КАК НочныеСменыВодителейВодители
		|ГДЕ
		|	НочныеСменыВодителейВодители.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	мгЗарплатаНачисления.Регистратор КАК Регистратор,
		|	вт_мгПодработкаНаСкладе.НомерСтроки КАК НомерСтроки,
		|	вт_мгПодработкаНаСкладе.Водитель КАК ФИОСотрудника,
		|	вт_мгПодработкаНаСкладе.мгОрганизация КАК мгОрганизация,
		|	вт_мгПодработкаНаСкладе.ДатаСмены КАК ДатаПодработки
		|ИЗ
		|	вт_мгПодработкаНаСкладе КАК вт_мгПодработкаНаСкладе
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.мгЗарплатаНачисления КАК мгЗарплатаНачисления
		|		ПО (ЗНАЧЕНИЕ(Справочник.мгНачисленияУдержания.НочнойВодитель) = мгЗарплатаНачисления.ВидНачисления)
		|			И вт_мгПодработкаНаСкладе.мгОрганизация = мгЗарплатаНачисления.Организация
		|			И вт_мгПодработкаНаСкладе.Водитель = мгЗарплатаНачисления.Сотрудник
		|			И вт_мгПодработкаНаСкладе.ДатаСмены = мгЗарплатаНачисления.Период";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса 		= Запрос.Выполнить();	
	ВыборкаДетальныеЗаписи 	= РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Регистратор) Тогда
			
			Отказ		= Истина;
			Сообщение 	= Новый СообщениеПользователю();
		    Сообщение.Текст = "Номер строки " + ВыборкаДетальныеЗаписи.НомерСтроки +  ". Сотрудник " + """" + ВыборкаДетальныеЗаписи.ФИОСотрудника + """" + " уже зарегистрирован на " + Формат(ВыборкаДетальныеЗаписи.ДатаПодработки,"ДФ=dd.MM.yyyy") + " документом:" + ВыборкаДетальныеЗаписи.Регистратор ;
		    Сообщение.Поле = "Водители["+(ВыборкаДетальныеЗаписи.НомерСтроки-1)+"].ДатаСмены";
		    Сообщение.УстановитьДанные(ЭтотОбъект);
		    Сообщение.Сообщить();
	
		КонецЕсли;
		
		Если Отказ Тогда
			Возврат;	
		КонецЕсли; 
		
		Движение = Движения.мгЗарплатаНачисления.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = ВыборкаДетальныеЗаписи.ДатаПодработки;
		Движение.Организация = ВыборкаДетальныеЗаписи.мгОрганизация;
		Движение.Терминал = мгТерминал;
		Движение.ВидНачисления = ПредопределенноеЗначение("Справочник.мгНачисленияУдержания.НочнойВодитель");
		Движение.Сотрудник = ВыборкаДетальныеЗаписи.ФИОСотрудника;
		Движение.Тариф = Тариф;
		
	КонецЦикла;
КонецПроцедуры

