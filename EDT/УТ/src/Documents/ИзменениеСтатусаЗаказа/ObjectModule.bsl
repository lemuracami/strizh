
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	// Вставить содержимое обработчика.
	Отказ = Не Проведение1С();
	ИзменениеТипаОплаты();
КонецПроцедуры

Функция Проведение1С()
	Попытка
		ПодключениеКМагазину = Евген.СоздатьПодключениеКИнтернетМагазину(); 
	Исключение
		НормальныйХодВыполнения = Ложь;
		Возврат Ложь;
	КонецПопытки;
	
	Если СтатусЗаказа = справочники.СтатусЗаказаИнтернетМагазина.ЗаказОтклонен Тогда
		Р = Заказ.ПолучитьОбъект();
		Если Р.Проведен Тогда
			Р.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		КонецеСли;
		
		Р.СтатусИнтернетМагазина = 4;
		Р.ПометкаУдаления = Истина;
		Р.Записать(РежимЗаписиДокумента.Запись);
		
		
		П = Документы.ПеремещениеТоваров.НайтиПоНомеру(Заказ.Номер);
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Истина;
			П.Записать(РежимЗаписиДокумента.Запись);
		КонецЕсли;
		
		П = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Истина;
			П.Записать(РежимЗаписиДокумента.Запись);
		КонецЕсли;
		
		В = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		Если Не В.Пустая() Тогда
			В = В.ПолучитьОбъект();
			
			Если В.Проведен Тогда
				В.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			В.ПометкаУдаления = Истина;
			В.Записать(РежимЗаписиДокумента.Запись);
		КонецЕСли;
		УстановитьСтатусСтрижаВАдминке(СокрЛП(Р.Номер), "4", ПодключениеКМагазину);
	ИначеЕсли СтатусЗаказа = справочники.СтатусЗаказаИнтернетМагазина.ЗаказВОбработке Тогда
		Р = Заказ.ПолучитьОбъект();
		Если Р.Проведен Тогда
			Р.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		КонецеСли;
		
		Р.СтатусИнтернетМагазина = 2;
		Р.ПометкаУдаления = Ложь;
		Р.Записать(РежимЗаписиДокумента.Запись);
		
		
		П = Документы.ПеремещениеТоваров.НайтиПоНомеру(Заказ.Номер);
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Ложь;
			П.Записать(РежимЗаписиДокумента.Запись);
		КонецеСли;
		
		П = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Ложь;
			П.Записать(РежимЗаписиДокумента.Запись);
		КонецеСли;
		
		В = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		Если Не В.Пустая() Тогда
			В = В.ПолучитьОбъект();
			Если В.Проведен Тогда
				В.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			В.ПометкаУдаления = Ложь;
			В.Записать(РежимЗаписиДокумента.Запись);
		КонецеСли;
		УстановитьСтатусСтрижаВАдминке(СокрЛП(Р.Номер), "2", ПодключениеКМагазину);
	ИначеЕсли СтатусЗаказа = справочники.СтатусЗаказаИнтернетМагазина.НовыйЗаказ Тогда
		Р = Заказ.ПолучитьОбъект();
		Если Р.Проведен Тогда
			Р.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		КонецеСли;
		
		Р.СтатусИнтернетМагазина = 1;
		Р.ПометкаУдаления = Ложь;
		Р.Записать(РежимЗаписиДокумента.Запись);
		
		
		П = Документы.ПеремещениеТоваров.НайтиПоНомеру(Заказ.Номер);
		П = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Ложь;
			П.Записать(РежимЗаписиДокумента.Запись);		
		КонецеСли;
		
		П = Документы.ПоступлениеТоваровУслуг.НайтиПоНомеру(Заказ.Номер);
		Если Не П.Пустая() Тогда
			П = П.ПолучитьОбъект();
			Если П.Проведен Тогда
				П.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			П.ПометкаУдаления = Ложь;
			П.Записать(РежимЗаписиДокумента.Запись);		
		КонецеСли;
		
		В = Документы.ВозвратТоваровОтПокупателя.НайтиПоНомеру(Заказ.Номер);
		Если Не В.Пустая() Тогда
			В = В.ПолучитьОбъект();
			Если В.Проведен Тогда
				В.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			КонецеСли;
			
			В.ПометкаУдаления = Ложь;
			В.Записать(РежимЗаписиДокумента.Запись);		
		КонецеСли;
		УстановитьСтатусСтрижаВАдминке(СокрЛП(Р.Номер), "1", ПодключениеКМагазину);
	КонецеСли;	
	
	Если Перенос Тогда
		Д = БизнесПроцессы.новаМестнаяДоставка.НайтиПоНомеру(заказ.Номер);
		Если Не Д.Пустая() Тогда
			Д.Дата = ДатаПереноса;
			
			ЧН = Час(Д.ВремяОтправленияС);
			ЧК = Час(Д.ВремяОтправленияПо);
			
			МН = Минута(Д.ВремяОтправленияС);
			МК = Минута(Д.ВремяОтправленияПо);
			
			ЧН_ = Час(Д.ВремяПрибытияС);
			ЧК_ = Час(Д.ВремяПрибытияПо);
			
			МН_ = Минута(Д.ВремяПрибытияС);
			МК_ = Минута(Д.ВремяПрибытияПо);
			
			
			Д.ВремяОтправленияС = Дата(Формат(Год(ДатаПереноса), "ЧГ=") + Формат(Месяц(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(День(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(ЧН, "ЧЦ=2; ЧВН=; ЧГ=") + Формат(МН, "ЧЦ=2; ЧВН=; ЧГ=") + "00");
			Д.ВремяОтправленияПо = Дата(Формат(Год(ДатаПереноса), "ЧГ=") + Формат(Месяц(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(День(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(ЧК, "ЧЦ=2; ЧВН=; ЧГ=") + Формат(МК, "ЧЦ=2; ЧВН=; ЧГ=") + "00");
			
			Д.ВремяПрибытияС = Дата(Формат(Год(ДатаПереноса), "ЧГ=") + Формат(Месяц(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(День(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(ЧН_, "ЧЦ=2; ЧВН=; ЧГ=") + Формат(МН_, "ЧЦ=2; ЧВН=; ЧГ=") + "00");
			Д.ВремяПрибытияПо = Дата(Формат(Год(ДатаПереноса), "ЧГ=") + Формат(Месяц(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(День(ДатаПереноса), "ЧЦ=2; ЧВН=; ЧГ=") + Формат(ЧК_, "ЧЦ=2; ЧВН=; ЧГ=") + Формат(МК_, "ЧЦ=2; ЧВН=; ЧГ=") + "00");
			
			Д.Записать();
		КонецеСли;
		
		Р.Дата = ДатаПереноса;
		
		УстановитьДатуВАдминке(СокрЛП(Р.Номер), ДатаПереноса, ПодключениеКМагазину);
		УстановитьСтатусСтрижаВАдминке(СокрЛП(Р.Номер), "2", ПодключениеКМагазину);
	КонецеСли;	
	Возврат Истина;
КонецФункции	



Процедура УстановитьДатуВАдминке(НомерЗ, ДатаЗ, Подкл)
	// ++Задача № 3381	
	//Ткст = "
	//|UPDATE _order
	//|SET DeliveryDate = '" + Евген.ДатаВSQL(ДатаЗ, Ложь) + "'
	//| WHERE orderId = " + Формат(НомерЗ, "ЧГ=") + "
	//|EXEC mp_saveOrderHistory " + Формат(НомерЗ, "ЧГ=");
	//Евген.ЗапросКИнтернетМагазину(Ткст, Подкл);
	
	ПараметрыЗаказа = Новый Структура("OrderId, DeliveryDate, Who",
	Число(НомерЗ), ДатаЗ, СокрЛП(ПараметрыСеанса.ТекущийПользователь));
	
	ПараметрыЗапроса = новый Массив;
	ПараметрыЗапроса.Добавить(ПараметрыЗаказа);
	
	Если ПараметрыСеанса.ЭтоТестоваяСреда Тогда
		ФайлДляКонтроля = "D:\tmp\SetOrdersDeliveryDate_" + СокрЛП(НомерЗ) + ".json";
		ТолькоСохранитьФайл = Ложь;
	Иначе
		ФайлДляКонтроля = Неопределено;
		ТолькоСохранитьФайл = Ложь;
	КонецЕсли;

	РезультатОтправки = ИнтеграцияСАдминкойWEBСервис.ВыполнитьЗапросКАдминке(
	Перечисления.ВидыЗапросовWEBСервис.SetOrdersDeliveryDateResult, 
	ПараметрыЗапроса, 
	ФайлДляКонтроля, 
	ТолькоСохранитьФайл);
	// --Задача № 3381
	
    ////Серегин М.В. 30.07.2015 17:43:20 старый код
    //Ткст = "
    //|UPDATE _order
    //|SET carid = 0
    //| WHERE orderId = " + Формат(НомерЗ, "ЧГ=") + "
    //|EXEC mp_saveOrderHistory " + Формат(НомерЗ, "ЧГ=");
    //Евген.ЗапросКИнтернетМагазину(Ткст, Подкл);
    ////Серегин М.В. 30.07.2015 17:43:25 новый
    Ткст = "
	|EXEC p1c_removeCarriageFromOrder " + Формат(НомерЗ, "ЧГ=") + "
	|EXEC mp_saveOrderHistory " + Формат(НомерЗ, "ЧГ=");
	Евген.ЗапросКИнтернетМагазину(Ткст, Подкл);
    //Серегин М.В. 30.07.2015 17:43:27 
	
КонецПроцедуры	


Процедура УстановитьСтатусСтрижаВАдминке(НомерЗ, Статус, Подкл)
	Ткст = "
	|UPDATE _order
	|SET Status = " + Статус + "
	| WHERE orderId = " + Формат(НомерЗ, "ЧГ=") + "
	|EXEC mp_saveOrderHistory " + Формат(НомерЗ, "ЧГ=");
	Евген.ЗапросКИнтернетМагазину(Ткст, Подкл);
КонецПроцедуры	


Процедура ОбработкаУдаленияПроведения(Отказ)
	Отказ = Истина;
КонецПроцедуры


Процедура ИзменениеТипаОплаты()
	если Заказ.СтатусИнтернетМагазина = 2 И Не ТипОплатыДо.Пустая() И Не ТипОплатыПосле.Пустая() И ТипОплатыПосле <> ТипОплатыДо Тогда
		Подкл = Евген.СоздатьПодключениеКИнтернетМагазину();
		
		ТекстЗапроса = "EXEC import_setOrderPayType " + СокрЛП(Заказ.Номер) + ", " + Формат(ТипОплатыПосле.Код, "ЧГ=");
		Евген.ЗапросКИнтернетМагазину(ТекстЗапроса, Подкл);
		
		//Евген.ЗапросКИнтернетМагазину("UPDATE _order set pay_type = " + Формат(ТипОплатыПосле.Код, "ЧГ=") + " where orderid = " + СокрЛП(Заказ.Номер), Подкл);
		Д = Заказ.ПолучитьОбъект();
		Д.ТипОплаты = ТипОплатыПосле.Код;
		Д.Записать(РежимЗаписиДокумента.Запись);
	КонецеСли;	
Конецпроцедуры	

