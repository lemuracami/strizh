Функция ПолучитьТабличныйДокументВедомостиПоТранспорту(МассивРейсов) Экспорт
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ОтображатьСетку = Ложь;
	ТабличныйДокумент.ОтображатьЗаголовки = Ложь;
	ТабличныйДокумент.ПолеСлева = 3;
	ТабличныйДокумент.ПолеСправа = 3;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Макет = Документы.Рейс.ПолучитьМакет("ВедомостьПоТранспорту");
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьРейс  = Макет.ПолучитьОбласть("ОбластьРейс");
	ОбластьВидДанных = Макет.ПолучитьОбласть("ОбластьВидДанных");
	ОбластьПартнер   = Макет.ПолучитьОбласть("ОбластьПартнер");
	ОбластьЗаказ     = Макет.ПолучитьОбласть("ОбластьЗаказ");
	ОбластьЗаказЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьЗаказЗачеркнутый"); 
	ОбластьШКТовара = Макет.ПолучитьОбласть("ОбластьШКТовара");
	ОбластьШКЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьШКЗачеркнутый");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьЗаказыРейса = Макет.ПолучитьОбласть("ЗаказыРейса");
	
	
	МассивПартнеров = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РейсЗаказы.Заказ.ВладелецТовара КАК ЗаказВладелецТовара
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|	И РейсЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг";
	Запрос.УстановитьПараметр("Рейсы",МассивРейсов);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		МассивПартнеров.Добавить(Выборка.ЗаказВладелецТовара);
	КонецЦикла;	
	
	Если МассивПартнеров.Количество() = 0 Тогда
		Возврат ТабличныйДокумент;
	КонецЕсли;	
	
	ЗапросПараметровУчетаЗаказов = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ПараметрыКонтрагентовСрезПоследних.Контрагент КАК ВладелецТовара,
	|	ПараметрыКонтрагентовСрезПоследних.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует
	|ИЗ
	|	РегистрСведений.ПараметрыКонтрагентов.СрезПоследних(, Контрагент В (&Контрагенты)) КАК ПараметрыКонтрагентовСрезПоследних";
	
	Запрос.УстановитьПараметр("Контрагенты",МассивПартнеров);
	ТаблицаПараметровУчета = Запрос.Выполнить().Выгрузить();
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТЗПараметрыУчетаЗаказов.ВладелецТовара КАК ВладелецТовара,
	|	ТЗПараметрыУчетаЗаказов.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	ТЗПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует
	|ПОМЕСТИТЬ втПараметрыУчетаЗаказов
	|ИЗ
	|	&ТЗПараметрыУчетаЗаказов КАК ТЗПараметрыУчетаЗаказов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РейсЗаказы.Заказ КАК Заказ,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка.Дата) КАК Дата
	|ПОМЕСТИТЬ втМаксимальныеДатыЗагрузкиСТСД
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И (КОНЕЦПЕРИОДА(РейсЗаказы.Ссылка.ДатаРейса, ДЕНЬ) >= ЗагрузкаСТСДШтрихкоды.Ссылка.Дата)
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|
	|СГРУППИРОВАТЬ ПО
	|	РейсЗаказы.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаксимальныеДатыЗагрузкиСТСД.Заказ КАК Заказ,
	|	ЗагрузкаСТСДШтрихкоды.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ втПоследниеЗагрузкиСТСД
	|ИЗ
	|	втМаксимальныеДатыЗагрузкиСТСД КАК втМаксимальныеДатыЗагрузкиСТСД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО втМаксимальныеДатыЗагрузкиСТСД.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И втМаксимальныеДатыЗагрузкиСТСД.Дата = ЗагрузкаСТСДШтрихкоды.Ссылка.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоТоварамМПТовары.Ссылка.Дата) КАК ДатаУЗ,
	|	ОтчетПоТоварамМПТовары.Заказ КАК Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование КАК ТранспортУЗ,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование КАК УЗ
	|ПОМЕСТИТЬ втДокументыУдаленногоЗакрытия
	|ИЗ
	|	Документ.ОтчетПоТоварамМП.Товары КАК ОтчетПоТоварамМПТовары
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоТоварамМПТовары.Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоДСМПДС.Ссылка.Дата),
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование
	|ИЗ
	|	Документ.ОтчетПоДСМП.ДС КАК ОтчетПоДСМПДС
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокументыУдаленногоЗакрытия.Заказ КАК Заказ,
	|	МАКСИМУМ(втДокументыУдаленногоЗакрытия.ДатаУЗ) КАК ДатаУЗ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ КАК УЗ
	|ПОМЕСТИТЬ втДанныеУдаленногоЗакрытия
	|ИЗ
	|	втДокументыУдаленногоЗакрытия КАК втДокументыУдаленногоЗакрытия
	|
	|СГРУППИРОВАТЬ ПО
	|	втДокументыУдаленногоЗакрытия.Заказ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РейсЗаказы.Ссылка КАК Рейс,
	|	РейсЗаказы.Заказ КАК Заказ,
	|	РейсЗаказы.УдаленИзРейса КАК НеМаршрутизирован,
	|	ЛОЖЬ КАК ЗаказНеВРейсе,
	|	РейсЗаказы.Заказ.ВладелецТовара КАК ВладелецТовара,
	|	ЕСТЬNULL(втПараметрыУчетаЗаказов.УчетЗаказовПоМестам, ЛОЖЬ) КАК УчетЗаказовПоМестам,
	|	ЕСТЬNULL(втПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует, ЛОЖЬ) КАК СкладскаяОбработкаОтсутствует
	|ПОМЕСТИТЬ втМаршрутизацияЗаказов
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПараметрыУчетаЗаказов КАК втПараметрыУчетаЗаказов
	|		ПО РейсЗаказы.Заказ.ВладелецТовара = втПараметрыУчетаЗаказов.ВладелецТовара
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
	|		ПО РейсЗаказы.Заказ = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ПО РейсЗаказы.Заказ = РеализацияТоваровУслугТовары.Ссылка
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|	И РейсЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	|	И НЕ РейсЗаказы.Заказ.ПометкаУдаления
	|	И НЕ ЕСТЬNULL(втПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|
	|СГРУППИРОВАТЬ ПО
	|	РейсЗаказы.Ссылка,
	|	РейсЗаказы.Заказ,
	|	РейсЗаказы.УдаленИзРейса,
	|	РейсЗаказы.Заказ.ВладелецТовара,
	|	ЕСТЬNULL(втПараметрыУчетаЗаказов.УчетЗаказовПоМестам, ЛОЖЬ),
	|	ЕСТЬNULL(втПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|
	|ИМЕЮЩИЕ
	|	(КОЛИЧЕСТВО(РАЗЛИЧНЫЕ РеализацияТоваровУслугПодарочныеПозиции.Номенклатура) > 0
	|		ИЛИ КОЛИЧЕСТВО(РАЗЛИЧНЫЕ РеализацияТоваровУслугТовары.Номенклатура) > 0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс,
	|	ПогрузкаВАвтоЗаказы.Заказ,
	|	РейсЗаказы.Заказ ЕСТЬ NULL,
	|	ИСТИНА,
	|	ПогрузкаВАвтоЗаказы.Заказ.ВладелецТовара,
	|	втПараметрыУчетаЗаказов.УчетЗаказовПоМестам,
	|	ЕСТЬNULL(втПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	|		ПО ПогрузкаВАвтоЗаказы.Ссылка.Рейс = РейсЗаказы.Ссылка
	|			И ПогрузкаВАвтоЗаказы.Заказ = РейсЗаказы.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПараметрыУчетаЗаказов КАК втПараметрыУчетаЗаказов
	|		ПО ПогрузкаВАвтоЗаказы.Заказ.ВладелецТовара = втПараметрыУчетаЗаказов.ВладелецТовара
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.ПогрузкаВАвто)
	|	И НЕ ЕСТЬNULL(втПараметрыУчетаЗаказов.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаршрутизацияЗаказов.Рейс КАК Рейс,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втМаршрутизацияЗаказов.Заказ) КАК Заказ,
	|	СУММА(втМаршрутизацияЗаказов.Заказ.СуммаДокумента) КАК ЗаказСуммаДокумента
	|ПОМЕСТИТЬ втИтогиПоРейсу
	|ИЗ
	|	втМаршрутизацияЗаказов КАК втМаршрутизацияЗаказов
	|ГДЕ
	|	НЕ втМаршрутизацияЗаказов.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втМаршрутизацияЗаказов.Рейс
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаршрутизацияЗаказов.ВладелецТовара КАК ВладелецТовара,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втМаршрутизацияЗаказов.Заказ) КАК Заказ
	|ПОМЕСТИТЬ втИтогиПоПартнерам
	|ИЗ
	|	втМаршрутизацияЗаказов КАК втМаршрутизацияЗаказов
	|ГДЕ
	|	НЕ втМаршрутизацияЗаказов.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втМаршрутизацияЗаказов.ВладелецТовара
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаршрутизацияЗаказов.Рейс КАК Рейс,
	|	втМаршрутизацияЗаказов.Заказ КАК Заказ,
	|	втМаршрутизацияЗаказов.ЗаказНеВРейсе КАК ЗаказНеВРейсе,
	|	втМаршрутизацияЗаказов.ВладелецТовара КАК ВладелецТовара,
	|	МестаПоЗаказам.Ссылка КАК Место,
	|	втМаршрутизацияЗаказов.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втМаршрутизацияЗаказов.НеМаршрутизирован КАК НеМаршрутизирован
	|ПОМЕСТИТЬ втМестаКПогрузке
	|ИЗ
	|	втМаршрутизацияЗаказов КАК втМаршрутизацияЗаказов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаПоЗаказам КАК МестаПоЗаказам
	|		ПО втМаршрутизацияЗаказов.Заказ = МестаПоЗаказам.Заказ
	|ГДЕ
	|	втМаршрутизацияЗаказов.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаршрутизацияЗаказов.Рейс КАК Рейс,
	|	втМаршрутизацияЗаказов.Заказ КАК Заказ,
	|	втМаршрутизацияЗаказов.ЗаказНеВРейсе КАК ЗаказНеВРейсе,
	|	втМаршрутизацияЗаказов.ВладелецТовара КАК ВладелецТовара,
	|	втМаршрутизацияЗаказов.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втМаршрутизацияЗаказов.НеМаршрутизирован КАК НеМаршрутизирован
	|ПОМЕСТИТЬ втЗаказыБезУчетаМест
	|ИЗ
	|	втМаршрутизацияЗаказов КАК втМаршрутизацияЗаказов
	|ГДЕ
	|	НЕ втМаршрутизацияЗаказов.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоМестаПоЗаказам.Заказ КАК Заказ,
	|	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа КАК МестоЗаказа,
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс КАК Рейс
	|ПОМЕСТИТЬ втЗагруженныеМеста
	|ИЗ
	|	Документ.ПогрузкаВАвто.МестаПоЗаказам КАК ПогрузкаВАвтоМестаПоЗаказам
	|ГДЕ
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоМестаПоЗаказам.КоличествоСканирований > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	|	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест,
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс
	|ПОМЕСТИТЬ втКоличествоПогруженныхМестЗаказов
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМестаКПогрузке.Рейс КАК Рейс,
	|	втМестаКПогрузке.Заказ КАК Заказ,
	|	втМестаКПогрузке.ЗаказНеВРейсе КАК ЗаказНеВРейсе,
	|	втМестаКПогрузке.ВладелецТовара КАК ВладелецТовара,
	|	втМестаКПогрузке.Место КАК Место,
	|	втМестаКПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втМестаКПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗагруженныеМеста.МестоЗаказа КАК ПогруженноеМесто
	|ПОМЕСТИТЬ втДанныеПоЗагрузкеМест
	|ИЗ
	|	втМестаКПогрузке КАК втМестаКПогрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втЗагруженныеМеста КАК втЗагруженныеМеста
	|		ПО втМестаКПогрузке.Рейс = втЗагруженныеМеста.Рейс
	|			И втМестаКПогрузке.Заказ = втЗагруженныеМеста.Заказ
	|			И втМестаКПогрузке.Место = втЗагруженныеМеста.МестоЗаказа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДанныеПоЗагрузкеМест.Рейс КАК Рейс,
	|	втДанныеПоЗагрузкеМест.Заказ КАК Заказ,
	|	втДанныеПоЗагрузкеМест.ЗаказНеВРейсе КАК ЗаказНеВРейсе,
	|	втДанныеПоЗагрузкеМест.ВладелецТовара КАК ВладелецТовара,
	|	втДанныеПоЗагрузкеМест.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втДанныеПоЗагрузкеМест.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втДанныеПоЗагрузкеМест.ПогруженноеМесто КАК ПогруженноеМесто,
	|	ВЫБОР
	|		КОГДА втДанныеПоЗагрузкеМест.ПогруженноеМесто ЕСТЬ NULL
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК КоличествоПогруженныхМестЗаказСУчетомМест,
	|	0 КАК КоличествоПогруженныхМестЗаказБезУчетаМест,
	|	втДанныеПоЗагрузкеМест.Место КАК Место
	|ПОМЕСТИТЬ втОбщиеДанныеПоЗагрузке
	|ИЗ
	|	втДанныеПоЗагрузкеМест КАК втДанныеПоЗагрузкеМест
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	втЗаказыБезУчетаМест.Рейс,
	|	втЗаказыБезУчетаМест.Заказ,
	|	втЗаказыБезУчетаМест.ЗаказНеВРейсе,
	|	втЗаказыБезУчетаМест.ВладелецТовара,
	|	втЗаказыБезУчетаМест.УчетЗаказовПоМестам,
	|	втЗаказыБезУчетаМест.НеМаршрутизирован,
	|	0,
	|	0,
	|	ЕСТЬNULL(втКоличествоПогруженныхМестЗаказов.КоличествоМест, 0),
	|	NULL
	|ИЗ
	|	втЗаказыБезУчетаМест КАК втЗаказыБезУчетаМест
	|		ЛЕВОЕ СОЕДИНЕНИЕ втКоличествоПогруженныхМестЗаказов КАК втКоличествоПогруженныхМестЗаказов
	|		ПО втЗаказыБезУчетаМест.Рейс = втКоличествоПогруженныхМестЗаказов.Рейс
	|			И втЗаказыБезУчетаМест.Заказ = втКоличествоПогруженныхМестЗаказов.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	втОбщиеДанныеПоЗагрузке.Рейс КАК Рейс,
	|	втОбщиеДанныеПоЗагрузке.Заказ КАК Заказ,
	|	втОбщиеДанныеПоЗагрузке.ЗаказНеВРейсе КАК ЗаказНеВРейсе,
	|	втОбщиеДанныеПоЗагрузке.ВладелецТовара КАК ВладелецТовара,
	|	втОбщиеДанныеПоЗагрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втОбщиеДанныеПоЗагрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втИтогиПоРейсу.Заказ КАК КоличествоЗаказовПоРейсу,
	|	втИтогиПоРейсу.ЗаказСуммаДокумента КАК СуммаЗаказовПоРейсу,
	|	втИтогиПоПартнерам.Заказ КАК КоличествоЗаказовПоПартнеру,
	|	втОбщиеДанныеПоЗагрузке.ВладелецТовара.Наименование КАК НаименованиеПартнера,
	|	ВЫРАЗИТЬ(втОбщиеДанныеПоЗагрузке.Заказ КАК Документ.РеализацияТоваровУслуг).Номер КАК НомерЗаказаСтриж,
	|	ВЫРАЗИТЬ(втОбщиеДанныеПоЗагрузке.Заказ КАК Документ.РеализацияТоваровУслуг).СуммаДокумента КАК СтоимостьЗаказа,
	|	ВЫРАЗИТЬ(втОбщиеДанныеПоЗагрузке.Заказ КАК Документ.РеализацияТоваровУслуг).КоличествоМест КАК КоличествоМест,
	|	втОбщиеДанныеПоЗагрузке.КоличествоПогруженныхМестЗаказСУчетомМест КАК КоличествоПогруженныхМестЗаказСУчетомМест,
	|	втОбщиеДанныеПоЗагрузке.КоличествоПогруженныхМестЗаказБезУчетаМест КАК КоличествоПогруженныхМестЗаказБезУчетаМест,
	|	втОбщиеДанныеПоЗагрузке.Рейс.ДатаРейса КАК ДатаРейса,
	|	втОбщиеДанныеПоЗагрузке.Рейс.НомерПалетты КАК НомерПалетты,
	|	ПривязкаМашинКРейсамСрезПоследних.Транспорт.Наименование КАК Транспорт,
	|	ПривязкаМашинКРейсамСрезПоследних.Водитель.Наименование КАК Водитель,
	|	ПривязкаМашинКРейсамСрезПоследних.Экспедитор.Наименование КАК Экспедитор,
	|	втДанныеУдаленногоЗакрытия.ДатаУЗ КАК ДатаУЗ,
	|	втДанныеУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДанныеУдаленногоЗакрытия.УЗ КАК УЗ,
	|	втОбщиеДанныеПоЗагрузке.Рейс.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	ВЫРАЗИТЬ(втОбщиеДанныеПоЗагрузке.Заказ КАК Документ.РеализацияТоваровУслуг).НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втПоследниеЗагрузкиСТСД.Ссылка.Дата КАК ДатаНаТСД,
	|	втПоследниеЗагрузкиСТСД.Ссылка.СерверТСД.Наименование КАК ИДТерминалаТСД,
	|	втОбщиеДанныеПоЗагрузке.Место.Штрихкод КАК МестоШтрихкод,
	|	втОбщиеДанныеПоЗагрузке.ПогруженноеМесто ЕСТЬ NULL КАК МестоНеПогружено,
	|	втОбщиеДанныеПоЗагрузке.Место КАК Место
	|ИЗ
	|	втОбщиеДанныеПоЗагрузке КАК втОбщиеДанныеПоЗагрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоРейсу КАК втИтогиПоРейсу
	|		ПО втОбщиеДанныеПоЗагрузке.Рейс = втИтогиПоРейсу.Рейс
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоПартнерам КАК втИтогиПоПартнерам
	|		ПО втОбщиеДанныеПоЗагрузке.ВладелецТовара = втИтогиПоПартнерам.ВладелецТовара
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних КАК ПривязкаМашинКРейсамСрезПоследних
	|		ПО втОбщиеДанныеПоЗагрузке.Рейс = ПривязкаМашинКРейсамСрезПоследних.Рейс
	|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеУдаленногоЗакрытия КАК втДанныеУдаленногоЗакрытия
	|		ПО втОбщиеДанныеПоЗагрузке.Заказ = втДанныеУдаленногоЗакрытия.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЗагрузкиСТСД КАК втПоследниеЗагрузкиСТСД
	|		ПО втОбщиеДанныеПоЗагрузке.Заказ = втПоследниеЗагрузкиСТСД.Заказ
	|
	|УПОРЯДОЧИТЬ ПО
	|	НеМаршрутизирован УБЫВ,
	|	НаименованиеПартнера,
	|	НомерЗаказаСтриж
	|ИТОГИ
	|	МАКСИМУМ(ЗаказНеВРейсе),
	|	МАКСИМУМ(УчетЗаказовПоМестам),
	|	МАКСИМУМ(КоличествоЗаказовПоРейсу),
	|	МАКСИМУМ(СуммаЗаказовПоРейсу),
	|	МАКСИМУМ(КоличествоЗаказовПоПартнеру),
	|	МАКСИМУМ(НаименованиеПартнера),
	|	МАКСИМУМ(НомерЗаказаСтриж),
	|	МАКСИМУМ(СтоимостьЗаказа),
	|	МАКСИМУМ(КоличествоМест),
	|	СУММА(КоличествоПогруженныхМестЗаказСУчетомМест),
	|	МАКСИМУМ(КоличествоПогруженныхМестЗаказБезУчетаМест),
	|	МАКСИМУМ(ДатаРейса),
	|	МАКСИМУМ(НомерПалетты),
	|	МАКСИМУМ(Транспорт),
	|	МАКСИМУМ(Водитель),
	|	МАКСИМУМ(Экспедитор),
	|	МАКСИМУМ(ДатаУЗ),
	|	МАКСИМУМ(ТранспортУЗ),
	|	МАКСИМУМ(УЗ),
	|	МАКСИМУМ(РейсМестнойДоставки),
	|	МАКСИМУМ(НомерВнешнегоЗаказа),
	|	МАКСИМУМ(ДатаНаТСД),
	|	МАКСИМУМ(ИДТерминалаТСД)
	|ПО
	|	Рейс,
	|	НеМаршрутизирован,
	|	ВладелецТовара,
	|	Заказ";
	
	Запрос.УстановитьПараметр("Рейсы",МассивРейсов);
	Запрос.УстановитьПараметр("ТЗПараметрыУчетаЗаказов",ТаблицаПараметровУчета);
	
	ВыборкаПоРейсам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаПоРейсам.Следующий() Цикл
		
		ПолностьюСобран = 0;
		ЧастичноСобран  = 0;
		НеСобран        = 0;
		
		ТабличныйДокумент.Вывести(ОбластьШапка);
		
		ОбластьРейс.Параметры.Заполнить(ВыборкаПоРейсам);
		ОбластьРейс.Параметры.Рейс = lem.глСформироватьБарКодEAN13(ОбщегоНазначения.СформироватьШтрихкодРейса(ВыборкаПоРейсам.РейсМестнойДоставки));
		ОбластьРейс.Параметры.НомерСклад = "Акт приема- передачи №" + Строка(ВыборкаПоРейсам.НомерПалетты);
		ТабличныйДокумент.Вывести(ОбластьРейс);	
		ВыборкаПоМаршрутизации = ВыборкаПоРейсам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоМаршрутизации.Следующий() Цикл
			Если ВыборкаПоМаршрутизации.НеМаршрутизирован Тогда
				Если ВыборкаПоМаршрутизации.КоличествоПогруженныхМестЗаказБезУчетаМест = 0 И ВыборкаПоМаршрутизации.КоличествоПогруженныхМестЗаказСУчетомМест = 0 Тогда
					Продолжить;
				КонецЕсли;	
				ТекстВидДанных = "--НЕ МАРШРУТИЗИРОВАНО--";
			Иначе
				ТекстВидДанных = "МАРШРУТИЗИРОВАНО";
			КонецЕсли;	
			ОбластьВидДанных.Параметры.ВидДанных = ТекстВидДанных;
			ТабличныйДокумент.Вывести(ОбластьВидДанных);
			ВыборкаПоВладельцамТоваров = ВыборкаПоМаршрутизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоВладельцамТоваров.Следующий() Цикл
				Если ВыборкаПоВладельцамТоваров.НеМаршрутизирован И ВыборкаПоВладельцамТоваров.КоличествоПогруженныхМестЗаказБезУчетаМест = 0
					И ВыборкаПоВладельцамТоваров.КоличествоПогруженныхМестЗаказСУчетомМест = 0 Тогда
					Продолжить;
				КонецЕсли;						
				ОбластьПартнер.Параметры.НаименованиеПартнера = ВыборкаПоВладельцамТоваров.НаименованиеПартнера;
				Если Не ВыборкаПоВладельцамТоваров.НеМаршрутизирован Тогда
					ОбластьПартнер.Параметры.КоличествоЗаказовПоПартнеру = ВыборкаПоВладельцамТоваров.КоличествоЗаказовПоПартнеру;
				КонецЕсли;	
				ТабличныйДокумент.Вывести(ОбластьПартнер);
				ВыборкаПоЗаказам = ВыборкаПоВладельцамТоваров.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоЗаказам.Следующий() Цикл
					
					Если ВыборкаПоЗаказам.НеМаршрутизирован И ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказБезУчетаМест = 0
						И ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказСУчетомМест = 0 Тогда
						Продолжить;
					КонецЕсли; 
					
					ЗаказНеЗагружен = (ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказСУчетомМест = 0)
					Или (Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказБезУчетаМест = 0);
					
					НеполнаяПогрузкаЗаказаСУчетомМест  = ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоМест > ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказСУчетомМест;
					НеполнаяЗагрузкаЗаказаБезУчетаМест = Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоМест > ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказБезУчетаМест;
					МестСобраноБольшеСУчетомМест = ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоМест < ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказСУчетомМест;
					МестСобраноБольшеБезУчетаМест = Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоМест < ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказБезУчетаМест;
					
					Если ЗаказНеЗагружен Тогда
						ОбластьЗаказа = ОбластьЗаказЗачеркнутый;	
					Иначе
						ОбластьЗаказа = ОбластьЗаказ;	
					КонецЕсли;
					ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД, "-");
					ОбластьЗаказа.Параметры.ДатаНаТСД = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД),ВыборкаПоЗаказам.ДатаНаТСД, "-");	
					//Запрос = Новый Запрос;
					//Запрос.Текст = "ВЫБРАТЬ
					//|	СостоянияЗаказовСрезПоследних.Заказ КАК Заказ
					//|ИЗ
					//|	РегистрСведений.СостоянияЗаказов.СрезПоследних(&Дата, Доставка.Номер = &Номер) КАК СостоянияЗаказовСрезПоследних
					//|ГДЕ
					//|	СостоянияЗаказовСрезПоследних.ПричинаНеВыполнения = ЗНАЧЕНИЕ(Справочник.ПричиныНевыполненияДоставки.ПереносДоставки)";
					//Запрос.УстановитьПараметр("Дата",ВыборкаПоЗаказам.ДатаРейса);
					//Запрос.УстановитьПараметр("Номер",ВыборкаПоЗаказам.НомерЗаказаСтриж);
					//Выборка = Запрос.Выполнить().Выбрать();
					//ЕстьПеренос = Выборка.Количество() > 1;
					КоличествоЗагруженныхМест = ?(ВыборкаПоЗаказам.УчетЗаказовПоМестам,ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказСУчетомМест,ВыборкаПоЗаказам.КоличествоПогруженныхМестЗаказБезУчетаМест);
					Если Не ВыборкаПоЗаказам.НеМаршрутизирован Тогда
						Если КоличествоЗагруженныхМест = 0 Тогда
							НеСобран = НеСобран + 1;	
						ИначеЕсли КоличествоЗагруженныхМест < ВыборкаПоЗаказам.КоличествоМест Тогда
							ЧастичноСобран = ЧастичноСобран + 1;
						Иначе
							ПолностьюСобран = ПолностьюСобран + 1;
						КонецЕсли;	
					КонецЕсли;
					ПолныйНомерЗаказа = ОбщегоНазначения.СформироватьПолныйНомерЗаказаСПереносом(ВыборкаПоЗаказам.НомерЗаказаСтриж,ВыборкаПоЗаказам.НомерВнешнегоЗаказа,Ложь,ВыборкаПоЗаказам.КоличествоМест,КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.ПолныйНомерЗаказа = ПолныйНомерЗаказа;
					ОбластьЗаказа.Параметры.КоличествоМестЗаказа = ВыборкаПоЗаказам.КоличествоМест;
					ОбластьЗаказа.Параметры.КоличествоМестСобрано = ?(КоличествоЗагруженныхМест = 0, "НЕТ собранных мест",КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.СтоимостьЗаказа = ВыборкаПоЗаказам.СтоимостьЗаказа;
					СервиснаяНадпись = "";
					Если ВыборкаПоЗаказам.ДатаУЗ <> Null Тогда
						СервиснаяНадпись = "УДАЛЕННОЕ ЗАКРЫТИЕ: " + ?(ПустаяСтрока(ВыборкаПоЗаказам.УЗ),"<>",ВыборкаПоЗаказам.УЗ) + " / " + ВыборкаПоЗаказам.ДатаУЗ + " / " + ВыборкаПоЗаказам.ТранспортУЗ;
					КонецЕсли;	
					Если ВыборкаПоЗаказам.ЗаказНеВРейсе Тогда 
						СервиснаяНадпись = ?(ПустаяСтрока(СервиснаяНадпись),"ЗАКАЗ НЕ В РЕЙСЕ!!!",СервиснаяНадпись + Символы.ПС + "ЗАКАЗ НЕ В РЕЙСЕ!!!");
					КонецЕсли;	
					ОбластьЗаказа.Параметры.СервиснаяНадпись = СервиснаяНадпись;
					ТабличныйДокумент.Вывести(ОбластьЗаказа); 
					Если НеполнаяЗагрузкаЗаказаБезУчетаМест Или МестСобраноБольшеБезУчетаМест Или ВыборкаПоЗаказам.КоличествоМест < 0 Тогда 
						Для Каждого СтрокаТовара Из ВыборкаПоЗаказам.Заказ.Товары Цикл
							ОбластьШКТовара.Параметры.АртикулШКТовараШКМеста = СтрокаТовара.Номенклатура.Наименование;
							ОбластьШКТовара.Параметры.НаименованиеТовараСобранШК = СтрокаТовара.Номенклатура.Артикул;
							ОбластьШКТовара.Параметры.Количество = СтрокаТовара.Количество;
							ТабличныйДокумент.Вывести(ОбластьШКТовара);
						КонецЦикла;	
						Для Каждого СтрокаТовара Из ВыборкаПоЗаказам.Заказ.ПодарочныеПозиции Цикл
							ОбластьШКТовара.Параметры.АртикулШКТовараШКМеста = СтрокаТовара.Номенклатура.Наименование;
							ОбластьШКТовара.Параметры.НаименованиеТовараСобранШК = СтрокаТовара.Номенклатура.Артикул;
							ОбластьШКТовара.Параметры.Количество = СтрокаТовара.Количество;
							ТабличныйДокумент.Вывести(ОбластьШКТовара);	
						КонецЦикла;	
					ИначеЕсли НеполнаяПогрузкаЗаказаСУчетомМест Тогда
						ВыборкаМест = ВыборкаПоЗаказам.Выбрать();
						Пока ВыборкаМест.Следующий() Цикл
							Если ВыборкаМест.МестоНеПогружено Тогда	
								ОбластьВыводаМеста = ОбластьШКЗачеркнутый;
								НадписьМеста = "Не загружен ШК";
							Иначе
								ОбластьВыводаМеста = ОбластьШКТовара;
								НадписьМеста = "Загружен ШК";
							КонецЕсли;
							ОбластьВыводаМеста.Параметры.АртикулШКТовараШКМеста     = ВыборкаМест.МестоШтрихкод;
							ОбластьВыводаМеста.Параметры.НаименованиеТовараСобранШК = НадписьМеста;
							ТабличныйДокумент.Вывести(ОбластьВыводаМеста);
						КонецЦикла;	
					ИначеЕсли МестСобраноБольшеСУчетомМест Тогда
						ВыборкаМест = ВыборкаПоЗаказам.Выбрать();
						Пока Выборка.Следующий() Цикл
							ОбластьШКТовара.Параметры.АртикулШКТовараШКМеста     = ВыборкаМест.МестоШтрихкод;
							ОбластьВыводаМеста.Параметры.НаименованиеТовараСобранШК = "Загружен ШК";
							ТабличныйДокумент.Вывести(ОбластьВыводаМеста);
						КонецЦикла;	
					КонецЕсли;	
				КонецЦикла;	
			КонецЦикла;	
		КонецЦикла;	
		
		ОбластьЗаказыРейса.Параметры.Загружено  = ПолностьюСобран;
		ОбластьЗаказыРейса.Параметры.НеВсеМеста = ЧастичноСобран;
		ОбластьЗаказыРейса.Параметры.НеНайдено  = НеСобран;
		
		ТабличныйДокумент.Вывести(ОбластьЗаказыРейса);
		
		ОбластьПодвал.Параметры.ДатаСейчас = "Сформировано и распечатано: " + Строка(ТекущаяДата());
		ОбластьПодвал.Параметры.НадписьОтпущено = ОбщегоНазначения.СформироватьСуммуПрописью2(ВыборкаПоРейсам.СуммаЗаказовПоРейсу);
		ОбластьПодвал.Параметры.ШтрихкодНенайденныхЗаказов = may.ПолучитьШКCode_39(ОбщегоНазначения.СформироватьШтрихкодНенайденныхЗаказов());
		ТабличныйДокумент.Вывести(ОбластьПодвал);
		
		ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
	КонецЦикла;
	
	
	Возврат ТабличныйДокумент
	
КонецФункции


Функция ПолучитьТабличныйДокументИДанныеЗаказовКОтвязке(СписокПогрузок) Экспорт
	
	ЗапросЗаказов = Новый Запрос;
	ЗапросЗаказов.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РейсЗаказы.Ссылка КАК Рейс,
	|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
	|	РейсЗаказы.УдаленИзРейса
	|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления КАК НеМаршрутизирован,
	|	РеализацияТоваровУслуг.ВладелецТовара КАК ВладелецТовара,
	|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
	|	РеализацияТоваровУслуг.КоличествоМест КАК КоличествоМест,
	|	РеализацияТоваровУслуг.ВладелецТовара.Наименование КАК ВладелецТовараНаименование,
	|	РеализацияТоваровУслуг.Номер КАК Номер,
	|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	РейсЗаказы.Ссылка.ДатаРейса КАК ДатаРейса,
	|	РейсЗаказы.Ссылка.НомерПалетты КАК НомерПалетты,
	|	РейсЗаказы.Ссылка.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	ВЫБОР
	|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
	|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
	|	КОНЕЦ КАК ОсновнойМагазин
	|ИЗ
	|	Документ.ПогрузкаВАвто КАК ПогрузкаВАвто
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
	|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
	|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
	|			ПО РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
	|		ПО ПогрузкаВАвто.Рейс = РейсЗаказы.Ссылка
	|ГДЕ
	|	ПогрузкаВАвто.Ссылка В(&Погрузки)
	|	И ПогрузкаВАвто.Проведен
	|
	|СГРУППИРОВАТЬ ПО
	|	РейсЗаказы.Ссылка,
	|	РеализацияТоваровУслуг.Ссылка,
	|	РеализацияТоваровУслуг.ВладелецТовара,
	|	РеализацияТоваровУслуг.СуммаДокумента,
	|	РеализацияТоваровУслуг.КоличествоМест,
	|	РеализацияТоваровУслуг.ВладелецТовара.Наименование,
	|	РеализацияТоваровУслуг.Номер,
	|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	|	РейсЗаказы.Ссылка.ДатаРейса,
	|	РейсЗаказы.Ссылка.НомерПалетты,
	|	РейсЗаказы.Ссылка.РейсМестнойДоставки,
	|	РейсЗаказы.УдаленИзРейса
	|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления,
	|	ВЫБОР
	|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
	|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
	|	КОНЕЦ
	|
	|ИМЕЮЩИЕ
	|	(СУММА(ЕСТЬNULL(РеализацияТоваровУслугПодарочныеПозиции.Количество, 0)) > 0
	|		ИЛИ СУММА(ЕСТЬNULL(РеализацияТоваровУслугТовары.Количество, 0)) > 0)";
	ЗапросЗаказов.УстановитьПараметр("Погрузки",СписокПогрузок);
	ТаблицаЗаказов = ЗапросЗаказов.Выполнить().Выгрузить();
	Рейсы = ТаблицаЗаказов.ВыгрузитьКолонку("Рейс");
	ВладельцыТоваров = ТаблицаЗаказов.ВыгрузитьКолонку("ОсновнойМагазин");
	МассивЗаказов = ТаблицаЗаказов.ВыгрузитьКолонку("Заказ");
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	Заказы.Рейс КАК Рейс,
	               |	Заказы.Заказ КАК Заказ,
	               |	Заказы.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	Заказы.ВладелецТовара КАК ВладелецТовара,
	               |	Заказы.СуммаДокумента КАК СуммаДокумента,
	               |	Заказы.КоличествоМест КАК КоличествоМест,
	               |	Заказы.ВладелецТовараНаименование КАК НаименованиеПартнера,
	               |	Заказы.Номер КАК Номер,
	               |	Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	Заказы.ДатаРейса КАК ДатаРейса,
	               |	Заказы.НомерПалетты КАК НомерПалетты,
	               |	Заказы.РейсМестнойДоставки КАК РейсМестнойДоставки,
	               |	Заказы.Основноймагазин КАК Основноймагазин
	               |ПОМЕСТИТЬ втЗаказы
	               |ИЗ
	               |	&Заказы КАК Заказы
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	РейсЗаказы.Заказ КАК Заказ,
	               |	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка.Дата) КАК Дата
	               |ПОМЕСТИТЬ втМаксимальныеДатыЗагрузкиСТСД
	               |ИЗ
	               |	Документ.Рейс.Заказы КАК РейсЗаказы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	               |			И (КОНЕЦПЕРИОДА(РейсЗаказы.Ссылка.ДатаРейса, ДЕНЬ) >= ЗагрузкаСТСДШтрихкоды.Ссылка.Дата)
	               |ГДЕ
	               |	РейсЗаказы.Ссылка В(&Рейсы)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	РейсЗаказы.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс КАК Рейс,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт КАК Транспорт,
	               |	МАКСИМУМ(ПривязкаМашинКРейсамСрезПоследних1.Период) КАК Период
	               |ПОМЕСТИТЬ втДатыПредыдущихРейсов
	               |ИЗ
	               |	РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, НЕ Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних1
	               |		ПО ПривязкаМашинКРейсамСрезПоследних.Транспорт = ПривязкаМашинКРейсамСрезПоследних1.Транспорт
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	РейсЗаказы.Заказ КАК Заказ,
	               |	РейсЗаказы.Ссылка КАК Рейс
	               |ПОМЕСТИТЬ втЗаказыСОтменойДоставкиВПредыдущемРейсе
	               |ИЗ
	               |	втДатыПредыдущихРейсов КАК втДатыПредыдущихРейсов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, НЕ Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	               |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияЗаказов.СрезПоследних КАК СостоянияЗаказовСрезПоследних
	               |				ПО РейсЗаказы.Ссылка = СостоянияЗаказовСрезПоследних.Рейс
	               |					И РейсЗаказы.Заказ = СостоянияЗаказовСрезПоследних.Заказ
	               |			ПО ПривязкаМашинКРейсамСрезПоследних.Рейс = РейсЗаказы.Ссылка
	               |		ПО втДатыПредыдущихРейсов.Транспорт = ПривязкаМашинКРейсамСрезПоследних.Транспорт
	               |			И втДатыПредыдущихРейсов.Период = ПривязкаМашинКРейсамСрезПоследних.Период
	               |ГДЕ
	               |	СостоянияЗаказовСрезПоследних.ПричинаНеВыполнения В (ЗНАЧЕНИЕ(Справочник.ПричиныНеВыполненияДоставки.ПереносДоставки), ЗНАЧЕНИЕ(Справочник.ПричиныНеВыполненияДоставки.ПереносСЗаездом))
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СостояниеЗаказовНаСкладеПриУдаленномЗакрытииСрезПоследних.Заказ КАК Заказ
	               |ПОМЕСТИТЬ втЗаказыВАвтомобиле
	               |ИЗ
	               |	втЗаказыСОтменойДоставкиВПредыдущемРейсе КАК втЗаказыСОтменойДоставкиВПредыдущемРейсе
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеЗаказовНаСкладеПриУдаленномЗакрытии.СрезПоследних КАК СостояниеЗаказовНаСкладеПриУдаленномЗакрытииСрезПоследних
	               |		ПО втЗаказыСОтменойДоставкиВПредыдущемРейсе.Рейс = СостояниеЗаказовНаСкладеПриУдаленномЗакрытииСрезПоследних.Рейс
	               |			И втЗаказыСОтменойДоставкиВПредыдущемРейсе.Заказ = СостояниеЗаказовНаСкладеПриУдаленномЗакрытииСрезПоследних.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втМаксимальныеДатыЗагрузкиСТСД.Заказ КАК Заказ,
	               |	ЗагрузкаСТСДШтрихкоды.Ссылка КАК Ссылка
	               |ПОМЕСТИТЬ втПоследниеЗагрузкиСТСД
	               |ИЗ
	               |	втМаксимальныеДатыЗагрузкиСТСД КАК втМаксимальныеДатыЗагрузкиСТСД
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |		ПО втМаксимальныеДатыЗагрузкиСТСД.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	               |			И втМаксимальныеДатыЗагрузкиСТСД.Дата = ЗагрузкаСТСДШтрихкоды.Ссылка.Дата
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	МАКСИМУМ(ОтчетПоТоварамМПТовары.Ссылка.Дата) КАК ДатаУЗ,
	               |	ОтчетПоТоварамМПТовары.Заказ КАК Заказ,
	               |	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование КАК ТранспортУЗ,
	               |	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование КАК УЗ
	               |ПОМЕСТИТЬ втДокументыУдаленногоЗакрытия
	               |ИЗ
	               |	Документ.ОтчетПоТоварамМП.Товары КАК ОтчетПоТоварамМПТовары
	               |ГДЕ
	               |	ОтчетПоТоварамМПТовары.Заказ В(&МассивЗаказов)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ОтчетПоТоварамМПТовары.Заказ,
	               |	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование,
	               |	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	МАКСИМУМ(ОтчетПоДСМПДС.Ссылка.Дата),
	               |	ОтчетПоДСМПДС.Заказ,
	               |	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование,
	               |	ОтчетПоДСМПДС.Ссылка.МП.Наименование
	               |ИЗ
	               |	Документ.ОтчетПоДСМП.ДС КАК ОтчетПоДСМПДС
	               |ГДЕ
	               |	ОтчетПоДСМПДС.Заказ В(&МассивЗаказов)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ОтчетПоДСМПДС.Заказ,
	               |	ОтчетПоДСМПДС.Ссылка.МП.Наименование,
	               |	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втДокументыУдаленногоЗакрытия.Заказ КАК Заказ,
	               |	МАКСИМУМ(втДокументыУдаленногоЗакрытия.ДатаУЗ) КАК ДатаУЗ,
	               |	втДокументыУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	               |	втДокументыУдаленногоЗакрытия.УЗ КАК УЗ
	               |ПОМЕСТИТЬ втДанныеУдаленногоЗакрытия
	               |ИЗ
	               |	втДокументыУдаленногоЗакрытия КАК втДокументыУдаленногоЗакрытия
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	втДокументыУдаленногоЗакрытия.Заказ,
	               |	втДокументыУдаленногоЗакрытия.ТранспортУЗ,
	               |	втДокументыУдаленногоЗакрытия.УЗ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказы.Рейс КАК Рейс,
	               |	втЗаказы.Заказ КАК Заказ,
	               |	втЗаказы.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	               |	втЗаказы.СуммаДокумента КАК СуммаДокумента,
	               |	втЗаказы.КоличествоМест КАК КоличествоМест,
	               |	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ) КАК СкладскаяОбработкаОтсутствует,
	               |	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.УчетЗаказовПоМестам, ЛОЖЬ) КАК УчетЗаказовПоМестам,
	               |	втЗаказы.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втЗаказы.Номер КАК Номер,
	               |	втЗаказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втЗаказы.ДатаРейса КАК ДатаРейса,
	               |	втЗаказы.НомерПалетты КАК НомерПалетты,
	               |	втЗаказы.РейсМестнойДоставки КАК РейсМестнойДоставки
	               |ПОМЕСТИТЬ втЗаказыСПараметрами
	               |ИЗ
	               |	втЗаказы КАК втЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыКонтрагентов.СрезПоследних(, Контрагент В (&ВладельцыТоваров)) КАК ПараметрыКонтрагентовСрезПоследних
	               |		ПО втЗаказы.Основноймагазин = ПараметрыКонтрагентовСрезПоследних.Контрагент
	               |ГДЕ
	               |	НЕ ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказыСПараметрами.Рейс КАК Рейс,
	               |	втЗаказыСПараметрами.Заказ КАК Заказ,
	               |	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	               |	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	               |	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	               |	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	               |	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	               |	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втЗаказыСПараметрами.Номер КАК Номер,
	               |	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	               |	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	               |	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	               |ПОМЕСТИТЬ втЗаказыСУчетомПоМестам
	               |ИЗ
	               |	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	               |ГДЕ
	               |	втЗаказыСПараметрами.УчетЗаказовПоМестам
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказыСПараметрами.Рейс КАК Рейс,
	               |	втЗаказыСПараметрами.Заказ КАК Заказ,
	               |	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	               |	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	               |	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	               |	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	               |	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	               |	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втЗаказыСПараметрами.Номер КАК Номер,
	               |	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	               |	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	               |	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	               |ПОМЕСТИТЬ втЗаказыБезУчетаПоМестам
	               |ИЗ
	               |	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	               |ГДЕ
	               |	НЕ втЗаказыСПараметрами.УчетЗаказовПоМестам
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказыСУчетомПоМестам.Рейс КАК Рейс,
	               |	втЗаказыСУчетомПоМестам.Заказ КАК Заказ,
	               |	втЗаказыСУчетомПоМестам.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втЗаказыСУчетомПоМестам.ВладелецТовара КАК ВладелецТовара,
	               |	втЗаказыСУчетомПоМестам.СуммаДокумента КАК СуммаДокумента,
	               |	втЗаказыСУчетомПоМестам.КоличествоМест КАК КоличествоМест,
	               |	втЗаказыСУчетомПоМестам.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	               |	МестаПоЗаказам.Ссылка КАК МестоЗаказа,
	               |	1 КАК КоличествоМестКПогрузке,
	               |	втЗаказыСУчетомПоМестам.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	               |	втЗаказыСУчетомПоМестам.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втЗаказыСУчетомПоМестам.Номер КАК Номер,
	               |	втЗаказыСУчетомПоМестам.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втЗаказыСУчетомПоМестам.ДатаРейса КАК ДатаРейса,
	               |	втЗаказыСУчетомПоМестам.НомерПалетты КАК НомерПалетты,
	               |	втЗаказыСУчетомПоМестам.РейсМестнойДоставки КАК РейсМестнойДоставки,
	               |	МестаПоЗаказам.Штрихкод КАК ШтрихкодМеста
	               |ПОМЕСТИТЬ втМестаКПогрузке
	               |ИЗ
	               |	втЗаказыСУчетомПоМестам КАК втЗаказыСУчетомПоМестам
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаПоЗаказам КАК МестаПоЗаказам
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыЗаказов КАК ШтрихкодыЗаказов
	               |			ПО МестаПоЗаказам.Штрихкод = ШтрихкодыЗаказов.Штрихкод
	               |		ПО втЗаказыСУчетомПоМестам.Заказ = МестаПоЗаказам.Заказ
	               |ГДЕ
	               |	НЕ МестаПоЗаказам.НеАктуальное
	               |	И ШтрихкодыЗаказов.ШКПереданПартнером
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс КАК Рейс,
	               |	ПогрузкаВАвтоМестаПоЗаказам.Заказ КАК Заказ,
	               |	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа КАК МестоЗаказа,
	               |	СУММА(1) КАК КоличествоПогрузокМеста
	               |ПОМЕСТИТЬ втПогрузкиМест
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.МестаПоЗаказам КАК ПогрузкаВАвтоМестаПоЗаказам
	               |ГДЕ
	               |	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс В(&Рейсы)
	               |	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Проведен
	               |	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
				   |	И ПогрузкаВАвтоМестаПоЗаказам.КоличествоСканирований > 0
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс,
	               |	ПогрузкаВАвтоМестаПоЗаказам.Заказ,
	               |	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	               |	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	               |	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	               |ПОМЕСТИТЬ втСтрокиПогрузкиБезКорректировки
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |ГДЕ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	               |	И НЕ ПогрузкаВАвтоЗаказы.Корректировка
	               |	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	               |	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	               |	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	               |	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	               |ПОМЕСТИТЬ втСтрокиПогрузкиCКорректировкой
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |ГДЕ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	               |	И ПогрузкаВАвтоЗаказы.Корректировка
	               |	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	               |	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СУММА(ВЫБОР
	               |			КОГДА втСтрокиПогрузкиCКорректировкой.КоличествоМест ЕСТЬ NULL
	               |				ТОГДА втСтрокиПогрузкиБезКорректировки.КоличествоМест
	               |			ИНАЧЕ втСтрокиПогрузкиCКорректировкой.КоличествоМест
	               |		КОНЕЦ) КАК КоличествоМест,
	               |	втСтрокиПогрузкиБезКорректировки.Рейс КАК Рейс,
	               |	втСтрокиПогрузкиБезКорректировки.Заказ КАК Заказ
	               |ПОМЕСТИТЬ втПогрузкиБезУчетаМест
	               |ИЗ
	               |	втСтрокиПогрузкиБезКорректировки КАК втСтрокиПогрузкиБезКорректировки
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втСтрокиПогрузкиCКорректировкой КАК втСтрокиПогрузкиCКорректировкой
	               |		ПО втСтрокиПогрузкиБезКорректировки.Рейс = втСтрокиПогрузкиCКорректировкой.Рейс
	               |			И втСтрокиПогрузкиБезКорректировки.Заказ = втСтрокиПогрузкиCКорректировкой.Заказ
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	втСтрокиПогрузкиБезКорректировки.Рейс,
	               |	втСтрокиПогрузкиБезКорректировки.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втМестаКПогрузке.Рейс КАК Рейс,
	               |	втМестаКПогрузке.Заказ КАК Заказ,
	               |	втМестаКПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втМестаКПогрузке.ВладелецТовара КАК ВладелецТовара,
	               |	втМестаКПогрузке.СуммаДокумента КАК СуммаДокумента,
	               |	втМестаКПогрузке.КоличествоМест КАК КоличествоМест,
	               |	втМестаКПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	               |	втМестаКПогрузке.МестоЗаказа КАК МестоЗаказа,
	               |	втМестаКПогрузке.КоличествоМестКПогрузке КАК КоличествоМестКПогрузке,
	               |	ЕСТЬNULL(втПогрузкиМест.КоличествоПогрузокМеста, 0) КАК КоличествоПогрузокМеста,
	               |	0 КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	               |	втМестаКПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	               |	втМестаКПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втМестаКПогрузке.Номер КАК Номер,
	               |	втМестаКПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втМестаКПогрузке.ДатаРейса КАК ДатаРейса,
	               |	втМестаКПогрузке.НомерПалетты КАК НомерПалетты,
	               |	втМестаКПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	               |	втМестаКПогрузке.ШтрихкодМеста КАК ШтрихкодМеста
	               |ПОМЕСТИТЬ втДанныеПоПогрузке
	               |ИЗ
	               |	втМестаКПогрузке КАК втМестаКПогрузке
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиМест КАК втПогрузкиМест
	               |		ПО втМестаКПогрузке.Рейс = втПогрузкиМест.Рейс
	               |			И втМестаКПогрузке.Заказ = втПогрузкиМест.Заказ
	               |			И втМестаКПогрузке.МестоЗаказа = втПогрузкиМест.МестоЗаказа
	               |
	               |ОБЪЕДИНИТЬ
	               |
	               |ВЫБРАТЬ
	               |	втЗаказыБезУчетаПоМестам.Рейс,
	               |	втЗаказыБезУчетаПоМестам.Заказ,
	               |	втЗаказыБезУчетаПоМестам.НеМаршрутизирован,
	               |	втЗаказыБезУчетаПоМестам.ВладелецТовара,
	               |	втЗаказыБезУчетаПоМестам.СуммаДокумента,
	               |	втЗаказыБезУчетаПоМестам.КоличествоМест,
	               |	втЗаказыБезУчетаПоМестам.СкладскаяОбработкаОтсутствует,
	               |	NULL,
	               |	0,
	               |	0,
	               |	ЕСТЬNULL(втПогрузкиБезУчетаМест.КоличествоМест, 0),
	               |	втЗаказыБезУчетаПоМестам.УчетЗаказовПоМестам,
	               |	втЗаказыБезУчетаПоМестам.НаименованиеПартнера,
	               |	втЗаказыБезУчетаПоМестам.Номер,
	               |	втЗаказыБезУчетаПоМестам.НомерВнешнегоЗаказа,
	               |	втЗаказыБезУчетаПоМестам.ДатаРейса,
	               |	втЗаказыБезУчетаПоМестам.НомерПалетты,
	               |	втЗаказыБезУчетаПоМестам.РейсМестнойДоставки,
	               |	NULL
	               |ИЗ
	               |	втЗаказыБезУчетаПоМестам КАК втЗаказыБезУчетаПоМестам
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиБезУчетаМест КАК втПогрузкиБезУчетаМест
	               |		ПО втЗаказыБезУчетаПоМестам.Рейс = втПогрузкиБезУчетаМест.Рейс
	               |			И втЗаказыБезУчетаПоМестам.Заказ = втПогрузкиБезУчетаМест.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказы.Рейс КАК Рейс,
	               |	СУММА(втЗаказы.СуммаДокумента) КАК СуммаДокумента,
	               |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ
	               |ПОМЕСТИТЬ втИтогиПоРейсу
	               |ИЗ
	               |	втЗаказы КАК втЗаказы
	               |ГДЕ
	               |	НЕ втЗаказы.НеМаршрутизирован
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	втЗаказы.Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	               |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ
	               |ПОМЕСТИТЬ втИтогиПоВладельцамТоваров
	               |ИЗ
	               |	втЗаказы КАК втЗаказы
	               |ГДЕ
	               |	НЕ втЗаказы.НеМаршрутизирован
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	втЗаказы.ВладелецТовара
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	втДанныеПоПогрузке.Рейс КАК Рейс,
	               |	втДанныеПоПогрузке.Заказ КАК Заказ,
	               |	втДанныеПоПогрузке.ВладелецТовара КАК ВладелецТовара,
	               |	втДанныеПоПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	               |	втДанныеПоПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	               |	втИтогиПоРейсу.Заказ КАК КоличествоЗаказовПоРейсу,
	               |	втИтогиПоРейсу.СуммаДокумента КАК СуммаЗаказовПоРейсу,
	               |	втИтогиПоВладельцамТоваров.Заказ КАК КоличествоЗаказовПоПартнеру,
	               |	втДанныеПоПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	               |	втДанныеПоПогрузке.Номер КАК НомерЗаказаСтриж,
	               |	втДанныеПоПогрузке.СуммаДокумента КАК СтоимостьЗаказа,
	               |	втДанныеПоПогрузке.КоличествоМест КАК КоличествоМест,
	               |	втДанныеПоПогрузке.ДатаРейса КАК ДатаРейса,
	               |	втДанныеПоПогрузке.НомерПалетты КАК НомерПалетты,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт.Наименование КАК Транспорт,
	               |	ПривязкаМашинКРейсамСрезПоследних.Водитель.Наименование КАК Водитель,
	               |	ПривязкаМашинКРейсамСрезПоследних.Экспедитор.Наименование КАК Экспедитор,
	               |	втДанныеУдаленногоЗакрытия.ДатаУЗ КАК ДатаУЗ,
	               |	втДанныеУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	               |	втДанныеУдаленногоЗакрытия.УЗ КАК УЗ,
	               |	втДанныеПоПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	               |	втДанныеПоПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	втПоследниеЗагрузкиСТСД.Ссылка.Дата КАК ДатаНаТСД,
	               |	втПоследниеЗагрузкиСТСД.Ссылка.СерверТСД.Наименование КАК ИДТерминалаТСД,
	               |	втДанныеПоПогрузке.МестоЗаказа КАК МестоЗаказа,
	               |	втДанныеПоПогрузке.КоличествоПогрузокМеста КАК КоличествоПогрузокМеста,
	               |	втДанныеПоПогрузке.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	               |	втДанныеПоПогрузке.ШтрихкодМеста КАК ШтрихкодМеста,
	               |	втДанныеПоПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	               |	НЕ втЗаказыВАвтомобиле.Заказ ЕСТЬ NULL КАК ЗаказВАвтомобиле
	               |ИЗ
	               |	втДанныеПоПогрузке КАК втДанныеПоПогрузке
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеУдаленногоЗакрытия КАК втДанныеУдаленногоЗакрытия
	               |		ПО втДанныеПоПогрузке.Заказ = втДанныеУдаленногоЗакрытия.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоРейсу КАК втИтогиПоРейсу
	               |		ПО втДанныеПоПогрузке.Рейс = втИтогиПоРейсу.Рейс
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоВладельцамТоваров КАК втИтогиПоВладельцамТоваров
	               |		ПО втДанныеПоПогрузке.ВладелецТовара = втИтогиПоВладельцамТоваров.ВладелецТовара
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЗагрузкиСТСД КАК втПоследниеЗагрузкиСТСД
	               |		ПО втДанныеПоПогрузке.Заказ = втПоследниеЗагрузкиСТСД.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних
	               |		ПО втДанныеПоПогрузке.Рейс = ПривязкаМашинКРейсамСрезПоследних.Рейс
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втЗаказыВАвтомобиле КАК втЗаказыВАвтомобиле
	               |		ПО втДанныеПоПогрузке.Заказ = втЗаказыВАвтомобиле.Заказ
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НеМаршрутизирован УБЫВ,
	               |	НаименованиеПартнера,
	               |	НомерЗаказаСтриж
	               |ИТОГИ
	               |	МАКСИМУМ(УчетЗаказовПоМестам),
	               |	МАКСИМУМ(КоличествоЗаказовПоРейсу),
	               |	МАКСИМУМ(СуммаЗаказовПоРейсу),
	               |	МАКСИМУМ(КоличествоЗаказовПоПартнеру),
	               |	МАКСИМУМ(НаименованиеПартнера),
	               |	МАКСИМУМ(НомерЗаказаСтриж),
	               |	МАКСИМУМ(СтоимостьЗаказа),
	               |	МАКСИМУМ(КоличествоМест),
	               |	МАКСИМУМ(ДатаРейса),
	               |	МАКСИМУМ(НомерПалетты),
	               |	МАКСИМУМ(Транспорт),
	               |	МАКСИМУМ(Водитель),
	               |	МАКСИМУМ(Экспедитор),
	               |	МАКСИМУМ(ДатаУЗ),
	               |	МАКСИМУМ(ТранспортУЗ),
	               |	МАКСИМУМ(УЗ),
	               |	МАКСИМУМ(РейсМестнойДоставки),
	               |	МАКСИМУМ(НомерВнешнегоЗаказа),
	               |	МАКСИМУМ(ДатаНаТСД),
	               |	МАКСИМУМ(ИДТерминалаТСД),
	               |	СУММА(КоличествоПогрузокМеста),
	               |	СУММА(КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам),
	               |	МАКСИМУМ(ШтрихкодМеста),
	               |	МАКСИМУМ(СкладскаяОбработкаОтсутствует),
	               |	МАКСИМУМ(ЗаказВАвтомобиле)
	               |ПО
	               |	Рейс,
	               |	НеМаршрутизирован,
	               |	ВладелецТовара,
	               |	Заказ,
	               |	МестоЗаказа";
	
	Запрос.УстановитьПараметр("Заказы",ТаблицаЗаказов);
	Запрос.УстановитьПараметр("МассивЗаказов",МассивЗаказов);
	Запрос.УстановитьПараметр("ВладельцыТоваров",ВладельцыТоваров);
	Запрос.УстановитьПараметр("Рейсы",Рейсы);
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ОтображатьСетку = Ложь;
	ТабличныйДокумент.ОтображатьЗаголовки = Ложь;
	ТабличныйДокумент.ПолеСлева = 3;
	ТабличныйДокумент.ПолеСправа = 3;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Макет = Документы.Рейс.ПолучитьМакет("ВедомостьПоТранспорту");
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьРейс  = Макет.ПолучитьОбласть("ОбластьРейс");
	ОбластьВидДанных = Макет.ПолучитьОбласть("ОбластьВидДанных");
	ОбластьПартнер   = Макет.ПолучитьОбласть("ОбластьПартнер");
	ОбластьЗаказ     = Макет.ПолучитьОбласть("ОбластьЗаказ");
	ОбластьЗаказЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьЗаказЗачеркнутый"); 
	ОбластьШКТовара = Макет.ПолучитьОбласть("ОбластьШКТовара");
	ОбластьШКЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьШКЗачеркнутый");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьЗаказыРейса = Макет.ПолучитьОбласть("ЗаказыРейса");
	
	ДанныеЗаказовКОтвязке = Новый Массив;
	
	ВыборкаПоРейсам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаПоРейсам.Следующий() Цикл
		
		ПолностьюСобран = 0;
		ЧастичноСобран  = 0;
		НеСобран        = 0;
		СобраноБольше   = 0;
		
		ТабличныйДокумент.Вывести(ОбластьШапка);
		
		ОбластьРейс.Параметры.Заполнить(ВыборкаПоРейсам);
		ОбластьРейс.Параметры.Рейс = lem.глСформироватьБарКодEAN13(ОбщегоНазначения.СформироватьШтрихкодРейса(ВыборкаПоРейсам.РейсМестнойДоставки));
		ОбластьРейс.Параметры.НомерСклад = "Акт приема- передачи №" + Строка(ВыборкаПоРейсам.НомерПалетты);
		ТабличныйДокумент.Вывести(ОбластьРейс);
		ВыборкаПоМаршрутизации = ВыборкаПоРейсам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоМаршрутизации.Следующий() Цикл
			Если ВыборкаПоМаршрутизации.НеМаршрутизирован Тогда
				Если ВыборкаПоМаршрутизации.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0 И ВыборкаПоМаршрутизации.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;	
				ТекстВидДанных = "--НЕ МАРШРУТИЗИРОВАНО--";
			Иначе
				ТекстВидДанных = "МАРШРУТИЗИРОВАНО";
			КонецЕсли;	
			ОбластьВидДанных.Параметры.ВидДанных = ТекстВидДанных;
			ТабличныйДокумент.Вывести(ОбластьВидДанных);
			ВыборкаПоВладельцамТоваров = ВыборкаПоМаршрутизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоВладельцамТоваров.Следующий() Цикл
				Если ВыборкаПоВладельцамТоваров.НеМаршрутизирован И ВыборкаПоВладельцамТоваров.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
					И ВыборкаПоВладельцамТоваров.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;						
				ОбластьПартнер.Параметры.НаименованиеПартнера = ВыборкаПоВладельцамТоваров.НаименованиеПартнера;
				Если Не ВыборкаПоВладельцамТоваров.НеМаршрутизирован Тогда
					ОбластьПартнер.Параметры.КоличествоЗаказовПоПартнеру = ВыборкаПоВладельцамТоваров.КоличествоЗаказовПоПартнеру;
				КонецЕсли;	
				ТабличныйДокумент.Вывести(ОбластьПартнер);
				ВыборкаПоЗаказам = ВыборкаПоВладельцамТоваров.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоЗаказам.Следующий() Цикл
					Если ВыборкаПоЗаказам.НеМаршрутизирован И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
						И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0 Тогда
						Продолжить;
					КонецЕсли; 
					
					ЗаказНеЗагружен = (ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0)
					Или (Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0);
					
					Если ЗаказНеЗагружен Тогда
						ОбластьЗаказа = ОбластьЗаказЗачеркнутый;	
						Если НЕ ВыборкаПоЗаказам.СкладскаяОбработкаОтсутствует И Не ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД) Тогда
							ДанныеЗаказовКОтвязке.Добавить(Новый Структура("Рейс,Заказ", ВыборкаПоЗаказам.Рейс,ВыборкаПоЗаказам.Заказ));
						КонецЕсли;
					Иначе
						ОбластьЗаказа = ОбластьЗаказ;	
					КонецЕсли;
					ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД, "-");
					ОбластьЗаказа.Параметры.ДатаНаТСД = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД),ВыборкаПоЗаказам.ДатаНаТСД, "-");	
					
					КоличествоЗагруженныхМест = ?(ВыборкаПоЗаказам.УчетЗаказовПоМестам,ВыборкаПоЗаказам.КоличествоПогрузокМеста,ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам);
					НуженВыводМестЗаказа = ВыборкаПоЗаказам.КоличествоМест <> КоличествоЗагруженныхМест;
					Если Не ВыборкаПоЗаказам.НеМаршрутизирован Тогда
						Если КоличествоЗагруженныхМест = 0 Тогда
							НеСобран = НеСобран + 1;	
						ИначеЕсли КоличествоЗагруженныхМест < ВыборкаПоЗаказам.КоличествоМест Тогда
							ЧастичноСобран = ЧастичноСобран + 1;
						ИначеЕсли КоличествоЗагруженныхМест = ВыборкаПоЗаказам.КоличествоМест Тогда 
							ПолностьюСобран = ПолностьюСобран + 1;
						Иначе 
							СобраноБольше = СобраноБольше + 1;
						КонецЕсли;	
					КонецЕсли;
					ПолныйНомерЗаказа = ОбщегоНазначения.СформироватьПолныйНомерЗаказаСПереносом(ВыборкаПоЗаказам.НомерЗаказаСтриж,ВыборкаПоЗаказам.НомерВнешнегоЗаказа,Ложь,ВыборкаПоЗаказам.КоличествоМест,КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.ПолныйНомерЗаказа = ПолныйНомерЗаказа;
					ОбластьЗаказа.Параметры.КоличествоМестЗаказа = ВыборкаПоЗаказам.КоличествоМест;
					ОбластьЗаказа.Параметры.КоличествоМестСобрано = ?(КоличествоЗагруженныхМест = 0, "НЕТ собранных мест",КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.СтоимостьЗаказа = ВыборкаПоЗаказам.СтоимостьЗаказа;
					СервиснаяНадпись = "";
					Если ВыборкаПоЗаказам.ДатаУЗ <> Null Тогда
						СервиснаяНадпись = "УДАЛЕННОЕ ЗАКРЫТИЕ: " + ?(ПустаяСтрока(ВыборкаПоЗаказам.УЗ),"<>",ВыборкаПоЗаказам.УЗ) + " / " + ВыборкаПоЗаказам.ДатаУЗ + " / " + ВыборкаПоЗаказам.ТранспортУЗ;
					КонецЕсли;	
					Если ЗаказНеЗагружен И ВыборкаПоЗаказам.ЗаказВАвтомобиле Тогда
						СервиснаяНадпись = СервиснаяНадпись + ?(ПустаяСтрока(СервиснаяНадпись),"загружено в авто"," загружено в авто");	
					КонецЕсли;	
					
					ОбластьЗаказа.Параметры.СервиснаяНадпись = СервиснаяНадпись;
					ТабличныйДокумент.Вывести(ОбластьЗаказа);
					Если НуженВыводМестЗаказа Тогда 
						Если ВыборкаПоЗаказам.УчетЗаказовПоМестам Тогда
							ВыборкаПоМестам = ВыборкаПоЗаказам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
							Пока ВыборкаПоМестам.Следующий() Цикл
								ОбластьМеста = ?(ВыборкаПоМестам.КоличествоПогрузокМеста = 0,ОбластьШКЗачеркнутый,ОбластьШКТовара);
								ОбластьМеста.Параметры.АртикулШКТовараШКМеста = ВыборкаПоМестам.ШтрихкодМеста;
								ОбластьМеста.Параметры.Количество = ВыборкаПоМестам.КоличествоПогрузокМеста;
								ТабличныйДокумент.Вывести(ОбластьМеста);
							КонецЦикла;	
						Иначе
							Запрос = Новый Запрос;
							Запрос.Текст = "ВЫБРАТЬ
							|	ВложенныйЗапрос.НоменклатураПредставление КАК АртикулШКТовараШКМеста,
							|	СУММА(ВложенныйЗапрос.Количество) КАК Количество
							|ИЗ
							|	(ВЫБРАТЬ
							|		РеализацияТоваровУслугТовары.Номенклатура.Представление КАК НоменклатураПредставление,
							|		РеализацияТоваровУслугТовары.Количество КАК Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
							|	ГДЕ
							|		РеализацияТоваровУслугТовары.Ссылка = &Ссылка
							|	
							|	ОБЪЕДИНИТЬ ВСЕ
							|	
							|	ВЫБРАТЬ
							|		РеализацияТоваровУслугПодарочныеПозиции.Номенклатура.Представление,
							|		РеализацияТоваровУслугПодарочныеПозиции.Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
							|	ГДЕ
							|		РеализацияТоваровУслугПодарочныеПозиции.Ссылка = &Ссылка) КАК ВложенныйЗапрос
							|
							|СГРУППИРОВАТЬ ПО
							|	ВложенныйЗапрос.НоменклатураПредставление";
							Запрос.УстановитьПараметр("Ссылка",ВыборкаПоЗаказам.Заказ);
							Выборка = Запрос.Выполнить().Выбрать();
							Пока Выборка.Следующий() Цикл
								ОбластьШКТовара.Параметры.Заполнить(Выборка);
								ТабличныйДокумент.Вывести(ОбластьШКТовара);
							КонецЦикла;	
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;	
			КонецЦикла;	
		КонецЦикла;
		
		ОбластьЗаказыРейса.Параметры.Загружено  = ПолностьюСобран;
		ОбластьЗаказыРейса.Параметры.НеВсеМеста = ЧастичноСобран;
		ОбластьЗаказыРейса.Параметры.НеНайдено  = НеСобран;
		ОбластьЗаказыРейса.Параметры.СобраноБольше  = СобраноБольше;
		
		ТабличныйДокумент.Вывести(ОбластьЗаказыРейса);
		
		ОбластьПодвал.Параметры.ДатаСейчас = "Сформировано и распечатано: " + Строка(ТекущаяДата());
		ОбластьПодвал.Параметры.НадписьОтпущено = ОбщегоНазначения.СформироватьСуммуПрописью2(ВыборкаПоРейсам.СуммаЗаказовПоРейсу);
		ОбластьПодвал.Параметры.ШтрихкодНенайденныхЗаказов = may.ПолучитьШКCode_39(ОбщегоНазначения.СформироватьШтрихкодНенайденныхЗаказов());
		ТабличныйДокумент.Вывести(ОбластьПодвал);
		
		ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
		
	КонецЦикла;
	
	Возврат Новый Структура("ТабличныйДокумент,ДанныеЗаказовКОтвязке",ТабличныйДокумент,ДанныеЗаказовКОтвязке);
	
КонецФункции

//без анализа удаленного закрытия рейсов.
Функция ПолучитьТабличныйДокументИДанныеЗаказовКОтвязке_Старая(СписокПогрузок = Неопределено, Рейс = Неопределено) Экспорт
	
	ЗапросЗаказов = Новый Запрос;
	Если Рейс = Неопределено Тогда 
		ЗапросЗаказов.Текст =
		"ВЫБРАТЬ
		|	РейсЗаказы.Ссылка КАК Рейс,
		|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления КАК НеМаршрутизирован,
		|	РеализацияТоваровУслуг.ВладелецТовара КАК ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест КАК КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование КАК ВладелецТовараНаименование,
		|	РеализацияТоваровУслуг.Номер КАК Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса КАК ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты КАК НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки КАК РейсМестнойДоставки,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслуг.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РеализацияТоваровУслуг.ВладелецТовара
		|		ИНАЧЕ РеализацияТоваровУслуг.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ КАК ОсновнойМагазин,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ДополнительныеПараметрыЗаказа.ТарифицируемыйВес, 0) = 0
		|			ТОГДА РеализацияТоваровУслуг.ОбщийВес
		|		ИНАЧЕ ДополнительныеПараметрыЗаказа.ТарифицируемыйВес
		|	КОНЕЦ КАК Вес
		|ИЗ
		|	Документ.ПогрузкаВАвто КАК ПогрузкаВАвто
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
		|					И (РеализацияТоваровУслугТовары.НомерСтроки = 1)
		|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
		|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
		|					И (РеализацияТоваровУслугПодарочныеПозиции.НомерСтроки = 1)
		|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеПараметрыЗаказа КАК ДополнительныеПараметрыЗаказа
		|				ПО РеализацияТоваровУслуг.Ссылка = ДополнительныеПараметрыЗаказа.Заказ
		|			ПО РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
		|		ПО (ПогрузкаВАвто.Ссылка В (&Погрузки))
		|			И (ПогрузкаВАвто.Проведен)
		|			И ПогрузкаВАвто.Рейс = РейсЗаказы.Ссылка
		|ГДЕ
		|	НЕ(РеализацияТоваровУслугТовары.Ссылка ЕСТЬ NULL
		|				И РеализацияТоваровУслугПодарочныеПозиции.Ссылка ЕСТЬ NULL)";
		ЗапросЗаказов.УстановитьПараметр("Погрузки",СписокПогрузок);
	Иначе
		ЗапросЗаказов.Текст =
		"ВЫБРАТЬ
		|	РейсЗаказы.Ссылка КАК Рейс,
		|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления КАК НеМаршрутизирован,
		|	РеализацияТоваровУслуг.ВладелецТовара КАК ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест КАК КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование КАК ВладелецТовараНаименование,
		|	РеализацияТоваровУслуг.Номер КАК Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса КАК ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты КАК НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки КАК РейсМестнойДоставки,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслуг.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РеализацияТоваровУслуг.ВладелецТовара
		|		ИНАЧЕ РеализацияТоваровУслуг.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ КАК ОсновнойМагазин,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ДополнительныеПараметрыЗаказа.ТарифицируемыйВес, 0) = 0
		|			ТОГДА РеализацияТоваровУслуг.ОбщийВес
		|		ИНАЧЕ ДополнительныеПараметрыЗаказа.ТарифицируемыйВес
		|	КОНЕЦ КАК Вес
		|ИЗ
		|	Документ.Рейс.Заказы КАК РейсЗаказы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		|			ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
		|				И (РеализацияТоваровУслугТовары.НомерСтроки = 1)
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
		|			ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
		|				И (РеализацияТоваровУслугПодарочныеПозиции.НомерСтроки = 1)
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеПараметрыЗаказа КАК ДополнительныеПараметрыЗаказа
		|			ПО РеализацияТоваровУслуг.Ссылка = ДополнительныеПараметрыЗаказа.Заказ
		|		ПО (РейсЗаказы.Ссылка = &Рейс)
		|			И РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
		|ГДЕ
		|	НЕ(РеализацияТоваровУслугТовары.Ссылка ЕСТЬ NULL
		|				И РеализацияТоваровУслугПодарочныеПозиции.Ссылка ЕСТЬ NULL)";
		ЗапросЗаказов.УстановитьПараметр("Рейс", Рейс);
	КонецЕсли;
	ТаблицаЗаказов = ЗапросЗаказов.Выполнить().Выгрузить();
	Рейсы = ТаблицаЗаказов.ВыгрузитьКолонку("Рейс");
	ВладельцыТоваров = ТаблицаЗаказов.ВыгрузитьКолонку("ОсновнойМагазин");
	МассивЗаказов = ТаблицаЗаказов.ВыгрузитьКолонку("Заказ");
	
	//Асеев 28.08.2020 (по письму Re: Разблюдовка)>>>
	//в запросе добавлены временные таблицы для получения  информации по сканированию мест заказов
	//дата сканирования изменена: берется из датавремя таблицы штрихкодов ЗагрузкиСТСД
	//Асеев 28.08.2020 (по письму Re: Разблюдовка)<<<
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Заказы.Рейс КАК Рейс,
	|	Заказы.Заказ КАК Заказ,
	|	Заказы.НеМаршрутизирован КАК НеМаршрутизирован,
	|	Заказы.ВладелецТовара КАК ВладелецТовара,
	|	Заказы.СуммаДокумента КАК СуммаДокумента,
	|	Заказы.КоличествоМест КАК КоличествоМест,
	|	Заказы.ВладелецТовараНаименование КАК НаименованиеПартнера,
	|	Заказы.Номер КАК Номер,
	|	Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	Заказы.ДатаРейса КАК ДатаРейса,
	|	Заказы.НомерПалетты КАК НомерПалетты,
	|	Заказы.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	Заказы.Основноймагазин КАК Основноймагазин,
	|	Заказы.Вес КАК Вес
	|ПОМЕСТИТЬ втЗаказы
	|ИЗ
	|	&Заказы КАК Заказы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РейсЗаказы.Заказ КАК Заказ,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.ДатаВремя) КАК Дата
	|ПОМЕСТИТЬ втМаксимальныеДатыЗагрузкиСТСД
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И (КОНЕЦПЕРИОДА(РейсЗаказы.Ссылка.ДатаРейса, ДЕНЬ) >= ЗагрузкаСТСДШтрихкоды.Ссылка.Дата)
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|
	|СГРУППИРОВАТЬ ПО
	|	РейсЗаказы.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗагрузкаСТСДШтрихкоды.МестоЗаказа КАК МестоЗаказа,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.ДатаВремя) КАК Дата
	|ПОМЕСТИТЬ втМаксимальныеДатыЗагрузкиСТСДМестЗаказов
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И (КОНЕЦПЕРИОДА(РейсЗаказы.Ссылка.ДатаРейса, ДЕНЬ) >= ЗагрузкаСТСДШтрихкоды.Ссылка.Дата)
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗагрузкаСТСДШтрихкоды.МестоЗаказа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаксимальныеДатыЗагрузкиСТСД.Заказ КАК Заказ,
	|	втМаксимальныеДатыЗагрузкиСТСД.Дата КАК ДатаСканирования,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка) КАК Ссылка
	|ПОМЕСТИТЬ втПоследниеЗагрузкиСТСД
	|ИЗ
	|	втМаксимальныеДатыЗагрузкиСТСД КАК втМаксимальныеДатыЗагрузкиСТСД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО втМаксимальныеДатыЗагрузкиСТСД.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И втМаксимальныеДатыЗагрузкиСТСД.Дата = ЗагрузкаСТСДШтрихкоды.ДатаВремя
	|
	|СГРУППИРОВАТЬ ПО
	|	втМаксимальныеДатыЗагрузкиСТСД.Заказ,
	|	втМаксимальныеДатыЗагрузкиСТСД.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.МестоЗаказа КАК МестоЗаказа,
	|	втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.Дата КАК ДатаСканирования,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка) КАК Ссылка
	|ПОМЕСТИТЬ втПоследниеЗагрузкиСТСДМестЗаказов
	|ИЗ
	|	втМаксимальныеДатыЗагрузкиСТСДМестЗаказов КАК втМаксимальныеДатыЗагрузкиСТСДМестЗаказов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.МестоЗаказа = ЗагрузкаСТСДШтрихкоды.МестоЗаказа
	|			И втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.Дата = ЗагрузкаСТСДШтрихкоды.ДатаВремя
	|
	|СГРУППИРОВАТЬ ПО
	|	втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.МестоЗаказа,
	|	втМаксимальныеДатыЗагрузкиСТСДМестЗаказов.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоТоварамМПТовары.Ссылка.Дата) КАК ДатаУЗ,
	|	ОтчетПоТоварамМПТовары.Заказ КАК Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование КАК ТранспортУЗ,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование КАК УЗ
	|ПОМЕСТИТЬ втДокументыУдаленногоЗакрытия
	|ИЗ
	|	Документ.ОтчетПоТоварамМП.Товары КАК ОтчетПоТоварамМПТовары
	|ГДЕ
	|	ОтчетПоТоварамМПТовары.Заказ В(&МассивЗаказов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоТоварамМПТовары.Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоДСМПДС.Ссылка.Дата),
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование
	|ИЗ
	|	Документ.ОтчетПоДСМП.ДС КАК ОтчетПоДСМПДС
	|ГДЕ
	|	ОтчетПоДСМПДС.Заказ В(&МассивЗаказов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокументыУдаленногоЗакрытия.Заказ КАК Заказ,
	|	МАКСИМУМ(втДокументыУдаленногоЗакрытия.ДатаУЗ) КАК ДатаУЗ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ КАК УЗ
	|ПОМЕСТИТЬ втДанныеУдаленногоЗакрытия
	|ИЗ
	|	втДокументыУдаленногоЗакрытия КАК втДокументыУдаленногоЗакрытия
	|
	|СГРУППИРОВАТЬ ПО
	|	втДокументыУдаленногоЗакрытия.Заказ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.Рейс КАК Рейс,
	|	втЗаказы.Заказ КАК Заказ,
	|	втЗаказы.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказы.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказы.КоличествоМест КАК КоличествоМест,
	|	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ) КАК СкладскаяОбработкаОтсутствует,
	|	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.УчетЗаказовПоМестам, ЛОЖЬ) КАК УчетЗаказовПоМестам,
	|	втЗаказы.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказы.Номер КАК Номер,
	|	втЗаказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказы.ДатаРейса КАК ДатаРейса,
	|	втЗаказы.НомерПалетты КАК НомерПалетты,
	|	втЗаказы.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыСПараметрами
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыКонтрагентов.СрезПоследних(, Контрагент В (&ВладельцыТоваров)) КАК ПараметрыКонтрагентовСрезПоследних
	|		ПО втЗаказы.Основноймагазин = ПараметрыКонтрагентовСрезПоследних.Контрагент
	|ГДЕ
	|	НЕ ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСПараметрами.Рейс КАК Рейс,
	|	втЗаказыСПараметрами.Заказ КАК Заказ,
	|	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСПараметрами.Номер КАК Номер,
	|	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыСУчетомПоМестам
	|ИЗ
	|	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	|ГДЕ
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСПараметрами.Рейс КАК Рейс,
	|	втЗаказыСПараметрами.Заказ КАК Заказ,
	|	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСПараметрами.Номер КАК Номер,
	|	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыБезУчетаПоМестам
	|ИЗ
	|	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	|ГДЕ
	|	НЕ втЗаказыСПараметрами.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСУчетомПоМестам.Рейс КАК Рейс,
	|	втЗаказыСУчетомПоМестам.Заказ КАК Заказ,
	|	втЗаказыСУчетомПоМестам.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСУчетомПоМестам.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСУчетомПоМестам.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСУчетомПоМестам.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСУчетомПоМестам.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	МестаПоЗаказам.Ссылка КАК МестоЗаказа,
	|	ВЫБОР
	|		КОГДА МестаПоЗаказам.Ссылка ЕСТЬ NULL
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК КоличествоМестКПогрузке,
	|	втЗаказыСУчетомПоМестам.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСУчетомПоМестам.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСУчетомПоМестам.Номер КАК Номер,
	|	втЗаказыСУчетомПоМестам.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСУчетомПоМестам.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСУчетомПоМестам.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСУчетомПоМестам.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	МестаПоЗаказам.Штрихкод КАК ШтрихкодМеста,
	|	МестаПоЗаказам.Ссылка ЕСТЬ NULL КАК ШКНеПереданыПартнером
	|ПОМЕСТИТЬ втМестаКПогрузке
	|ИЗ
	|	втЗаказыСУчетомПоМестам КАК втЗаказыСУчетомПоМестам
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаПоЗаказам КАК МестаПоЗаказам
	|		ПО втЗаказыСУчетомПоМестам.Заказ = МестаПоЗаказам.Заказ
	|ГДЕ
	|	НЕ ЕСТЬNULL(МестаПоЗаказам.НеАктуальное, ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоМестаПоЗаказам.Заказ КАК Заказ,
	|	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа КАК МестоЗаказа,
	|	СУММА(1) КАК КоличествоПогрузокМеста
	|ПОМЕСТИТЬ втПогрузкиМест
	|ИЗ
	|	Документ.ПогрузкаВАвто.МестаПоЗаказам КАК ПогрузкаВАвтоМестаПоЗаказам
	|ГДЕ
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Проведен
	|	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоМестаПоЗаказам.КоличествоСканирований > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс,
	|	ПогрузкаВАвтоМестаПоЗаказам.Заказ,
	|	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	|	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	|ПОМЕСТИТЬ втСтрокиПогрузкиБезКорректировки
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И НЕ ПогрузкаВАвтоЗаказы.Корректировка
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	|	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	|ПОМЕСТИТЬ втСтрокиПогрузкиCКорректировкой
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоЗаказы.Корректировка
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА втСтрокиПогрузкиCКорректировкой.КоличествоМест ЕСТЬ NULL
	|				ТОГДА втСтрокиПогрузкиБезКорректировки.КоличествоМест
	|			ИНАЧЕ втСтрокиПогрузкиCКорректировкой.КоличествоМест
	|		КОНЕЦ) КАК КоличествоМест,
	|	втСтрокиПогрузкиБезКорректировки.Рейс КАК Рейс,
	|	втСтрокиПогрузкиБезКорректировки.Заказ КАК Заказ
	|ПОМЕСТИТЬ втПогрузкиБезУчетаМест
	|ИЗ
	|	втСтрокиПогрузкиБезКорректировки КАК втСтрокиПогрузкиБезКорректировки
	|		ЛЕВОЕ СОЕДИНЕНИЕ втСтрокиПогрузкиCКорректировкой КАК втСтрокиПогрузкиCКорректировкой
	|		ПО втСтрокиПогрузкиБезКорректировки.Рейс = втСтрокиПогрузкиCКорректировкой.Рейс
	|			И втСтрокиПогрузкиБезКорректировки.Заказ = втСтрокиПогрузкиCКорректировкой.Заказ
	|
	|СГРУППИРОВАТЬ ПО
	|	втСтрокиПогрузкиБезКорректировки.Рейс,
	|	втСтрокиПогрузкиБезКорректировки.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМестаКПогрузке.Рейс КАК Рейс,
	|	втМестаКПогрузке.Заказ КАК Заказ,
	|	втМестаКПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втМестаКПогрузке.ВладелецТовара КАК ВладелецТовара,
	|	втМестаКПогрузке.СуммаДокумента КАК СуммаДокумента,
	|	втМестаКПогрузке.КоличествоМест КАК КоличествоМест,
	|	втМестаКПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втМестаКПогрузке.МестоЗаказа КАК МестоЗаказа,
	|	втМестаКПогрузке.КоличествоМестКПогрузке КАК КоличествоМестКПогрузке,
	|	ЕСТЬNULL(втПогрузкиМест.КоличествоПогрузокМеста, 0) КАК КоличествоПогрузокМеста,
	|	0 КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	|	втМестаКПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втМестаКПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втМестаКПогрузке.Номер КАК Номер,
	|	втМестаКПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втМестаКПогрузке.ДатаРейса КАК ДатаРейса,
	|	втМестаКПогрузке.НомерПалетты КАК НомерПалетты,
	|	втМестаКПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	втМестаКПогрузке.ШтрихкодМеста КАК ШтрихкодМеста,
	|	втМестаКПогрузке.ШКНеПереданыПартнером КАК ШКНеПереданыПартнером
	|ПОМЕСТИТЬ втДанныеПоПогрузке
	|ИЗ
	|	втМестаКПогрузке КАК втМестаКПогрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиМест КАК втПогрузкиМест
	|		ПО втМестаКПогрузке.Рейс = втПогрузкиМест.Рейс
	|			И втМестаКПогрузке.Заказ = втПогрузкиМест.Заказ
	|			И втМестаКПогрузке.МестоЗаказа = втПогрузкиМест.МестоЗаказа
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	втЗаказыБезУчетаПоМестам.Рейс,
	|	втЗаказыБезУчетаПоМестам.Заказ,
	|	втЗаказыБезУчетаПоМестам.НеМаршрутизирован,
	|	втЗаказыБезУчетаПоМестам.ВладелецТовара,
	|	втЗаказыБезУчетаПоМестам.СуммаДокумента,
	|	втЗаказыБезУчетаПоМестам.КоличествоМест,
	|	втЗаказыБезУчетаПоМестам.СкладскаяОбработкаОтсутствует,
	|	NULL,
	|	0,
	|	0,
	|	ЕСТЬNULL(втПогрузкиБезУчетаМест.КоличествоМест, 0),
	|	втЗаказыБезУчетаПоМестам.УчетЗаказовПоМестам,
	|	втЗаказыБезУчетаПоМестам.НаименованиеПартнера,
	|	втЗаказыБезУчетаПоМестам.Номер,
	|	втЗаказыБезУчетаПоМестам.НомерВнешнегоЗаказа,
	|	втЗаказыБезУчетаПоМестам.ДатаРейса,
	|	втЗаказыБезУчетаПоМестам.НомерПалетты,
	|	втЗаказыБезУчетаПоМестам.РейсМестнойДоставки,
	|	NULL,
	|	ЛОЖЬ
	|ИЗ
	|	втЗаказыБезУчетаПоМестам КАК втЗаказыБезУчетаПоМестам
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиБезУчетаМест КАК втПогрузкиБезУчетаМест
	|		ПО втЗаказыБезУчетаПоМестам.Рейс = втПогрузкиБезУчетаМест.Рейс
	|			И втЗаказыБезУчетаПоМестам.Заказ = втПогрузкиБезУчетаМест.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.Рейс КАК Рейс,
	|	СУММА(втЗаказы.СуммаДокумента) КАК СуммаДокумента,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ,
	|	СУММА(втЗаказы.Вес) КАК Вес
	|ПОМЕСТИТЬ втИтогиПоРейсу
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|ГДЕ
	|	НЕ втЗаказы.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втЗаказы.Рейс
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ
	|ПОМЕСТИТЬ втИтогиПоВладельцамТоваров
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|ГДЕ
	|	НЕ втЗаказы.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втЗаказы.ВладелецТовара
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	втДанныеПоПогрузке.Рейс КАК Рейс,
	|	втДанныеПоПогрузке.Заказ КАК Заказ,
	|	втДанныеПоПогрузке.ВладелецТовара КАК ВладелецТовара,
	|	втДанныеПоПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втДанныеПоПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втИтогиПоРейсу.Заказ КАК КоличествоЗаказовПоРейсу,
	|	втИтогиПоРейсу.СуммаДокумента КАК СуммаЗаказовПоРейсу,
	|	втИтогиПоВладельцамТоваров.Заказ КАК КоличествоЗаказовПоПартнеру,
	|	втДанныеПоПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втДанныеПоПогрузке.Номер КАК НомерЗаказаСтриж,
	|	втДанныеПоПогрузке.СуммаДокумента КАК СтоимостьЗаказа,
	|	втДанныеПоПогрузке.КоличествоМест КАК КоличествоМест,
	|	втДанныеПоПогрузке.ДатаРейса КАК ДатаРейса,
	|	втДанныеПоПогрузке.НомерПалетты КАК НомерПалетты,
	|	ПривязкаМашинКРейсамСрезПоследних.Транспорт.Наименование КАК Транспорт,
	|	ПривязкаМашинКРейсамСрезПоследних.Водитель.Наименование КАК Водитель,
	|	ПривязкаМашинКРейсамСрезПоследних.Экспедитор.Наименование КАК Экспедитор,
	//Асеев 06.08.2021 (по письму Такси. Внешняя маршрутизация.)>>>
	|	ВЫБОР
	|		КОГДА ПривязкаМашинКРейсамСрезПоследних.Рейс.ВнешнийОператорМаршрутизации <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПривязкаМашинКРейсамСрезПоследних.Водитель.ИДВнешнегоОператораМаршрутизации
	|	КОНЕЦ КАК CourierId,
	//Асеев 06.08.2021 (по письму Такси. Внешняя маршрутизация.)<<<
	|	втДанныеУдаленногоЗакрытия.ДатаУЗ КАК ДатаУЗ,
	|	втДанныеУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДанныеУдаленногоЗакрытия.УЗ КАК УЗ,
	|	втДанныеПоПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	втДанныеПоПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втПоследниеЗагрузкиСТСД.ДатаСканирования КАК ДатаНаТСД,
	|	втПоследниеЗагрузкиСТСД.Ссылка.СерверТСД.Наименование КАК ИДТерминалаТСД,
	|	втДанныеПоПогрузке.МестоЗаказа КАК МестоЗаказа,
	|	втДанныеПоПогрузке.КоличествоПогрузокМеста КАК КоличествоПогрузокМеста,
	|	втДанныеПоПогрузке.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	|	втДанныеПоПогрузке.ШтрихкодМеста КАК ШтрихкодМеста,
	|	втДанныеПоПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втДанныеПоПогрузке.ШКНеПереданыПартнером КАК ШКНеПереданыПартнером,
	|	втПоследниеЗагрузкиСТСДМестЗаказов.ДатаСканирования КАК ДатаНаТСДМестаЗаказа,
	|	втПоследниеЗагрузкиСТСДМестЗаказов.Ссылка.СерверТСД.Наименование КАК ИДТерминалаТСДМестаЗаказа,
	|	втПоследниеЗагрузкиСТСД.Ссылка.НомерТСД КАК НомерТСД,
	|	втПоследниеЗагрузкиСТСДМестЗаказов.Ссылка.НомерТСД КАК НомерТСДМестаЗаказа,
	//Асеев 26.09.2022 (Задача № 4901)>>>
	|	втЗаказы.Вес КАК Вес,
	|	втИтогиПоРейсу.Вес КАК ВесРейс
	//Асеев 26.09.2022 (Задача № 4901)<<<
	|ИЗ
	|	втДанныеПоПогрузке КАК втДанныеПоПогрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеУдаленногоЗакрытия КАК втДанныеУдаленногоЗакрытия
	|		ПО втДанныеПоПогрузке.Заказ = втДанныеУдаленногоЗакрытия.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоРейсу КАК втИтогиПоРейсу
	|		ПО втДанныеПоПогрузке.Рейс = втИтогиПоРейсу.Рейс
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоВладельцамТоваров КАК втИтогиПоВладельцамТоваров
	|		ПО втДанныеПоПогрузке.ВладелецТовара = втИтогиПоВладельцамТоваров.ВладелецТовара
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЗагрузкиСТСД КАК втПоследниеЗагрузкиСТСД
	|		ПО втДанныеПоПогрузке.Заказ = втПоследниеЗагрузкиСТСД.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних
	|		ПО втДанныеПоПогрузке.Рейс = ПривязкаМашинКРейсамСрезПоследних.Рейс
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЗагрузкиСТСДМестЗаказов КАК втПоследниеЗагрузкиСТСДМестЗаказов
	|		ПО втДанныеПоПогрузке.МестоЗаказа = втПоследниеЗагрузкиСТСДМестЗаказов.МестоЗаказа
	//Асеев 26.09.2022 (Задача № 4901)>>>
	|		ЛЕВОЕ СОЕДИНЕНИЕ втЗаказы КАК втЗаказы
	|		ПО втДанныеПоПогрузке.Заказ = втЗаказы.Заказ
	//Асеев 26.09.2022 (Задача № 4901)<<<
	|
	|УПОРЯДОЧИТЬ ПО
	|	НеМаршрутизирован УБЫВ,
	|	НаименованиеПартнера,
	|	НомерЗаказаСтриж
	|ИТОГИ
	|	МАКСИМУМ(УчетЗаказовПоМестам),
	|	МАКСИМУМ(КоличествоЗаказовПоРейсу),
	|	МАКСИМУМ(СуммаЗаказовПоРейсу),
	|	МАКСИМУМ(КоличествоЗаказовПоПартнеру),
	|	МАКСИМУМ(НаименованиеПартнера),
	|	МАКСИМУМ(НомерЗаказаСтриж),
	|	МАКСИМУМ(СтоимостьЗаказа),
	|	МАКСИМУМ(КоличествоМест),
	|	МАКСИМУМ(ДатаРейса),
	|	МАКСИМУМ(НомерПалетты),
	|	МАКСИМУМ(Транспорт),
	|	МАКСИМУМ(Водитель),
	|	МАКСИМУМ(Экспедитор),
	//Асеев 06.08.2021 (по письму Такси. Внешняя маршрутизация.)>>>
	|	МАКСИМУМ(CourierId),
	//Асеев 06.08.2021 (по письму Такси. Внешняя маршрутизация.)<<<
	|	МАКСИМУМ(ДатаУЗ),
	|	МАКСИМУМ(ТранспортУЗ),
	|	МАКСИМУМ(УЗ),
	|	МАКСИМУМ(РейсМестнойДоставки),
	|	МАКСИМУМ(НомерВнешнегоЗаказа),
	|	МАКСИМУМ(ДатаНаТСД),
	|	МАКСИМУМ(ИДТерминалаТСД),
	|	СУММА(КоличествоПогрузокМеста),
	|	СУММА(КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам),
	|	МАКСИМУМ(ШтрихкодМеста),
	|	МАКСИМУМ(СкладскаяОбработкаОтсутствует),
	|	МАКСИМУМ(ШКНеПереданыПартнером),
	|	МАКСИМУМ(ДатаНаТСДМестаЗаказа),
	|	МАКСИМУМ(ИДТерминалаТСДМестаЗаказа),
	|	МАКСИМУМ(НомерТСД),
	|	МАКСИМУМ(НомерТСДМестаЗаказа),
	|	МАКСИМУМ(Вес),
	|	МАКСИМУМ(ВесРейс)
	|ПО
	|	Рейс,
	|	НеМаршрутизирован,
	|	ВладелецТовара,
	|	Заказ,
	|	МестоЗаказа";
	
	Запрос.УстановитьПараметр("Заказы",ТаблицаЗаказов);
	Запрос.УстановитьПараметр("МассивЗаказов",МассивЗаказов);
	Запрос.УстановитьПараметр("ВладельцыТоваров",ВладельцыТоваров);
	Запрос.УстановитьПараметр("Рейсы",Рейсы);
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ОтображатьСетку = Ложь;
	ТабличныйДокумент.ОтображатьЗаголовки = Ложь;
	ТабличныйДокумент.ПолеСлева = 3;
	ТабличныйДокумент.ПолеСправа = 3;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Макет = Документы.Рейс.ПолучитьМакет("ВедомостьПоТранспорту");
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьРейс  = Макет.ПолучитьОбласть("ОбластьРейс");
	ОбластьВидДанных = Макет.ПолучитьОбласть("ОбластьВидДанных");
	ОбластьПартнер   = Макет.ПолучитьОбласть("ОбластьПартнер");
	ОбластьЗаказ     = Макет.ПолучитьОбласть("ОбластьЗаказ");
	ОбластьЗаказЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьЗаказЗачеркнутый"); 
	ОбластьШКТовара = Макет.ПолучитьОбласть("ОбластьШКТовара");
	ОбластьШКЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьШКЗачеркнутый");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьЗаказыРейса = Макет.ПолучитьОбласть("ЗаказыРейса");
	
	ДанныеЗаказовКОтвязке = Новый Массив;
	
	//Результат = Запрос.ВыполнитьПакетСПромежуточнымиДанными();
	
	ВыборкаПоРейсам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаПоРейсам.Следующий() Цикл
		
		ПолностьюСобран = 0;
		ЧастичноСобран  = 0;
		НеСобран        = 0;
		СобраноБольше   = 0;
		
		ТабличныйДокумент.Вывести(ОбластьШапка);
		
		ОбластьРейс.Параметры.Заполнить(ВыборкаПоРейсам);
		ОбластьРейс.Параметры.Рейс = lem.глСформироватьБарКодEAN13(ОбщегоНазначения.СформироватьШтрихкодРейса(ВыборкаПоРейсам.РейсМестнойДоставки));
		ОбластьРейс.Параметры.НомерСклад = "Акт приема- передачи №" + Строка(ВыборкаПоРейсам.НомерПалетты);
		ТабличныйДокумент.Вывести(ОбластьРейс);
		ВыборкаПоМаршрутизации = ВыборкаПоРейсам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоМаршрутизации.Следующий() Цикл
			Если ВыборкаПоМаршрутизации.НеМаршрутизирован Тогда
				Если ВыборкаПоМаршрутизации.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0 И ВыборкаПоМаршрутизации.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;	
				ТекстВидДанных = "--НЕ МАРШРУТИЗИРОВАНО--";
			Иначе
				ТекстВидДанных = "МАРШРУТИЗИРОВАНО";
			КонецЕсли;	
			ОбластьВидДанных.Параметры.ВидДанных = ТекстВидДанных;
			ТабличныйДокумент.Вывести(ОбластьВидДанных);
			ВыборкаПоВладельцамТоваров = ВыборкаПоМаршрутизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоВладельцамТоваров.Следующий() Цикл
				Если ВыборкаПоВладельцамТоваров.НеМаршрутизирован И ВыборкаПоВладельцамТоваров.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
					И ВыборкаПоВладельцамТоваров.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;						
				ОбластьПартнер.Параметры.НаименованиеПартнера = ВыборкаПоВладельцамТоваров.НаименованиеПартнера;
				Если Не ВыборкаПоВладельцамТоваров.НеМаршрутизирован Тогда
					ОбластьПартнер.Параметры.КоличествоЗаказовПоПартнеру = ВыборкаПоВладельцамТоваров.КоличествоЗаказовПоПартнеру;
				КонецЕсли;	
				ТабличныйДокумент.Вывести(ОбластьПартнер);
				ВыборкаПоЗаказам = ВыборкаПоВладельцамТоваров.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоЗаказам.Следующий() Цикл
					Если ВыборкаПоЗаказам.НеМаршрутизирован И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
						И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0 Тогда
						Продолжить;
					КонецЕсли; 
					
					ЗаказНеЗагружен = (ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0)
					Или (Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0);
					
					Если ЗаказНеЗагружен Тогда
						ОбластьЗаказа = ОбластьЗаказЗачеркнутый;	
						Если НЕ ВыборкаПоЗаказам.СкладскаяОбработкаОтсутствует И Не ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД) Тогда
							ДанныеЗаказовКОтвязке.Добавить(Новый Структура("Рейс,Заказ", ВыборкаПоЗаказам.Рейс,ВыборкаПоЗаказам.Заказ));
						КонецЕсли;
					Иначе
						ОбластьЗаказа = ОбластьЗаказ;	
					КонецЕсли;
					//Асеев 01.09.2020 (по письму Re: Частичный Гудс 01/09/2020)>>>
					//ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД, "-");
					Если ЗначениеЗаполнено(ВыборкаПоЗаказам.НомерТСД) Тогда
						ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД + " - № " + ВыборкаПоЗаказам.НомерТСД, "-");
					Иначе
						ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД, "-");
					КонецЕсли;
					//Асеев 01.09.2020 (по письму Re: Частичный Гудс 01/09/2020)<<<
					ОбластьЗаказа.Параметры.ДатаНаТСД = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД),ВыборкаПоЗаказам.ДатаНаТСД, "-");	
					
					КоличествоЗагруженныхМест = ?(ВыборкаПоЗаказам.УчетЗаказовПоМестам,ВыборкаПоЗаказам.КоличествоПогрузокМеста,ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам);
					НуженВыводМестЗаказа = ВыборкаПоЗаказам.КоличествоМест <> КоличествоЗагруженныхМест;
					Если Не ВыборкаПоЗаказам.НеМаршрутизирован Тогда
						Если КоличествоЗагруженныхМест = 0 Тогда
							НеСобран = НеСобран + 1;	
						ИначеЕсли КоличествоЗагруженныхМест < ВыборкаПоЗаказам.КоличествоМест Тогда
							ЧастичноСобран = ЧастичноСобран + 1;
						ИначеЕсли КоличествоЗагруженныхМест = ВыборкаПоЗаказам.КоличествоМест Тогда 
							ПолностьюСобран = ПолностьюСобран + 1;
						Иначе 
							СобраноБольше = СобраноБольше + 1;
						КонецЕсли;	
					КонецЕсли;
					ПолныйНомерЗаказа = ОбщегоНазначения.СформироватьПолныйНомерЗаказаСПереносом(ВыборкаПоЗаказам.НомерЗаказаСтриж,ВыборкаПоЗаказам.НомерВнешнегоЗаказа,Ложь,ВыборкаПоЗаказам.КоличествоМест,КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.ПолныйНомерЗаказа = ПолныйНомерЗаказа;
					ОбластьЗаказа.Параметры.КоличествоМестЗаказа = ВыборкаПоЗаказам.КоличествоМест;
					ОбластьЗаказа.Параметры.КоличествоМестСобрано = ?(КоличествоЗагруженныхМест = 0, "НЕТ собранных мест",КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.СтоимостьЗаказа = ВыборкаПоЗаказам.СтоимостьЗаказа;
					//Асеев 26.09.2022 (Задача № 4901)>>>
					ОбластьЗаказа.Параметры.Вес = ВыборкаПоЗаказам.Вес;
					//Асеев 26.09.2022 (Задача № 4901)<<<
					СервиснаяНадпись = "";
					Если ВыборкаПоЗаказам.ДатаУЗ <> Null Тогда
						СервиснаяНадпись = "УДАЛЕННОЕ ЗАКРЫТИЕ: " + ?(ПустаяСтрока(ВыборкаПоЗаказам.УЗ),"<>",ВыборкаПоЗаказам.УЗ) + " / " + ВыборкаПоЗаказам.ДатаУЗ + " / " + ВыборкаПоЗаказам.ТранспортУЗ;
					КонецЕсли;	
					//Если ЗаказНеЗагружен И ВыборкаПоЗаказам.ЗаказВАвтомобиле Тогда
					//	СервиснаяНадпись = СервиснаяНадпись + ?(ПустаяСтрока(СервиснаяНадпись),"загружено в авто"," загружено в авто");	
					//КонецЕсли;	
					СервиснаяНадпись = СервиснаяНадпись + ?(ВыборкаПоЗаказам.ШКНеПереданыПартнером,"ШК НЕ ПЕРЕДАНЫ ПАРТНЕРОМ","");
					ОбластьЗаказа.Параметры.СервиснаяНадпись = СервиснаяНадпись;
					ТабличныйДокумент.Вывести(ОбластьЗаказа);
					Если НуженВыводМестЗаказа Тогда 
						Если ВыборкаПоЗаказам.УчетЗаказовПоМестам Тогда
							ВыборкаПоМестам = ВыборкаПоЗаказам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
							Пока ВыборкаПоМестам.Следующий() Цикл
								ОбластьМеста = ?(ВыборкаПоМестам.КоличествоПогрузокМеста = 0,ОбластьШКЗачеркнутый,ОбластьШКТовара);
								ОбластьМеста.Параметры.АртикулШКТовараШКМеста = ВыборкаПоМестам.ШтрихкодМеста;
								ОбластьМеста.Параметры.Количество = ВыборкаПоМестам.КоличествоПогрузокМеста;
								//Асеев 26.08.2020 (по письму Re: Разблюдовка)>>>
								//Асеев 01.09.2020 (по письму Re: Частичный Гудс 01/09/2020)>>>
								//ОбластьМеста.Параметры.ИнформацияТСД = ?(ЗначениеЗаполнено(ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа), ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа, "-") + Символы.ПС + ?(ЗначениеЗаполнено(ВыборкаПоМестам.ДатаНаТСДМестаЗаказа), ВыборкаПоМестам.ДатаНаТСДМестаЗаказа, "-");
								Если ЗначениеЗаполнено(ВыборкаПоМестам.НомерТСДМестаЗаказа) Тогда
									ОбластьМеста.Параметры.ИнформацияТСД = ?(ЗначениеЗаполнено(ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа), ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа + " - № " + ВыборкаПоМестам.НомерТСДМестаЗаказа, "-") + Символы.ПС + ?(ЗначениеЗаполнено(ВыборкаПоМестам.ДатаНаТСДМестаЗаказа), ВыборкаПоМестам.ДатаНаТСДМестаЗаказа, "-");
								Иначе
									ОбластьМеста.Параметры.ИнформацияТСД = ?(ЗначениеЗаполнено(ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа), ВыборкаПоМестам.ИДТерминалаТСДМестаЗаказа, "-") + Символы.ПС + ?(ЗначениеЗаполнено(ВыборкаПоМестам.ДатаНаТСДМестаЗаказа), ВыборкаПоМестам.ДатаНаТСДМестаЗаказа, "-");
								КонецЕсли;
								//Асеев 01.09.2020 (по письму Re: Частичный Гудс 01/09/2020)<<<
								//Асеев 26.08.2020 (по письму Re: Разблюдовка)<<<
								ТабличныйДокумент.Вывести(ОбластьМеста);
							КонецЦикла;	
						Иначе
							Запрос = Новый Запрос;
							Запрос.Текст = "ВЫБРАТЬ
							|	ВложенныйЗапрос.НоменклатураПредставление КАК АртикулШКТовараШКМеста,
							|	СУММА(ВложенныйЗапрос.Количество) КАК Количество
							|ИЗ
							|	(ВЫБРАТЬ
							|		РеализацияТоваровУслугТовары.Номенклатура.Представление КАК НоменклатураПредставление,
							|		РеализацияТоваровУслугТовары.Количество КАК Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
							|	ГДЕ
							|		РеализацияТоваровУслугТовары.Ссылка = &Ссылка
							|	
							|	ОБЪЕДИНИТЬ ВСЕ
							|	
							|	ВЫБРАТЬ
							|		РеализацияТоваровУслугПодарочныеПозиции.Номенклатура.Представление,
							|		РеализацияТоваровУслугПодарочныеПозиции.Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
							|	ГДЕ
							|		РеализацияТоваровУслугПодарочныеПозиции.Ссылка = &Ссылка) КАК ВложенныйЗапрос
							|
							|СГРУППИРОВАТЬ ПО
							|	ВложенныйЗапрос.НоменклатураПредставление";
							Запрос.УстановитьПараметр("Ссылка",ВыборкаПоЗаказам.Заказ);
							Выборка = Запрос.Выполнить().Выбрать();
							Пока Выборка.Следующий() Цикл
								ОбластьШКТовара.Параметры.Заполнить(Выборка);
								//Асеев 26.08.2020 (по письму Re: Разблюдовка)>>>
								ОбластьШКТовара.Параметры.ИнформацияТСД = "";
								//Асеев 26.08.2020 (по письму Re: Разблюдовка)<<<
								ТабличныйДокумент.Вывести(ОбластьШКТовара);
							КонецЦикла;	
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;	
			КонецЦикла;	
		КонецЦикла;
		
		ОбластьЗаказыРейса.Параметры.Загружено  = ПолностьюСобран;
		ОбластьЗаказыРейса.Параметры.НеВсеМеста = ЧастичноСобран;
		ОбластьЗаказыРейса.Параметры.НеНайдено  = НеСобран;
		ОбластьЗаказыРейса.Параметры.СобраноБольше  = СобраноБольше;
		
		ТабличныйДокумент.Вывести(ОбластьЗаказыРейса);
		
		ОбластьПодвал.Параметры.ДатаСейчас = "Сформировано и распечатано: " + Строка(ТекущаяДата());
		ОбластьПодвал.Параметры.НадписьОтпущено = ОбщегоНазначения.СформироватьСуммуПрописью2(ВыборкаПоРейсам.СуммаЗаказовПоРейсу);
		ОбластьПодвал.Параметры.ШтрихкодНенайденныхЗаказов = may.ПолучитьШКCode_39(ОбщегоНазначения.СформироватьШтрихкодНенайденныхЗаказов());
		ТабличныйДокумент.Вывести(ОбластьПодвал);
		
		ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
		
	КонецЦикла;
	
	Если Рейс = Неопределено Тогда
		Возврат Новый Структура("ТабличныйДокумент,ДанныеЗаказовКОтвязке",ТабличныйДокумент,ДанныеЗаказовКОтвязке);
	Иначе	
		Возврат ТабличныйДокумент;
	КонецЕсли;	
	
КонецФункции

Функция ПолучитьТабличныйДокументИДанныеЗаказовКОтвязке_С_РС_Штрихкодов(СписокПогрузок = Неопределено, Рейс = Неопределено) Экспорт
	
	ЗапросЗаказов = Новый Запрос;
	Если Рейс = Неопределено Тогда 
		ЗапросЗаказов.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РейсЗаказы.Ссылка КАК Рейс,
		|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления КАК НеМаршрутизирован,
		|	РеализацияТоваровУслуг.ВладелецТовара КАК ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест КАК КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование КАК ВладелецТовараНаименование,
		|	РеализацияТоваровУслуг.Номер КАК Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса КАК ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты КАК НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки КАК РейсМестнойДоставки,
		|	ВЫБОР
		|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
		|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ КАК ОсновнойМагазин
		|ИЗ
		|	Документ.ПогрузкаВАвто КАК ПогрузкаВАвто
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
		|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
		|				ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
		|			ПО РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
		|		ПО ПогрузкаВАвто.Рейс = РейсЗаказы.Ссылка
		|ГДЕ
		|	ПогрузкаВАвто.Ссылка В(&Погрузки)
		|	И ПогрузкаВАвто.Проведен
		|
		|СГРУППИРОВАТЬ ПО
		|	РейсЗаказы.Ссылка,
		|	РеализацияТоваровУслуг.Ссылка,
		|	РеализацияТоваровУслуг.ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование,
		|	РеализацияТоваровУслуг.Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления,
		|	ВЫБОР
		|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
		|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ
		|
		|ИМЕЮЩИЕ
		|	(СУММА(ЕСТЬNULL(РеализацияТоваровУслугПодарочныеПозиции.Количество, 0)) > 0
		|		ИЛИ СУММА(ЕСТЬNULL(РеализацияТоваровУслугТовары.Количество, 0)) > 0)";
		ЗапросЗаказов.УстановитьПараметр("Погрузки",СписокПогрузок);
	Иначе
		ЗапросЗаказов.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РейсЗаказы.Ссылка КАК Рейс,
		|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления КАК НеМаршрутизирован,
		|	РеализацияТоваровУслуг.ВладелецТовара КАК ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест КАК КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование КАК ВладелецТовараНаименование,
		|	РеализацияТоваровУслуг.Номер КАК Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса КАК ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты КАК НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки КАК РейсМестнойДоставки,
		|	ВЫБОР
		|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
		|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ КАК ОсновнойМагазин
		|ИЗ
		|	Документ.Рейс.Заказы КАК РейсЗаказы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		|			ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
		|			ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугПодарочныеПозиции.Ссылка
		|		ПО РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
		|ГДЕ
		|	РейсЗаказы.Ссылка = &Рейс
		|
		|СГРУППИРОВАТЬ ПО
		|	РейсЗаказы.Ссылка,
		|	РеализацияТоваровУслуг.Ссылка,
		|	РеализацияТоваровУслуг.ВладелецТовара,
		|	РеализацияТоваровУслуг.СуммаДокумента,
		|	РеализацияТоваровУслуг.КоличествоМест,
		|	РеализацияТоваровУслуг.ВладелецТовара.Наименование,
		|	РеализацияТоваровУслуг.Номер,
		|	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
		|	РейсЗаказы.Ссылка.ДатаРейса,
		|	РейсЗаказы.Ссылка.НомерПалетты,
		|	РейсЗаказы.Ссылка.РейсМестнойДоставки,
		|	РейсЗаказы.УдаленИзРейса
		|		ИЛИ РеализацияТоваровУслуг.ПометкаУдаления,
		|	ВЫБОР
		|		КОГДА РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|			ТОГДА РейсЗаказы.Заказ.ВладелецТовара
		|		ИНАЧЕ РейсЗаказы.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин
		|	КОНЕЦ
		|
		|ИМЕЮЩИЕ
		|	(СУММА(ЕСТЬNULL(РеализацияТоваровУслугПодарочныеПозиции.Количество, 0)) > 0
		|		ИЛИ СУММА(ЕСТЬNULL(РеализацияТоваровУслугТовары.Количество, 0)) > 0)";
		ЗапросЗаказов.УстановитьПараметр("Рейс", Рейс);
	КонецЕсли;
	ТаблицаЗаказов = ЗапросЗаказов.Выполнить().Выгрузить();
	Рейсы = ТаблицаЗаказов.ВыгрузитьКолонку("Рейс");
	ВладельцыТоваров = ТаблицаЗаказов.ВыгрузитьКолонку("ОсновнойМагазин");
	МассивЗаказов = ТаблицаЗаказов.ВыгрузитьКолонку("Заказ");
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Заказы.Рейс КАК Рейс,
	|	Заказы.Заказ КАК Заказ,
	|	Заказы.НеМаршрутизирован КАК НеМаршрутизирован,
	|	Заказы.ВладелецТовара КАК ВладелецТовара,
	|	Заказы.СуммаДокумента КАК СуммаДокумента,
	|	Заказы.КоличествоМест КАК КоличествоМест,
	|	Заказы.ВладелецТовараНаименование КАК НаименованиеПартнера,
	|	Заказы.Номер КАК Номер,
	|	Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	Заказы.ДатаРейса КАК ДатаРейса,
	|	Заказы.НомерПалетты КАК НомерПалетты,
	|	Заказы.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	Заказы.Основноймагазин КАК Основноймагазин
	|ПОМЕСТИТЬ втЗаказы
	|ИЗ
	|	&Заказы КАК Заказы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РейсЗаказы.Заказ КАК Заказ,
	|	МАКСИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка.Дата) КАК Дата
	|ПОМЕСТИТЬ втМаксимальныеДатыЗагрузкиСТСД
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И (КОНЕЦПЕРИОДА(РейсЗаказы.Ссылка.ДатаРейса, ДЕНЬ) >= ЗагрузкаСТСДШтрихкоды.Ссылка.Дата)
	|ГДЕ
	|	РейсЗаказы.Ссылка В(&Рейсы)
	|
	|СГРУППИРОВАТЬ ПО
	|	РейсЗаказы.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМаксимальныеДатыЗагрузкиСТСД.Заказ КАК Заказ,
	|	ЗагрузкаСТСДШтрихкоды.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ втПоследниеЗагрузкиСТСД
	|ИЗ
	|	втМаксимальныеДатыЗагрузкиСТСД КАК втМаксимальныеДатыЗагрузкиСТСД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО втМаксимальныеДатыЗагрузкиСТСД.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|			И втМаксимальныеДатыЗагрузкиСТСД.Дата = ЗагрузкаСТСДШтрихкоды.Ссылка.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоТоварамМПТовары.Ссылка.Дата) КАК ДатаУЗ,
	|	ОтчетПоТоварамМПТовары.Заказ КАК Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование КАК ТранспортУЗ,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование КАК УЗ
	|ПОМЕСТИТЬ втДокументыУдаленногоЗакрытия
	|ИЗ
	|	Документ.ОтчетПоТоварамМП.Товары КАК ОтчетПоТоварамМПТовары
	|ГДЕ
	|	ОтчетПоТоварамМПТовары.Заказ В(&МассивЗаказов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоТоварамМПТовары.Заказ,
	|	ОтчетПоТоварамМПТовары.Ссылка.Транспорт.Наименование,
	|	ОтчетПоТоварамМПТовары.Ссылка.МП.Наименование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(ОтчетПоДСМПДС.Ссылка.Дата),
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование
	|ИЗ
	|	Документ.ОтчетПоДСМП.ДС КАК ОтчетПоДСМПДС
	|ГДЕ
	|	ОтчетПоДСМПДС.Заказ В(&МассивЗаказов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПоДСМПДС.Заказ,
	|	ОтчетПоДСМПДС.Ссылка.МП.Наименование,
	|	ОтчетПоДСМПДС.Ссылка.Транспорт.Наименование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокументыУдаленногоЗакрытия.Заказ КАК Заказ,
	|	МАКСИМУМ(втДокументыУдаленногоЗакрытия.ДатаУЗ) КАК ДатаУЗ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ КАК УЗ
	|ПОМЕСТИТЬ втДанныеУдаленногоЗакрытия
	|ИЗ
	|	втДокументыУдаленногоЗакрытия КАК втДокументыУдаленногоЗакрытия
	|
	|СГРУППИРОВАТЬ ПО
	|	втДокументыУдаленногоЗакрытия.Заказ,
	|	втДокументыУдаленногоЗакрытия.ТранспортУЗ,
	|	втДокументыУдаленногоЗакрытия.УЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.Рейс КАК Рейс,
	|	втЗаказы.Заказ КАК Заказ,
	|	втЗаказы.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказы.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказы.КоличествоМест КАК КоличествоМест,
	|	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ) КАК СкладскаяОбработкаОтсутствует,
	|	ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.УчетЗаказовПоМестам, ЛОЖЬ) КАК УчетЗаказовПоМестам,
	|	втЗаказы.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказы.Номер КАК Номер,
	|	втЗаказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказы.ДатаРейса КАК ДатаРейса,
	|	втЗаказы.НомерПалетты КАК НомерПалетты,
	|	втЗаказы.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыСПараметрами
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыКонтрагентов.СрезПоследних(, Контрагент В (&ВладельцыТоваров)) КАК ПараметрыКонтрагентовСрезПоследних
	|		ПО втЗаказы.Основноймагазин = ПараметрыКонтрагентовСрезПоследних.Контрагент
	|ГДЕ
	|	НЕ ЕСТЬNULL(ПараметрыКонтрагентовСрезПоследних.СкладскаяОбработкаОтсутствует, ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСПараметрами.Рейс КАК Рейс,
	|	втЗаказыСПараметрами.Заказ КАК Заказ,
	|	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСПараметрами.Номер КАК Номер,
	|	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыСУчетомПоМестам
	|ИЗ
	|	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	|ГДЕ
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСПараметрами.Рейс КАК Рейс,
	|	втЗаказыСПараметрами.Заказ КАК Заказ,
	|	втЗаказыСПараметрами.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСПараметрами.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСПараметрами.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСПараметрами.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСПараметрами.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втЗаказыСПараметрами.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСПараметрами.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСПараметрами.Номер КАК Номер,
	|	втЗаказыСПараметрами.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСПараметрами.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСПараметрами.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСПараметрами.РейсМестнойДоставки КАК РейсМестнойДоставки
	|ПОМЕСТИТЬ втЗаказыБезУчетаПоМестам
	|ИЗ
	|	втЗаказыСПараметрами КАК втЗаказыСПараметрами
	|ГДЕ
	|	НЕ втЗаказыСПараметрами.УчетЗаказовПоМестам
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказыСУчетомПоМестам.Рейс КАК Рейс,
	|	втЗаказыСУчетомПоМестам.Заказ КАК Заказ,
	|	втЗаказыСУчетомПоМестам.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втЗаказыСУчетомПоМестам.ВладелецТовара КАК ВладелецТовара,
	|	втЗаказыСУчетомПоМестам.СуммаДокумента КАК СуммаДокумента,
	|	втЗаказыСУчетомПоМестам.КоличествоМест КАК КоличествоМест,
	|	втЗаказыСУчетомПоМестам.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	МестаПоЗаказам.Ссылка КАК МестоЗаказа,
	|	1 КАК КоличествоМестКПогрузке,
	|	втЗаказыСУчетомПоМестам.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втЗаказыСУчетомПоМестам.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втЗаказыСУчетомПоМестам.Номер КАК Номер,
	|	втЗаказыСУчетомПоМестам.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втЗаказыСУчетомПоМестам.ДатаРейса КАК ДатаРейса,
	|	втЗаказыСУчетомПоМестам.НомерПалетты КАК НомерПалетты,
	|	втЗаказыСУчетомПоМестам.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	МестаПоЗаказам.Штрихкод КАК ШтрихкодМеста
	|ПОМЕСТИТЬ втМестаКПогрузке
	|ИЗ
	|	втЗаказыСУчетомПоМестам КАК втЗаказыСУчетомПоМестам
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаПоЗаказам КАК МестаПоЗаказам
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыЗаказов КАК ШтрихкодыЗаказов
	|			ПО МестаПоЗаказам.Штрихкод = ШтрихкодыЗаказов.Штрихкод
	|		ПО втЗаказыСУчетомПоМестам.Заказ = МестаПоЗаказам.Заказ
	|ГДЕ
	|	НЕ МестаПоЗаказам.НеАктуальное
	|	И ШтрихкодыЗаказов.ШКПереданПартнером
	|	И ШтрихкодыЗаказов.НомерМеста <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоМестаПоЗаказам.Заказ КАК Заказ,
	|	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа КАК МестоЗаказа,
	|	СУММА(1) КАК КоличествоПогрузокМеста
	|ПОМЕСТИТЬ втПогрузкиМест
	|ИЗ
	|	Документ.ПогрузкаВАвто.МестаПоЗаказам КАК ПогрузкаВАвтоМестаПоЗаказам
	|ГДЕ
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Проведен
	|	И ПогрузкаВАвтоМестаПоЗаказам.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоМестаПоЗаказам.КоличествоСканирований > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ПогрузкаВАвтоМестаПоЗаказам.Ссылка.Рейс,
	|	ПогрузкаВАвтоМестаПоЗаказам.Заказ,
	|	ПогрузкаВАвтоМестаПоЗаказам.МестоЗаказа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	|	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	|ПОМЕСТИТЬ втСтрокиПогрузкиБезКорректировки
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И НЕ ПогрузкаВАвтоЗаказы.Корректировка
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс КАК Рейс,
	|	ПогрузкаВАвтоЗаказы.Заказ КАК Заказ,
	|	ПогрузкаВАвтоЗаказы.КоличествоМест КАК КоличествоМест
	|ПОМЕСТИТЬ втСтрокиПогрузкиCКорректировкой
	|ИЗ
	|	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	|ГДЕ
	|	ПогрузкаВАвтоЗаказы.Ссылка.Рейс В(&Рейсы)
	|	И ПогрузкаВАвтоЗаказы.Корректировка
	|	И ПогрузкаВАвтоЗаказы.Ссылка.ЭтапПогрузки = ЗНАЧЕНИЕ(Справочник.ЭтапыПогрузкиЗаказовВТранспорт.Сортировка)
	|	И ПогрузкаВАвтоЗаказы.Ссылка.Проведен
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА втСтрокиПогрузкиCКорректировкой.КоличествоМест ЕСТЬ NULL
	|				ТОГДА втСтрокиПогрузкиБезКорректировки.КоличествоМест
	|			ИНАЧЕ втСтрокиПогрузкиCКорректировкой.КоличествоМест
	|		КОНЕЦ) КАК КоличествоМест,
	|	втСтрокиПогрузкиБезКорректировки.Рейс КАК Рейс,
	|	втСтрокиПогрузкиБезКорректировки.Заказ КАК Заказ
	|ПОМЕСТИТЬ втПогрузкиБезУчетаМест
	|ИЗ
	|	втСтрокиПогрузкиБезКорректировки КАК втСтрокиПогрузкиБезКорректировки
	|		ЛЕВОЕ СОЕДИНЕНИЕ втСтрокиПогрузкиCКорректировкой КАК втСтрокиПогрузкиCКорректировкой
	|		ПО втСтрокиПогрузкиБезКорректировки.Рейс = втСтрокиПогрузкиCКорректировкой.Рейс
	|			И втСтрокиПогрузкиБезКорректировки.Заказ = втСтрокиПогрузкиCКорректировкой.Заказ
	|
	|СГРУППИРОВАТЬ ПО
	|	втСтрокиПогрузкиБезКорректировки.Рейс,
	|	втСтрокиПогрузкиБезКорректировки.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втМестаКПогрузке.Рейс КАК Рейс,
	|	втМестаКПогрузке.Заказ КАК Заказ,
	|	втМестаКПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втМестаКПогрузке.ВладелецТовара КАК ВладелецТовара,
	|	втМестаКПогрузке.СуммаДокумента КАК СуммаДокумента,
	|	втМестаКПогрузке.КоличествоМест КАК КоличествоМест,
	|	втМестаКПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует,
	|	втМестаКПогрузке.МестоЗаказа КАК МестоЗаказа,
	|	втМестаКПогрузке.КоличествоМестКПогрузке КАК КоличествоМестКПогрузке,
	|	ЕСТЬNULL(втПогрузкиМест.КоличествоПогрузокМеста, 0) КАК КоличествоПогрузокМеста,
	|	0 КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	|	втМестаКПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втМестаКПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втМестаКПогрузке.Номер КАК Номер,
	|	втМестаКПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втМестаКПогрузке.ДатаРейса КАК ДатаРейса,
	|	втМестаКПогрузке.НомерПалетты КАК НомерПалетты,
	|	втМестаКПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	втМестаКПогрузке.ШтрихкодМеста КАК ШтрихкодМеста
	|ПОМЕСТИТЬ втДанныеПоПогрузке
	|ИЗ
	|	втМестаКПогрузке КАК втМестаКПогрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиМест КАК втПогрузкиМест
	|		ПО втМестаКПогрузке.Рейс = втПогрузкиМест.Рейс
	|			И втМестаКПогрузке.Заказ = втПогрузкиМест.Заказ
	|			И втМестаКПогрузке.МестоЗаказа = втПогрузкиМест.МестоЗаказа
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	втЗаказыБезУчетаПоМестам.Рейс,
	|	втЗаказыБезУчетаПоМестам.Заказ,
	|	втЗаказыБезУчетаПоМестам.НеМаршрутизирован,
	|	втЗаказыБезУчетаПоМестам.ВладелецТовара,
	|	втЗаказыБезУчетаПоМестам.СуммаДокумента,
	|	втЗаказыБезУчетаПоМестам.КоличествоМест,
	|	втЗаказыБезУчетаПоМестам.СкладскаяОбработкаОтсутствует,
	|	NULL,
	|	0,
	|	0,
	|	ЕСТЬNULL(втПогрузкиБезУчетаМест.КоличествоМест, 0),
	|	втЗаказыБезУчетаПоМестам.УчетЗаказовПоМестам,
	|	втЗаказыБезУчетаПоМестам.НаименованиеПартнера,
	|	втЗаказыБезУчетаПоМестам.Номер,
	|	втЗаказыБезУчетаПоМестам.НомерВнешнегоЗаказа,
	|	втЗаказыБезУчетаПоМестам.ДатаРейса,
	|	втЗаказыБезУчетаПоМестам.НомерПалетты,
	|	втЗаказыБезУчетаПоМестам.РейсМестнойДоставки,
	|	NULL
	|ИЗ
	|	втЗаказыБезУчетаПоМестам КАК втЗаказыБезУчетаПоМестам
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПогрузкиБезУчетаМест КАК втПогрузкиБезУчетаМест
	|		ПО втЗаказыБезУчетаПоМестам.Рейс = втПогрузкиБезУчетаМест.Рейс
	|			И втЗаказыБезУчетаПоМестам.Заказ = втПогрузкиБезУчетаМест.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.Рейс КАК Рейс,
	|	СУММА(втЗаказы.СуммаДокумента) КАК СуммаДокумента,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ
	|ПОМЕСТИТЬ втИтогиПоРейсу
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|ГДЕ
	|	НЕ втЗаказы.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втЗаказы.Рейс
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втЗаказы.ВладелецТовара КАК ВладелецТовара,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втЗаказы.Заказ) КАК Заказ
	|ПОМЕСТИТЬ втИтогиПоВладельцамТоваров
	|ИЗ
	|	втЗаказы КАК втЗаказы
	|ГДЕ
	|	НЕ втЗаказы.НеМаршрутизирован
	|
	|СГРУППИРОВАТЬ ПО
	|	втЗаказы.ВладелецТовара
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	втДанныеПоПогрузке.Рейс КАК Рейс,
	|	втДанныеПоПогрузке.Заказ КАК Заказ,
	|	втДанныеПоПогрузке.ВладелецТовара КАК ВладелецТовара,
	|	втДанныеПоПогрузке.УчетЗаказовПоМестам КАК УчетЗаказовПоМестам,
	|	втДанныеПоПогрузке.НеМаршрутизирован КАК НеМаршрутизирован,
	|	втИтогиПоРейсу.Заказ КАК КоличествоЗаказовПоРейсу,
	|	втИтогиПоРейсу.СуммаДокумента КАК СуммаЗаказовПоРейсу,
	|	втИтогиПоВладельцамТоваров.Заказ КАК КоличествоЗаказовПоПартнеру,
	|	втДанныеПоПогрузке.НаименованиеПартнера КАК НаименованиеПартнера,
	|	втДанныеПоПогрузке.Номер КАК НомерЗаказаСтриж,
	|	втДанныеПоПогрузке.СуммаДокумента КАК СтоимостьЗаказа,
	|	втДанныеПоПогрузке.КоличествоМест КАК КоличествоМест,
	|	втДанныеПоПогрузке.ДатаРейса КАК ДатаРейса,
	|	втДанныеПоПогрузке.НомерПалетты КАК НомерПалетты,
	|	ПривязкаМашинКРейсамСрезПоследних.Транспорт.Наименование КАК Транспорт,
	|	ПривязкаМашинКРейсамСрезПоследних.Водитель.Наименование КАК Водитель,
	|	ПривязкаМашинКРейсамСрезПоследних.Экспедитор.Наименование КАК Экспедитор,
	|	втДанныеУдаленногоЗакрытия.ДатаУЗ КАК ДатаУЗ,
	|	втДанныеУдаленногоЗакрытия.ТранспортУЗ КАК ТранспортУЗ,
	|	втДанныеУдаленногоЗакрытия.УЗ КАК УЗ,
	|	втДанныеПоПогрузке.РейсМестнойДоставки КАК РейсМестнойДоставки,
	|	втДанныеПоПогрузке.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	|	втПоследниеЗагрузкиСТСД.Ссылка.Дата КАК ДатаНаТСД,
	|	втПоследниеЗагрузкиСТСД.Ссылка.СерверТСД.Наименование КАК ИДТерминалаТСД,
	|	втДанныеПоПогрузке.МестоЗаказа КАК МестоЗаказа,
	|	втДанныеПоПогрузке.КоличествоПогрузокМеста КАК КоличествоПогрузокМеста,
	|	втДанныеПоПогрузке.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам КАК КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам,
	|	втДанныеПоПогрузке.ШтрихкодМеста КАК ШтрихкодМеста,
	|	втДанныеПоПогрузке.СкладскаяОбработкаОтсутствует КАК СкладскаяОбработкаОтсутствует
	|ИЗ
	|	втДанныеПоПогрузке КАК втДанныеПоПогрузке
	|		ЛЕВОЕ СОЕДИНЕНИЕ втДанныеУдаленногоЗакрытия КАК втДанныеУдаленногоЗакрытия
	|		ПО втДанныеПоПогрузке.Заказ = втДанныеУдаленногоЗакрытия.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоРейсу КАК втИтогиПоРейсу
	|		ПО втДанныеПоПогрузке.Рейс = втИтогиПоРейсу.Рейс
	|		ЛЕВОЕ СОЕДИНЕНИЕ втИтогиПоВладельцамТоваров КАК втИтогиПоВладельцамТоваров
	|		ПО втДанныеПоПогрузке.ВладелецТовара = втИтогиПоВладельцамТоваров.ВладелецТовара
	|		ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЗагрузкиСТСД КАК втПоследниеЗагрузкиСТСД
	|		ПО втДанныеПоПогрузке.Заказ = втПоследниеЗагрузкиСТСД.Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, Рейс В (&Рейсы)) КАК ПривязкаМашинКРейсамСрезПоследних
	|		ПО втДанныеПоПогрузке.Рейс = ПривязкаМашинКРейсамСрезПоследних.Рейс
	|
	|УПОРЯДОЧИТЬ ПО
	|	НеМаршрутизирован УБЫВ,
	|	НаименованиеПартнера,
	|	НомерЗаказаСтриж
	|ИТОГИ
	|	МАКСИМУМ(УчетЗаказовПоМестам),
	|	МАКСИМУМ(КоличествоЗаказовПоРейсу),
	|	МАКСИМУМ(СуммаЗаказовПоРейсу),
	|	МАКСИМУМ(КоличествоЗаказовПоПартнеру),
	|	МАКСИМУМ(НаименованиеПартнера),
	|	МАКСИМУМ(НомерЗаказаСтриж),
	|	МАКСИМУМ(СтоимостьЗаказа),
	|	МАКСИМУМ(КоличествоМест),
	|	МАКСИМУМ(ДатаРейса),
	|	МАКСИМУМ(НомерПалетты),
	|	МАКСИМУМ(Транспорт),
	|	МАКСИМУМ(Водитель),
	|	МАКСИМУМ(Экспедитор),
	|	МАКСИМУМ(ДатаУЗ),
	|	МАКСИМУМ(ТранспортУЗ),
	|	МАКСИМУМ(УЗ),
	|	МАКСИМУМ(РейсМестнойДоставки),
	|	МАКСИМУМ(НомерВнешнегоЗаказа),
	|	МАКСИМУМ(ДатаНаТСД),
	|	МАКСИМУМ(ИДТерминалаТСД),
	|	СУММА(КоличествоПогрузокМеста),
	|	СУММА(КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам),
	|	МАКСИМУМ(ШтрихкодМеста),
	|	МАКСИМУМ(СкладскаяОбработкаОтсутствует)
	|ПО
	|	Рейс,
	|	НеМаршрутизирован,
	|	ВладелецТовара,
	|	Заказ,
	|	МестоЗаказа";
	
	Запрос.УстановитьПараметр("Заказы",ТаблицаЗаказов);
	Запрос.УстановитьПараметр("МассивЗаказов",МассивЗаказов);
	Запрос.УстановитьПараметр("ВладельцыТоваров",ВладельцыТоваров);
	Запрос.УстановитьПараметр("Рейсы",Рейсы);
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ОтображатьСетку = Ложь;
	ТабличныйДокумент.ОтображатьЗаголовки = Ложь;
	ТабличныйДокумент.ПолеСлева = 3;
	ТабличныйДокумент.ПолеСправа = 3;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	Макет = Документы.Рейс.ПолучитьМакет("ВедомостьПоТранспорту");
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб = Истина;
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьРейс  = Макет.ПолучитьОбласть("ОбластьРейс");
	ОбластьВидДанных = Макет.ПолучитьОбласть("ОбластьВидДанных");
	ОбластьПартнер   = Макет.ПолучитьОбласть("ОбластьПартнер");
	ОбластьЗаказ     = Макет.ПолучитьОбласть("ОбластьЗаказ");
	ОбластьЗаказЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьЗаказЗачеркнутый"); 
	ОбластьШКТовара = Макет.ПолучитьОбласть("ОбластьШКТовара");
	ОбластьШКЗачеркнутый =  Макет.ПолучитьОбласть("ОбластьШКЗачеркнутый");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	ОбластьЗаказыРейса = Макет.ПолучитьОбласть("ЗаказыРейса");
	
	ДанныеЗаказовКОтвязке = Новый Массив;
	
	ВыборкаПоРейсам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаПоРейсам.Следующий() Цикл
		
		ПолностьюСобран = 0;
		ЧастичноСобран  = 0;
		НеСобран        = 0;
		СобраноБольше   = 0;
		
		ТабличныйДокумент.Вывести(ОбластьШапка);
		
		ОбластьРейс.Параметры.Заполнить(ВыборкаПоРейсам);
		ОбластьРейс.Параметры.Рейс = lem.глСформироватьБарКодEAN13(ОбщегоНазначения.СформироватьШтрихкодРейса(ВыборкаПоРейсам.РейсМестнойДоставки));
		ОбластьРейс.Параметры.НомерСклад = "Акт приема- передачи №" + Строка(ВыборкаПоРейсам.НомерПалетты);
		ТабличныйДокумент.Вывести(ОбластьРейс);
		ВыборкаПоМаршрутизации = ВыборкаПоРейсам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПоМаршрутизации.Следующий() Цикл
			Если ВыборкаПоМаршрутизации.НеМаршрутизирован Тогда
				Если ВыборкаПоМаршрутизации.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0 И ВыборкаПоМаршрутизации.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;	
				ТекстВидДанных = "--НЕ МАРШРУТИЗИРОВАНО--";
			Иначе
				ТекстВидДанных = "МАРШРУТИЗИРОВАНО";
			КонецЕсли;	
			ОбластьВидДанных.Параметры.ВидДанных = ТекстВидДанных;
			ТабличныйДокумент.Вывести(ОбластьВидДанных);
			ВыборкаПоВладельцамТоваров = ВыборкаПоМаршрутизации.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоВладельцамТоваров.Следующий() Цикл
				Если ВыборкаПоВладельцамТоваров.НеМаршрутизирован И ВыборкаПоВладельцамТоваров.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
					И ВыборкаПоВладельцамТоваров.КоличествоПогрузокМеста = 0 Тогда
					Продолжить;
				КонецЕсли;						
				ОбластьПартнер.Параметры.НаименованиеПартнера = ВыборкаПоВладельцамТоваров.НаименованиеПартнера;
				Если Не ВыборкаПоВладельцамТоваров.НеМаршрутизирован Тогда
					ОбластьПартнер.Параметры.КоличествоЗаказовПоПартнеру = ВыборкаПоВладельцамТоваров.КоличествоЗаказовПоПартнеру;
				КонецЕсли;	
				ТабличныйДокумент.Вывести(ОбластьПартнер);
				ВыборкаПоЗаказам = ВыборкаПоВладельцамТоваров.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоЗаказам.Следующий() Цикл
					Если ВыборкаПоЗаказам.НеМаршрутизирован И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0
						И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0 Тогда
						Продолжить;
					КонецЕсли; 
					
					ЗаказНеЗагружен = (ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогрузокМеста = 0)
					Или (Не ВыборкаПоЗаказам.УчетЗаказовПоМестам И ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам = 0);
					
					Если ЗаказНеЗагружен Тогда
						ОбластьЗаказа = ОбластьЗаказЗачеркнутый;	
						Если НЕ ВыборкаПоЗаказам.СкладскаяОбработкаОтсутствует И Не ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД) Тогда
							ДанныеЗаказовКОтвязке.Добавить(Новый Структура("Рейс,Заказ", ВыборкаПоЗаказам.Рейс,ВыборкаПоЗаказам.Заказ));
						КонецЕсли;
					Иначе
						ОбластьЗаказа = ОбластьЗаказ;	
					КонецЕсли;
					ОбластьЗаказа.Параметры.БылНаТСД  = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ИДТерминалаТСД),ВыборкаПоЗаказам.ИДТерминалаТСД, "-");
					ОбластьЗаказа.Параметры.ДатаНаТСД = ?(ЗначениеЗаполнено(ВыборкаПоЗаказам.ДатаНаТСД),ВыборкаПоЗаказам.ДатаНаТСД, "-");	
					
					КоличествоЗагруженныхМест = ?(ВыборкаПоЗаказам.УчетЗаказовПоМестам,ВыборкаПоЗаказам.КоличествоПогрузокМеста,ВыборкаПоЗаказам.КоличествоПогруженныхМестДляЗаказовБезУчетаПоМестам);
					НуженВыводМестЗаказа = ВыборкаПоЗаказам.КоличествоМест <> КоличествоЗагруженныхМест;
					Если Не ВыборкаПоЗаказам.НеМаршрутизирован Тогда
						Если КоличествоЗагруженныхМест = 0 Тогда
							НеСобран = НеСобран + 1;	
						ИначеЕсли КоличествоЗагруженныхМест < ВыборкаПоЗаказам.КоличествоМест Тогда
							ЧастичноСобран = ЧастичноСобран + 1;
						ИначеЕсли КоличествоЗагруженныхМест = ВыборкаПоЗаказам.КоличествоМест Тогда 
							ПолностьюСобран = ПолностьюСобран + 1;
						Иначе 
							СобраноБольше = СобраноБольше + 1;
						КонецЕсли;	
					КонецЕсли;
					ПолныйНомерЗаказа = ОбщегоНазначения.СформироватьПолныйНомерЗаказаСПереносом(ВыборкаПоЗаказам.НомерЗаказаСтриж,ВыборкаПоЗаказам.НомерВнешнегоЗаказа,Ложь,ВыборкаПоЗаказам.КоличествоМест,КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.ПолныйНомерЗаказа = ПолныйНомерЗаказа;
					ОбластьЗаказа.Параметры.КоличествоМестЗаказа = ВыборкаПоЗаказам.КоличествоМест;
					ОбластьЗаказа.Параметры.КоличествоМестСобрано = ?(КоличествоЗагруженныхМест = 0, "НЕТ собранных мест",КоличествоЗагруженныхМест);
					ОбластьЗаказа.Параметры.СтоимостьЗаказа = ВыборкаПоЗаказам.СтоимостьЗаказа;
					СервиснаяНадпись = "";
					Если ВыборкаПоЗаказам.ДатаУЗ <> Null Тогда
						СервиснаяНадпись = "УДАЛЕННОЕ ЗАКРЫТИЕ: " + ?(ПустаяСтрока(ВыборкаПоЗаказам.УЗ),"<>",ВыборкаПоЗаказам.УЗ) + " / " + ВыборкаПоЗаказам.ДатаУЗ + " / " + ВыборкаПоЗаказам.ТранспортУЗ;
					КонецЕсли;	
					//Если ЗаказНеЗагружен И ВыборкаПоЗаказам.ЗаказВАвтомобиле Тогда
					//	СервиснаяНадпись = СервиснаяНадпись + ?(ПустаяСтрока(СервиснаяНадпись),"загружено в авто"," загружено в авто");	
					//КонецЕсли;	
					
					ОбластьЗаказа.Параметры.СервиснаяНадпись = СервиснаяНадпись;
					ТабличныйДокумент.Вывести(ОбластьЗаказа);
					Если НуженВыводМестЗаказа Тогда 
						Если ВыборкаПоЗаказам.УчетЗаказовПоМестам Тогда
							ВыборкаПоМестам = ВыборкаПоЗаказам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
							Пока ВыборкаПоМестам.Следующий() Цикл
								ОбластьМеста = ?(ВыборкаПоМестам.КоличествоПогрузокМеста = 0,ОбластьШКЗачеркнутый,ОбластьШКТовара);
								ОбластьМеста.Параметры.АртикулШКТовараШКМеста = ВыборкаПоМестам.ШтрихкодМеста;
								ОбластьМеста.Параметры.Количество = ВыборкаПоМестам.КоличествоПогрузокМеста;
								ТабличныйДокумент.Вывести(ОбластьМеста);
							КонецЦикла;	
						Иначе
							Запрос = Новый Запрос;
							Запрос.Текст = "ВЫБРАТЬ
							|	ВложенныйЗапрос.НоменклатураПредставление КАК АртикулШКТовараШКМеста,
							|	СУММА(ВложенныйЗапрос.Количество) КАК Количество
							|ИЗ
							|	(ВЫБРАТЬ
							|		РеализацияТоваровУслугТовары.Номенклатура.Представление КАК НоменклатураПредставление,
							|		РеализацияТоваровУслугТовары.Количество КАК Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
							|	ГДЕ
							|		РеализацияТоваровУслугТовары.Ссылка = &Ссылка
							|	
							|	ОБЪЕДИНИТЬ ВСЕ
							|	
							|	ВЫБРАТЬ
							|		РеализацияТоваровУслугПодарочныеПозиции.Номенклатура.Представление,
							|		РеализацияТоваровУслугПодарочныеПозиции.Количество
							|	ИЗ
							|		Документ.РеализацияТоваровУслуг.ПодарочныеПозиции КАК РеализацияТоваровУслугПодарочныеПозиции
							|	ГДЕ
							|		РеализацияТоваровУслугПодарочныеПозиции.Ссылка = &Ссылка) КАК ВложенныйЗапрос
							|
							|СГРУППИРОВАТЬ ПО
							|	ВложенныйЗапрос.НоменклатураПредставление";
							Запрос.УстановитьПараметр("Ссылка",ВыборкаПоЗаказам.Заказ);
							Выборка = Запрос.Выполнить().Выбрать();
							Пока Выборка.Следующий() Цикл
								ОбластьШКТовара.Параметры.Заполнить(Выборка);
								ТабличныйДокумент.Вывести(ОбластьШКТовара);
							КонецЦикла;	
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;	
			КонецЦикла;	
		КонецЦикла;
		
		ОбластьЗаказыРейса.Параметры.Загружено  = ПолностьюСобран;
		ОбластьЗаказыРейса.Параметры.НеВсеМеста = ЧастичноСобран;
		ОбластьЗаказыРейса.Параметры.НеНайдено  = НеСобран;
		ОбластьЗаказыРейса.Параметры.СобраноБольше  = СобраноБольше;
		
		ТабличныйДокумент.Вывести(ОбластьЗаказыРейса);
		
		ОбластьПодвал.Параметры.ДатаСейчас = "Сформировано и распечатано: " + Строка(ТекущаяДата());
		ОбластьПодвал.Параметры.НадписьОтпущено = ОбщегоНазначения.СформироватьСуммуПрописью2(ВыборкаПоРейсам.СуммаЗаказовПоРейсу);
		ОбластьПодвал.Параметры.ШтрихкодНенайденныхЗаказов = may.ПолучитьШКCode_39(ОбщегоНазначения.СформироватьШтрихкодНенайденныхЗаказов());
		ТабличныйДокумент.Вывести(ОбластьПодвал);
		
		ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		
		
	КонецЦикла;
	
	Если Рейс = Неопределено Тогда
		Возврат Новый Структура("ТабличныйДокумент,ДанныеЗаказовКОтвязке",ТабличныйДокумент,ДанныеЗаказовКОтвязке);
	Иначе	
		Возврат ТабличныйДокумент;
	КонецЕсли;	
	
КонецФункции


// Задача № 3201
Процедура ОтправитьСтатусыЗаказовРейса(Рейс) Экспорт 
	
	Если НачалоДня(Рейс.ДатаРейса) <> НачалоДня(ТекущаяДата()) Тогда
		Возврат;
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	//Асеев 16.04.2021 (Задача № 4541)>>>
	//Запрос.Текст = 
	//"ВЫБРАТЬ
	//|	РейсЗаказы.Заказ КАК Заказ,
	//|	РейсЗаказы.Ссылка КАК ДокументРегистратор
	//|ПОМЕСТИТЬ ВТ_ЗаказыРейса
	//|ИЗ
	//|	Документ.Рейс.Заказы КАК РейсЗаказы
	//|ГДЕ
	//|	НЕ РейсЗаказы.УдаленИзРейса
	//|	И РейсЗаказы.Ссылка = &Рейс
	//|	И РейсЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	//|;
	//|
	//|////////////////////////////////////////////////////////////////////////////////
	//|ВЫБРАТЬ
	//|	ЗагрузкаСТСДШтрихкоды.Ссылка КАК ЗагрузкаСТСД,
	//|	ЗагрузкаСТСДШтрихкоды.Заказ КАК Заказ
	//|ПОМЕСТИТЬ ВТ_Загрузки
	//|ИЗ
	//|	Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	//|ГДЕ
	//|	ЗагрузкаСТСДШтрихкоды.Заказ В
	//|			(ВЫБРАТЬ
	//|				ВТ_ЗаказыРейса.Заказ
	//|			ИЗ
	//|				ВТ_ЗаказыРейса КАК ВТ_ЗаказыРейса)
	//|;
	//|
	//|////////////////////////////////////////////////////////////////////////////////
	//|ВЫБРАТЬ
	//|	ВТ_ЗаказыРейса.Заказ КАК Заказ,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор КАК ДокументРегистратор,
	//|	ВТ_ЗаказыРейса.Заказ.Номер КАК НомерЗаказа,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор.ТерминалДоставки КАК Терминал,
	//|	221 КАК Статус,
	//|	ЛОЖЬ КАК ПредварительноеЗакрытие,
	//|	ВТ_ЗаказыРейса.Заказ КАК Реализация,
	//|	ВТ_ЗаказыРейса.Заказ.Номер КАК Номер,
	//|	ЛОЖЬ КАК БылоЗакрытие,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор.ТерминалДоставки.Код КАК КодТерминала,
	//|	МАКСИМУМ(ВТ_Загрузки.ЗагрузкаСТСД) КАК ЗагрузкаСТСД
	//|ИЗ
	//|	ВТ_ЗаказыРейса КАК ВТ_ЗаказыРейса
	//|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Загрузки КАК ВТ_Загрузки
	//|		ПО ВТ_ЗаказыРейса.Заказ = ВТ_Загрузки.Заказ
	//|ГДЕ
	//|	НЕ ВТ_Загрузки.ЗагрузкаСТСД ЕСТЬ NULL
	//|
	//|СГРУППИРОВАТЬ ПО
	//|	ВТ_ЗаказыРейса.Заказ,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор,
	//|	ВТ_ЗаказыРейса.Заказ.Номер,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор.ТерминалДоставки,
	//|	ВТ_ЗаказыРейса.ДокументРегистратор.ТерминалДоставки.Код,
	//|	ВТ_ЗаказыРейса.Заказ,
	//|	ВТ_ЗаказыРейса.Заказ.Номер";
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РеализацияТоваровУслуг.Номер КАК НомерЗаказа,
	|	РеализацияТоваровУслуг.Ссылка КАК Заказ,
	|	РеализацияТоваровУслуг.Номер КАК Номер,
	|	РейсЗаказы.Ссылка.ТерминалДоставки КАК Терминал,
	|	РейсЗаказы.Ссылка.ТерминалДоставки.Код КАК КодТерминала,
	|	221 КАК Статус,
	|	РейсЗаказы.Ссылка КАК ДокументРегистратор,
	|	ЛОЖЬ КАК ПредварительноеЗакрытие,
	|	РеализацияТоваровУслуг.Ссылка КАК Реализация,
	|	ЛОЖЬ КАК БылоЗакрытие
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ПО (РейсЗаказы.Ссылка = &Рейс)
	|			И (НЕ РейсЗаказы.УдаленИзРейса)
	|			И РейсЗаказы.Заказ = РеализацияТоваровУслуг.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаборТовара.Номер,
	|	ЗаборТовара.Ссылка,
	|	ЗаборТовара.Номер,
	|	РейсЗаказы.Ссылка.ТерминалДоставки,
	|	РейсЗаказы.Ссылка.ТерминалДоставки.Код,
	|	221,
	|	РейсЗаказы.Ссылка,
	|	ЛОЖЬ,
	|	ЗаборТовара.Ссылка,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.Рейс.Заказы КАК РейсЗаказы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаборТовара КАК ЗаборТовара
	|		ПО (РейсЗаказы.Ссылка = &Рейс)
	|			И (НЕ РейсЗаказы.УдаленИзРейса)
	|			И РейсЗаказы.Заказ = ЗаборТовара.Ссылка";
	
	Запрос.УстановитьПараметр("Рейс", Рейс);
	
	//РезультатЗапроса = Запрос.Выполнить();
	//ТаблицаДанных = РезультатЗапроса.Выгрузить();
	//
	//ТаблицаДанных.Свернуть("НомерЗаказа, Заказ, Номер, Терминал, КодТерминала, Статус, ДокументРегистратор, ПредварительноеЗакрытие, Реализация, Терминал, БылоЗакрытие");
	ТаблицаДанных = Запрос.Выполнить().Выгрузить();
	//Асеев 16.04.2021 (Задача № 4541)<<<
	
	МассивСтатусов = Неопределено;
	Счетчик = 0;
	Для Каждого Стр Из ТаблицаДанных Цикл
		Счетчик = Счетчик + 1;
		
		ДопПараметрыСтатуса = mas.ДобавитьДополнительныйПараметрСтатуса("ProcessingTerminal", Число(Стр.КодТерминала)); // Задача № 3027
		МассивСтатусов = mas.ДобавитьПараметрыЗаказаДляУстановкиСтатуса(Стр.Номер, Стр.Статус, "регламент уехало на доставку",,,МассивСтатусов,ДопПараметрыСтатуса);
		
	КонецЦикла;
	
	Если ПараметрыСеанса.ЭтоТестоваяСреда Тогда
		ФайлДляКонтроля = Неопределено;
		// для теста 
		//ФайлДляКонтроля = "D:\tmp\test_221_" + СокрЛП(новый УникальныйИдентификатор()) + ".json";
	Иначе	
		ФайлДляКонтроля = Неопределено;
	КонецЕсли;
	
	СтруктураВозврата = mas.ОтправитьМассивСтатусовЗаказов(МассивСтатусов,,ФайлДляКонтроля);
	
	РаботаСоСтатусамиЗаказовСервер.СохранитьСтатусы(ТаблицаДанных);
	
КонецПроцедуры	
// Задача № 3201
