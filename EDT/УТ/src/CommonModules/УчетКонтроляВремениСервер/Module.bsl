Функция ПроверитьСостояниеСобытия(Событие, Рейс = Неопределено, Терминал = Неопределено, ДатаНачалаСобытия = Неопределено) Экспорт
	Если Рейс = Неопределено Тогда 
		Рейс = Документы.Рейс.ПустаяСсылка();
	КонецЕсли;
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КонтрольВремениСрезПоследних.Период КАК Период,
		|	КонтрольВремениСрезПоследних.ОкончаниеСобытия КАК ОкончаниеСобытия
		|ИЗ
		|	РегистрСведений.КонтрольВремени.СрезПоследних КАК КонтрольВремениСрезПоследних
		|ГДЕ
		|	КонтрольВремениСрезПоследних.Рейс = &Рейс
		|	И КонтрольВремениСрезПоследних.Терминал = &Терминал
		|	И КонтрольВремениСрезПоследних.Событие = &Событие";
	
	Запрос.УстановитьПараметр("Рейс", Рейс);
	Запрос.УстановитьПараметр("Событие", Событие);
	Запрос.УстановитьПараметр("Терминал", Терминал);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		ДатаНачалаСобытия = ВыборкаДетальныеЗаписи.Период;
		Возврат  ВыборкаДетальныеЗаписи.ОкончаниеСобытия;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции	


// Реализовать запись событий в БД по триггерам
Процедура ЗаписатьРСКонтрольВремени(Событие, Рейс, ОкончаниеСобытия, Период = Неопределено, Контрагент = Неопределено, Терминал = Неопределено, ДатаРейсов = Неопределено) Экспорт
	
	Если Период = Неопределено ИЛИ Период = Дата("01.01.0001 0:00:00") тогда
		Период = ТекущаяДата();
	КонецЕсли;
	ВыбранныйРегистратор = Документы.РегистрацияСобытияКонтроляВремени.СоздатьДокумент();
	ВыбранныйРегистратор.Дата = Период;
	ВыбранныйРегистратор.Событие = Событие;
	ВыбранныйРегистратор.Рейс = Рейс;
	ВыбранныйРегистратор.Контрагент = Контрагент;
	ВыбранныйРегистратор.ОкончаниеСобытия = ОкончаниеСобытия;
	ВыбранныйРегистратор.ДатаРейсов = ДатаРейсов;
	
	ВыбранныйРегистратор.Пользователь = ПараметрыСеанса.ТекущийПользователь;
	Попытка
		ВыбранныйРегистратор.РабочееМесто = ПараметрыСеанса.РабочееМесто;
	Исключение
		
	КонецПопытки;	
	// МАС - 05.06.2017 - №972 --->> 	 
	ВыбранныйРегистратор.Терминал = ?(ЗначениеЗаполнено(рейс), Рейс.ТерминалДоставки, Терминал);
	// <<--- МАС
	ВыбранныйРегистратор.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
	
КонецПроцедуры


//Процедура ЗаписатьРСКонтрольВремени(Событие, Рейс, ОкончаниеСобытия, Период = Неопределено, Контрагент = Неопределено, Терминал = Неопределено) Экспорт
//	
//	Если Период = Неопределено ИЛИ Период = Дата("01.01.0001 0:00:00") тогда
//		Период = ТекущаяДата();
//	КонецЕсли;
//	ВыбранныйРегистратор = Документы.РегистрацияСобытияКонтроляВремени.СоздатьДокумент();
//	ВыбранныйРегистратор.Дата = Период;
//	ВыбранныйРегистратор.Событие = Событие;
//	ВыбранныйРегистратор.Рейс = Рейс;
//	ВыбранныйРегистратор.Контрагент = Контрагент;
//	ВыбранныйРегистратор.ОкончаниеСобытия = ОкончаниеСобытия;
//	ВыбранныйРегистратор.Пользователь = ПараметрыСеанса.ТекущийПользователь;
//	ВыбранныйРегистратор.РабочееМесто = ПараметрыСеанса.РабочееМесто;
//	// МАС - 05.06.2017 - №972 --->> 	 
//	ВыбранныйРегистратор.Терминал = ?(ЗначениеЗаполнено(рейс), Рейс.ТерминалДоставки, Терминал);
//	// <<--- МАС
//	ВыбранныйРегистратор.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
//	
//КонецПроцедуры
						
Процедура ЗаписатьСобытиеОбновлениеИсторииДанных(Период, ОкончаниеСобытия) Экспорт
	Событие = Справочники.СобытияКонтроляВремени.ОбновлениеИсторииДанных;
	ЗаписатьРСКонтрольВремени(Событие, Неопределено, ОкончаниеСобытия, Период, "", "");
КонецПроцедуры						


Функция РейсАктивен(Рейс) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	КонтрольВремени.Событие КАК Событие
	               |ИЗ
	               |	РегистрСведений.КонтрольВремени КАК КонтрольВремени
	               |ГДЕ
	               |	КонтрольВремени.Рейс = &Рейс
	               |	И КонтрольВремени.Событие = ЗНАЧЕНИЕ(Справочник.СобытияКонтроляВремени.РаспечаткаМаршрутногоЛиста)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КонтрольВремени.Событие КАК Событие
	               |ИЗ
	               |	РегистрСведений.КонтрольВремени КАК КонтрольВремени
	               |ГДЕ
	               |	КонтрольВремени.Рейс = &Рейс
	               |	И КонтрольВремени.Событие = ЗНАЧЕНИЕ(Справочник.СобытияКонтроляВремени.ЗакрытиеРейсаЛогист)";
	Запрос.УстановитьПараметр("Рейс",Рейс);
	МассивРезультатов = Запрос.ВыполнитьПакет();
	Возврат Не МассивРезультатов[0].Пустой() И МассивРезультатов[1].Пустой() 
КонецФункции	
