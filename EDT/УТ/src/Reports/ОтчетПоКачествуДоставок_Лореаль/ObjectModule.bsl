
Функция СформироватьОтправитьПоПочте(Период, Контрагент = Неопределено) Экспорт
	
	//Форма = Получитьформу("Отчет.ОтчетКонтроляВремени.Форма.ФормаОтчета");
	//Возврат СформироватьОтчет(ДобавитьМесяц(Период, -1), Справочники.Контрагенты.НайтиПоКоду("Shop_618"));
	Возврат СформироватьОтчет(Период, ?(ЗначениеЗаполнено(Контрагент), Контрагент, Справочники.Контрагенты.НайтиПоКоду("Shop_618")));
	
КонецФункции

//&НаСервере
Функция СформироватьОтчет(ДатаС, Контрагент) Экспорт
	
	Табл = Новый ТабличныйДокумент;
	Макет = Отчеты.ОтчетПоКачествуДоставок_Лореаль.ПолучитьМакет("Макет");
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	МИНИМУМ(ИзменениеДатыДоставки.ДатаДоставки) КАК ПлановаяДатаДоставки,
	               |	ИзменениеДатыДоставки.Доставка.Номер
	               |ПОМЕСТИТЬ ВТ_ПланируемаДата
	               |ИЗ
	               |	Документ.ИзменениеДатыДоставки КАК ИзменениеДатыДоставки
	               |ГДЕ
	               |	ИзменениеДатыДоставки.Дата МЕЖДУ ДОБАВИТЬКДАТЕ(&ДатаНач, ДЕНЬ, -30) И &ДатаКон
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ИзменениеДатыДоставки.Доставка.Номер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СостоянияЗаказов.ПричинаНеВыполнения,
	               |	ВЫБОР
	               |		КОГДА ТИПЗНАЧЕНИЯ(СостоянияЗаказов.Регистратор) = ТИП(Документ.ИзменениеДатыДоставки)
	               |				И СостоянияЗаказов.ПричинаОтказа = ЗНАЧЕНИЕ(Справочник.ПричиныОтказаПереноса.ПустаяСсылка)
	               |			ТОГДА &ПоВине
	               |		ИНАЧЕ СостоянияЗаказов.ПричинаОтказа
	               |	КОНЕЦ КАК ПричинаОтказа,
	               |	СостоянияЗаказов.Заказ.Ссылка,
	               |	СостоянияЗаказов.Заказ.Номер КАК НомерЗаказаСтриж,
	               |	СостоянияЗаказов.Заказ.НомерВнешнегоЗаказа КАК НомерЗаказа,
	               |	СостоянияЗаказов.Заказ.ТерминалДоставки КАК ТерминалДоставки,
	               |	СостоянияЗаказов.Заказ.Грузополучатель КАК ФИОКлиента,
	               |	СостоянияЗаказов.Доставка.Адрес КАК АдресДоставки,
	               |	СостоянияЗаказов.Период КАК ДатаПереноса
	               |ПОМЕСТИТЬ ВТ_Основная
	               |ИЗ
	               |	РегистрСведений.СостоянияЗаказов КАК СостоянияЗаказов
	               |ГДЕ
	               |	СостоянияЗаказов.Заказ.ПометкаУдаления = ЛОЖЬ
	               |	И СостоянияЗаказов.РезультатДоставки = ЗНАЧЕНИЕ(Справочник.новаРезультатМестнойДоставки.НеВыполнена)
	               |	И СостоянияЗаказов.Период МЕЖДУ &ДатаНач И &ДатаКон
	               |	И (СостоянияЗаказов.Заказ.ВладелецТовара = &ВладелецТовара
	               |			ИЛИ СостоянияЗаказов.Заказ.ВладелецТовара.Родитель.ОсновнойМагазин = &ВладелецТовара)
	               |	И (ТИПЗНАЧЕНИЯ(СостоянияЗаказов.Регистратор) = ТИП(Документ.ИзменениеДатыДоставки)
	               |			ИЛИ ТИПЗНАЧЕНИЯ(СостоянияЗаказов.Регистратор) = ТИП(Документ.новаОтчетВодителя))
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЗагрузкаСТСДШтрихкоды.Заказ,
	               |	МИНИМУМ(ЗагрузкаСТСДШтрихкоды.Ссылка.Дата) КАК ДатаОтгрузкиЗаказаСоСклада
	               |ПОМЕСТИТЬ ВТ_ДатаОтгрузки
	               |ИЗ
	               |	Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |ГДЕ
	               |	(ВЫРАЗИТЬ(ЗагрузкаСТСДШтрихкоды.Заказ КАК Документ.РеализацияТоваровУслуг).ВладелецТовара = &ВладелецТовара
	               |			ИЛИ ВЫРАЗИТЬ(ЗагрузкаСТСДШтрихкоды.Заказ КАК Документ.РеализацияТоваровУслуг).ВладелецТовара.Родитель.ОсновнойМагазин = &ВладелецТовара)
	               |	И ЗагрузкаСТСДШтрихкоды.Ссылка.Дата МЕЖДУ ДОБАВИТЬКДАТЕ(&ДатаНач, ДЕНЬ, -30) И &ДатаКон
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЗагрузкаСТСДШтрихкоды.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_Основная.ПричинаОтказа,
	               |	ВТ_Основная.ДатаПереноса КАК ДатаПереноса,
	               |	ВТ_Основная.ПричинаНеВыполнения,
	               |	ВТ_ПланируемаДата.ПлановаяДатаДоставки КАК ПлановаяДатаДоставки,
	               |	ЗакрытыеЗаказы.Период КАК ФактическаяДатаДоставки,
	               |	ВТ_ДатаОтгрузки.ДатаОтгрузкиЗаказаСоСклада,
	               |	ВТ_Основная.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ЗакрытыеЗаказы.СтатусЗаказа,
	               |	ВТ_Основная.НомерЗаказа КАК НомерЗаказа,
	               |	ВТ_Основная.ТерминалДоставки,
	               |	ВТ_Основная.ФИОКлиента,
	               |	ВТ_Основная.АдресДоставки КАК АдресДоставки
	               |ИЗ
	               |	ВТ_Основная КАК ВТ_Основная
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДатаОтгрузки КАК ВТ_ДатаОтгрузки
	               |		ПО ВТ_Основная.ЗаказСсылка = ВТ_ДатаОтгрузки.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПланируемаДата КАК ВТ_ПланируемаДата
	               |		ПО ВТ_Основная.НомерЗаказаСтриж = ВТ_ПланируемаДата.ДоставкаНомер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗакрытыеЗаказы КАК ЗакрытыеЗаказы
	               |		ПО ВТ_Основная.ЗаказСсылка = ЗакрытыеЗаказы.Реализация
	               |ГДЕ
	               |	ТИПЗНАЧЕНИЯ(ЗакрытыеЗаказы.Регистратор) = ТИП(Документ.ЗакрытиеЗаказов)
	               |	И ВТ_ПланируемаДата.ПлановаяДатаДоставки < &ДатаКон
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НомерЗаказа,
	               |	ДатаПереноса
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("ДатаНач", НачалоМесяца(ДатаС));
	Запрос.УстановитьПараметр("ДатаКон", КонецМесяца(ДатаС));
	Запрос.УстановитьПараметр("ПоВине", "По вине контрагента");
	Запрос.УстановитьПараметр("ВладелецТовара", Контрагент);
	
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока = Макет.ПолучитьОбласть("Строка");
	П = ОбластьСтрока.Параметры;
	Табл.Вывести(ОбластьШапка);
	Номер = 0;
	Заказ = Неопределено;
	Пока Рез.Следующий() Цикл
		Если Заказ <> Рез.НомерЗаказа Тогда
			Если Номер <> 0 Тогда
				Табл.Вывести(ОбластьСтрока);	
			КонецЕсли;
			Заказ = Рез.НомерЗаказа;
			Номер = Номер + 1;
			П.Номер = Номер;
			П.НомерЗаказа = Заказ;
			П.НомерЗаказаСтриж = Рез.НомерЗаказаСтриж;
			П.ТерминалДоставки = Рез.ТерминалДоставки;
			П.АдресДоставки = Рез.АдресДоставки;
			П.ФИОКлиента = Рез.ФИОКлиента;
			П.ПлановаяДатаДоставки = Формат(Рез.ПлановаяДатаДоставки, "ДЛФ=Д");
			П.ДатаОтгрузкиЗаказаСоСклада = Формат(Рез.ДатаОтгрузкиЗаказаСоСклада, "ДЛФ=Д");
			П.ФактическаяДатаДоставки = Формат(Рез.ФактическаяДатаДоставки, "ДЛФ=Д");
			П.СтатусЗаказа = Рез.СтатусЗаказа;
		    П.Причина = Формат(Рез.ДатаПереноса, "ДЛФ=Д") + " "
				+ Рез.ПричинаНеВыполнения + "/" + Рез.ПричинаОтказа;
		Иначе
			П.Причина = П.Причина + Символы.ПС + Формат(Рез.ДатаПереноса, "ДЛФ=Д") + " "
				+ Рез.ПричинаНеВыполнения + "/" + Рез.ПричинаОтказа;	
		КонецЕсли;		
	КонецЦикла;
	Табл.Вывести(ОбластьСтрока);
	
	Табл.АвтоМасштаб = Истина;	
	Табл.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	Возврат Табл;
	
КонецФункции
