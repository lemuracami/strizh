
Функция СформироватьИзРМК(Рейс) Экспорт
    Таб = Новый ТабличныйДокумент();
	
	Макет = ПолучитьМакет("Макет");
	
	ОбластьШапка	 	= Макет.ПолучитьОбласть("Шапка");
	ОбластьРейс	     	= Макет.ПолучитьОбласть("ОбластьРейс");
	ОбластьВидДанных	= Макет.ПолучитьОбласть("ОбластьВидДанных");
	ОбластьПартнер   	= Макет.ПолучитьОбласть("ОбластьПартнер");
	ОбластьЗаказНормальный 	= Макет.ПолучитьОбласть("ОбластьЗаказ");
	ОбластьЗаказЗачеркнутый = Макет.ПолучитьОбласть("ОбластьЗаказЗачеркнутый");
	ОбластьНоменклатура = Макет.ПолучитьОбласть("ОбластьШКТовара");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОбластьШапка.Параметры.Рейс = Рейс;
	Таб.Вывести(ОбластьШапка);
	
	//СобираемПараметры
	Терминал = ?(ЗначениеЗаполнено(ПараметрыСеанса.ТерминалДоставки), ПараметрыСеанса.ТерминалДоставки, Справочники.РегиональныеТерминалы.МоскваСтриж);
	ВыбЭтап = Справочники.новаЭтапыМестнойДоставки.ПланированиеМестнойДоставки;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапроса();
	
	Запрос.УстановитьПараметр("ТерминалДоставки", Терминал);
	Запрос.УстановитьПараметр("ВыбЭтап", ВыбЭтап);
	Запрос.УстановитьПараметр("Рейс", Рейс);
	Запрос.УстановитьПараметр("НачДата", Рейс.Дата);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаРейс = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"Рейс");
	
	Пока ВыборкаРейс.Следующий() Цикл
		ОбластьРейс.Параметры.Рейс = lem.глСформироватьБарКодEAN13(ОбщегоНазначения.СформироватьШтрихкодРейса(ВыборкаРейс.РейсМД));
		ОбластьРейс.Параметры.ДатаРейса = ВыборкаРейс.ДатаРейса;
		ОбластьРейс.Параметры.Водитель = ВыборкаРейс.Водитель;
		ОбластьРейс.Параметры.Экспедитор = ВыборкаРейс.Экспедитор;
		ОбластьРейс.Параметры.Транспорт = ВыборкаРейс.Транспорт;
		ОбластьРейс.Параметры.НомерСклад = "Акт приема- передачи №" + Строка(ВыборкаРейс.НомерСклад);
		ОбластьРейс.Параметры.Количество = ВыборкаРейс.КоличествоЗаказов;
		ОбластьРейс.Параметры.Сумма = ВыборкаРейс.Сумма;
		
		СуммаПоТранспорту = ВыборкаРейс.Сумма;

		Таб.Вывести(ОбластьРейс);
		
		ВыборкаВидДанных = ВыборкаРейс.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"ВидДанных");
		
		Пока ВыборкаВидДанных.Следующий() Цикл
			
			ОбластьВидДанных.Параметры.ВидДанных = ВыборкаВидДанных.ВидДанных;
			Таб.Вывести(ОбластьВидДанных);
			
			ВыборкаИнтернетМагазин = ВыборкаВидДанных.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"ИнтернетМагазин");
			
			Пока ВыборкаИнтернетМагазин.Следующий() Цикл
				
				ОбластьПартнер.Параметры.НаименованиеПартнера = ВыборкаИнтернетМагазин.ИнтернетМагазин;
				ОбластьПартнер.Параметры.КоличествоЗаказов = ВыборкаИнтернетМагазин.КоличествоЗаказов;
				Таб.Вывести(ОбластьПартнер);
				
				ВыборкаЗаказ = ВыборкаИнтернетМагазин.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"Заказ");
				
				Пока ВыборкаЗаказ.Следующий() Цикл
					
					Если НЕ ВыборкаЗаказ.ЗаказВРейсе Тогда
						ОбластьЗаказ = ОбластьЗаказЗачеркнутый;
						ОбластьЗаказ.Параметры.СервиснаяНадпись = "ЗАКАЗ НЕ В РЕЙСЕ!!!";
					Иначе
						ОбластьЗаказ = ОбластьЗаказНормальный;
					КонецЕсли;
					
					//Выбираем МП  УЗ /дата/ транспорт/водитель/экспедитор
					ЗапросМП = Новый Запрос;
					ЗапросМП.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
					                 |	ОтчетПоТоварамМПТовары.Ссылка.Дата КАК Дата,
					                 |	ОтчетПоТоварамМПТовары.Ссылка.Транспорт КАК Транспорт,
					                 |	ОтчетПоТоварамМПТовары.Ссылка.МП КАК УЗ
					                 |ИЗ
					                 |	Документ.ОтчетПоТоварамМП.Товары КАК ОтчетПоТоварамМПТовары
					                 |ГДЕ
					                 |	ОтчетПоТоварамМПТовары.Заказ = &Заказ
					                 |
					                 |ОБЪЕДИНИТЬ ВСЕ
					                 |
					                 |ВЫБРАТЬ РАЗЛИЧНЫЕ
					                 |	ОтчетПоДСМПДС.Ссылка.Дата,
					                 |	ОтчетПоДСМПДС.Ссылка.Транспорт,
					                 |	ОтчетПоДСМПДС.Ссылка.МП
					                 |ИЗ
					                 |	Документ.ОтчетПоДСМП.ДС КАК ОтчетПоДСМПДС
					                 |ГДЕ
					                 |	ОтчетПоДСМПДС.Заказ = &Заказ";
					
					ЗапросМП.УстановитьПараметр("Заказ", ВыборкаЗаказ.Заказ);
					
					РезультатМП = ЗапросМП.Выполнить();
					ВыборкаМП = РезультатМП.Выбрать();
					
					Если ВыборкаМП.Следующий() Тогда 
						СтУЗ = Строка(ВыборкаМП.УЗ);
						СтТранспорт = Строка(ВыборкаМП.Транспорт);
						СтДата = Строка(ВыборкаМП.Дата);
						СтВодитель = Строка(ВыборкаРейс.Водитель);
						СтЭкспедитор = Строка(ВыборкаРейс.Экспедитор);
						ОбластьЗаказ.Параметры.СервиснаяНадпись ="УДАЛЕННОЕ ЗАКРЫТИЕ: " + СтУЗ +" / " + СтДата +" / " + СтТранспорт +" / " +СтВодитель +" / " +СтЭкспедитор;
					Иначе
						ОбластьЗаказ.Параметры.СервиснаяНадпись = "";
					КонецЕсли;

					
					ЗапросМеста = Новый Запрос;
					ЗапросМеста.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	РейсЗаказы.Заказ КАК Заказ,
					|	МестаПоЗаказам.Штрихкод КАК Штрихкод,
					|	ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.КоличествоМест, 0) КАК КоличествоМест,
					|	ВЫБОР
					|		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.КоличествоМест, ИСТИНА) = ИСТИНА
					|			ТОГДА ""Не собран ШК""
					|		ИНАЧЕ ""Да собран ШК""
					|	КОНЕЦ КАК Собран
					|ИЗ
					|	Документ.Рейс.Заказы КАК РейсЗаказы
					|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаПоЗаказам КАК МестаПоЗаказам
					|		ПО РейсЗаказы.Заказ = МестаПоЗаказам.Заказ
					|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
					|		ПО РейсЗаказы.Заказ = ЗагрузкаСТСДШтрихкоды.Заказ
					|ГДЕ
					|	РейсЗаказы.Заказ = &Заказ";
					
					ЗапросМеста.УстановитьПараметр("Заказ", ВыборкаЗаказ.Заказ);
					
					РезультатМеста = ЗапросМеста.Выполнить();
					ВыборкаМест = РезультатМеста.Выгрузить();
					
					Если ВыборкаМест.Количество() > 0 Тогда 
						ЕстьМеста = Истина;
						КоличествоМест = ВыборкаМест.Итог("КоличествоМест");
					Иначе 
						ЕстьМеста = Ложь;
						КоличествоМест = 0;
					КонецЕсли;
					
					//Перенос заказа
					ЗапросПеренос = Новый Запрос;
					ЗапросПеренос.Текст = "ВЫБРАТЬ
					                      |	СостоянияЗаказовСрезПоследних.Заказ КАК Заказ
					                      |ИЗ
					                      |	РегистрСведений.СостоянияЗаказов.СрезПоследних(&Дата, ) КАК СостоянияЗаказовСрезПоследних
					                      |ГДЕ
					                      |	СостоянияЗаказовСрезПоследних.Доставка.Номер = &Номер
					                      |	И СостоянияЗаказовСрезПоследних.ПричинаНеВыполнения = ЗНАЧЕНИЕ(справочник.причиныневыполнениядоставки.переносдоставки)";
					
					ЗапросПеренос.УстановитьПараметр("Номер", ВыборкаЗаказ.НомерЗаказаСтриж);
					ЗапросПеренос.УстановитьПараметр("Дата", ВыборкаРейс.ДатаРейса);
					
					РезультатПеренос = ЗапросПеренос.Выполнить();
					ВыборкаПеренос = РезультатПеренос.Выгрузить();
					
					Если ВыборкаПеренос.Количество() > 1 Тогда 
						ЕстьПеренос = Истина;
					Иначе 
						ЕстьПеренос = Ложь;
					КонецЕсли;

					
					
					ПолныйНомерЗаказа = ОбщегоНазначения.СформироватьПолныйНомерЗаказаСПереносом(ВыборкаЗаказ.НомерЗаказаСтриж,ВыборкаЗаказ.НомерВнешнегоЗаказа, ЕстьПеренос,ВыборкаЗаказ.Количество,ВыборкаЗаказ.КоличествоМест);
					ОбластьЗаказ.Параметры.ПолныйНомерЗаказа = ПолныйНомерЗаказа;
					ОбластьЗаказ.Параметры.БылНаТСД = ВыборкаЗаказ.ЕстьНаТСД;
					ОбластьЗаказ.Параметры.ДатаНаТСД = ВыборкаЗаказ.ДатаВремяНаТСД;
					Если ВыборкаЗаказ.Количество = 0 Тогда
						ОбластьЗаказ.Параметры.КоличествоМестЗаказа = "НЕТ мест в заказе";
					Иначе	
						ОбластьЗаказ.Параметры.КоличествоМестЗаказа = Строка(ВыборкаЗаказ.Количество) + " мест заказа" ;
					КонецЕсли;	
					
					Если ВыборкаЗаказ.КоличествоМест = 0 Тогда
						ОбластьЗаказ.Параметры.КоличествоМестСобрано = "НЕТ собраных мест";
					Иначе	
						ОбластьЗаказ.Параметры.КоличествоМестСобрано = Строка(ВыборкаЗаказ.КоличествоМест) + " мест собрано" ;
					КонецЕсли;	
					
					ОбластьЗаказ.Параметры.СтоимостьЗаказа = ВыборкаЗаказ.Сумма;
					Таб.Вывести(ОбластьЗаказ);
					
					Если ВыборкаЗаказ.КоличествоМест = ВыборкаЗаказ.Количество Тогда
						Продолжить;
					КонецЕсли;	
					
					Если ЕстьМеста Тогда
						Для каждого Элем Из ВыборкаМест Цикл
							ОбластьНоменклатура.Параметры.НаименованиеТовараСобранШК = Элем.Собран;
							ОбластьНоменклатура.Параметры.АртикулШКТовараШКМеста = Элем.Штрихкод;
							Таб.Вывести(ОбластьНоменклатура);
						КонецЦикла;	
					Иначе	
						ЗапросНоменклатуры = Новый Запрос;
						ЗапросНоменклатуры.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
						                           |	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
						                           |	РеализацияТоваровУслугТовары.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
						                           |	РеализацияТоваровУслугТовары.Номенклатура.Артикул КАК Артикул
						                           |ИЗ
						                           |	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
						                           |ГДЕ
						                           |	РеализацияТоваровУслугТовары.Ссылка.Ссылка = &Ссылка
						                           |
						                           |УПОРЯДОЧИТЬ ПО
						                           |	РеализацияТоваровУслугТовары.Номенклатура.Наименование";
						
						ЗапросНоменклатуры.УстановитьПараметр("Ссылка", ВыборкаЗаказ.Заказ);
						
						РезультатНоменклатуры = ЗапросНоменклатуры.Выполнить();
						ВыборкаНоменклатура = РезультатНоменклатуры.Выбрать();
						
						Пока ВыборкаНоменклатура.Следующий() Цикл
							ОбластьНоменклатура.Параметры.НаименованиеТовараСобранШК = ВыборкаНоменклатура.Номенклатура;
							ОбластьНоменклатура.Параметры.АртикулШКТовараШКМеста = Строка(ВыборкаНоменклатура.Артикул) + " / "+ Строка(ВыборкаНоменклатура.ШтрихкодНоменклатуры);
							Таб.Вывести(ОбластьНоменклатура);
						КонецЦикла;
					КонецЕсли;
				КонецЦикла;
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЦикла;
	
	ОбластьПодвал.Параметры.ДатаСейчас = "Сформировано и распечатано: " + Строка(ТекущаяДата());
	ОбластьПодвал.Параметры.НадписьОтпущено = ОбщегоНазначения.СформироватьСуммуПрописью2(СуммаПоТранспорту);
	ОбластьПодвал.Параметры.ШтрихкодНенайденныхЗаказов = may.ПолучитьШКCode_39(ОбщегоНазначения.СформироватьШтрихкодНенайденныхЗаказов());
	Таб.Вывести(ОбластьПодвал);
	
	Таб.АвтоМасштаб = Истина;
	
	Возврат Таб;
КонецФункции	

Функция ПолучитьТекстЗапроса()
	
	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	РейсЗаказы.Заказ.Ссылка КАК Заказ,
	               |	РейсЗаказы.Ссылка.Ссылка КАК Рейс
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы0
	               |ИЗ
	               |	Документ.Рейс.Заказы КАК РейсЗаказы
	               |ГДЕ
	               |	РейсЗаказы.Ссылка.Ссылка = &Рейс
	               |	И РейсЗаказы.Заказ.Ссылка ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоЗаказы.Заказ.Ссылка,
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |ГДЕ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_ВсеЗаказы0.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы0.Рейс КАК Рейс,
	               |	МАКСИМУМ(РейсЗаказы.УдаленИзРейса) КАК УдаленИзРейса,
	               |	МИНИМУМ(НЕ ЕСТЬNULL(РейсЗаказы.УдаленИзРейса, ИСТИНА)) КАК ЗаказВРейсе,
	               |	МАКСИМУМ(НЕ ПогрузкаВАвтоЗаказы.Ссылка.Ссылка ЕСТЬ NULL) КАК ВАвто,
	               |	МИНИМУМ(ВЫБОР
	               |			КОГДА ЕСТЬNULL(РейсЗаказы.УдаленИзРейса, ИСТИНА)
	               |				ТОГДА 0
	               |			ИНАЧЕ 1
	               |		КОНЕЦ) КАК КолЗаказов
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы0 КАК ВТ_ВсеЗаказы0
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = РейсЗаказы.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = ПогрузкаВАвтоЗаказы.Заказ
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_ВсеЗаказы0.Заказ,
	               |	ВТ_ВсеЗаказы0.Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ КАК ЕстьНаТСД,
	               |	МАКСИМУМ(ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.ДатаВремя, ""--"")) КАК ДатаВремяНаТСД,
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ
	               |ПОМЕСТИТЬ ВТ_ТСД
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |		ПО (ВТ_ВсеЗаказы.Заказ = ВЫРАЗИТЬ(ЗагрузкаСТСДШтрихкоды.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПривязкаМашинКРейсамСрезПоследних.Водитель КАК Водитель,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт КАК Транспорт,
	               |	ПривязкаМашинКРейсамСрезПоследних.Экспедитор КАК Экспедитор,
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс КАК Рейс
	               |ПОМЕСТИТЬ ВТ_Транспорт
	               |ИЗ
	               |	РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, ) КАК ПривязкаМашинКРейсамСрезПоследних
	               |ГДЕ
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ, ИСТИНА) <> ИСТИНА
	               |				ИЛИ ВТ_ВсеЗаказы.УдаленИзРейса
	               |			ТОГДА ""--НЕ МАРШРУТИЗИРОВАНО--""
	               |		ИНАЧЕ ""МАРШРУТИЗИРОВАНО""
	               |	КОНЕЦ КАК ВидДанных
	               |ПОМЕСТИТЬ ВТ_Маршрутизировано
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтклоненияСпискаЗаказовПриПогрузкеВАвто КАК ОтклоненияСпискаЗаказовПриПогрузкеВАвто
	               |		ПО ВТ_ВсеЗаказы.Заказ = ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ПогрузкаВАвтоЗаказы.КоличествоМест, ИСТИНА) = ИСТИНА
	               |			ТОГДА 0
	               |		ИНАЧЕ ПогрузкаВАвтоЗаказы.КоличествоМест
	               |	КОНЕЦ КАК КоличествоМест,
	               |	ВТ_ВсеЗаказы.Заказ.Ссылка КАК Заказ
	               |ПОМЕСТИТЬ ВТ_КоличествоМест
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы.Заказ.Ссылка = ПогрузкаВАвтоЗаказы.Заказ.Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер КАК НомерЗаказаСтриж,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара КАК ИнтернетМагазин,
	               |	РеализацияТоваровУслуг.СуммаДокумента КАК Сумма,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.КоличествоМест) КАК Количество,
	               |	ВТ_ВсеЗаказы.Рейс КАК Рейс,
	               |	ВТ_ВсеЗаказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Заказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара,
	               |	-ВозвратТоваровОтПокупателя.СуммаДокумента,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, ВТ_ВсеЗаказы.Заказ.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтПокупателя КАК ВозвратТоваровОтПокупателя
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |			ПО (РеализацияТоваровУслуг.Номер = ВозвратТоваровОтПокупателя.Номер)
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = ВозвратТоваровОтПокупателя.Номер)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	-РеализацияТоваровУслуг.Ссылка.ПредоплатаПоКредиту,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.ТипОплаты = 2
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	0,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.СтатусИнтернетМагазина = 4
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_Заказы.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Заказы.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Транспорт.Водитель КАК Водитель,
	               |	ВТ_Транспорт.Транспорт КАК Транспорт,
	               |	ВТ_Транспорт.Экспедитор КАК Экспедитор,
	               |	ВТ_ТСД.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Заказы.Заказ КАК Заказ,
	               |	ВТ_ТСД.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Заказы.Количество КАК Количество,
	               |	ВТ_Заказы.Сумма КАК Сумма,
	               |	ВТ_ВсеЗаказы.КолЗаказов КАК КоличествоЗаказов,
	               |	ВТ_КоличествоМест.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Заказы.Рейс КАК Рейс,
	               |	ВТ_Заказы.Рейс.НомерПалетты КАК НомерСклад,
	               |	ВТ_Заказы.Рейс.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Заказы.Рейс.РейсМестнойДоставки КАК РейсМД,
	               |	ВТ_Маршрутизировано.ВидДанных КАК ВидДанных,
	               |	ВТ_Заказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Финиш
	               |ИЗ
	               |	ВТ_Заказы КАК ВТ_Заказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТСД КАК ВТ_ТСД
	               |		ПО (ВТ_Заказы.Заказ = ВЫРАЗИТЬ(ВТ_ТСД.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Маршрутизировано КАК ВТ_Маршрутизировано
	               |		ПО ВТ_Заказы.Заказ = ВТ_Маршрутизировано.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ПО ВТ_Заказы.Заказ = ВТ_ВсеЗаказы.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КоличествоМест КАК ВТ_КоличествоМест
	               |		ПО ВТ_Заказы.Заказ = ВТ_КоличествоМест.Заказ,
	               |	ВТ_Транспорт КАК ВТ_Транспорт
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_Финиш.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель КАК Водитель,
	               |	ВТ_Финиш.Транспорт КАК Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ КАК Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор КАК Экспедитор,
	               |	ВТ_Финиш.Количество КАК Количество,
	               |	ВТ_Финиш.Сумма КАК Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов КАК КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Финиш.Рейс КАК Рейс,
	               |	ВТ_Финиш.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Финиш.НомерСклад КАК НомерСклад,
	               |	ВТ_Финиш.РейсМД КАК РейсМД,
	               |	ВТ_Финиш.ВидДанных КАК ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе КАК ЗаказВРейсе
	               |ИЗ
	               |	ВТ_Финиш КАК ВТ_Финиш
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_Финиш.Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор,
	               |	ВТ_Финиш.НомерЗаказаСтриж,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель,
	               |	ВТ_Финиш.Количество,
	               |	ВТ_Финиш.Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест,
	               |	ВТ_Финиш.Рейс,
	               |	ВТ_Финиш.ДатаРейса,
	               |	ВТ_Финиш.НомерСклад,
	               |	ВТ_Финиш.РейсМД,
	               |	ВТ_Финиш.ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВТ_Финиш.ВидДанных,
	               |	ВТ_Финиш.ИнтернетМагазин.Наименование,
	               |	ВТ_Финиш.Заказ.Номер
	               |ИТОГИ
	               |	МАКСИМУМ(НомерЗаказаСтриж),
	               |	МАКСИМУМ(НомерВнешнегоЗаказа),
	               |	МАКСИМУМ(Водитель),
	               |	МАКСИМУМ(Транспорт),
	               |	МАКСИМУМ(ЕстьНаТСД),
	               |	МАКСИМУМ(ДатаВремяНаТСД),
	               |	МАКСИМУМ(Экспедитор),
	               |	МАКСИМУМ(Количество),
	               |	СУММА(Сумма),
	               |	СУММА(КоличествоЗаказов),
	               |	МАКСИМУМ(КоличествоМест),
	               |	МАКСИМУМ(ДатаРейса),
	               |	МАКСИМУМ(НомерСклад),
	               |	МАКСИМУМ(РейсМД),
	               |	МАКСИМУМ(ЗаказВРейсе)
	               |ПО
	               |	Рейс,
	               |	ВидДанных,
	               |	ИнтернетМагазин,
	               |	Заказ";
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ПолучитьТекстЗапросаКопия2()
	
	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	РейсЗаказы.Заказ.Ссылка КАК Заказ,
	               |	РейсЗаказы.Ссылка.Ссылка КАК Рейс
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы0
	               |ИЗ
	               |	Документ.Рейс.Заказы КАК РейсЗаказы
	               |ГДЕ
	               |	РейсЗаказы.Ссылка.Ссылка = &Рейс
	               |	И РейсЗаказы.Заказ.Ссылка ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоЗаказы.Заказ.Ссылка,
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |ГДЕ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_ВсеЗаказы0.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы0.Рейс КАК Рейс,
	               |	РейсЗаказы.УдаленИзРейса КАК УдаленИзРейса,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(РейсЗаказы.УдаленИзРейса, ИСТИНА) = ИСТИНА
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ЗаказВРейсе,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ПогрузкаВАвтоЗаказы.Ссылка.Ссылка, ИСТИНА) = ИСТИНА
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ВАвто
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы0 КАК ВТ_ВсеЗаказы0
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = РейсЗаказы.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = ПогрузкаВАвтоЗаказы.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ КАК ЕстьНаТСД,
	               |	МАКСИМУМ(ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.ДатаВремя, ""--"")) КАК ДатаВремяНаТСД,
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ
	               |ПОМЕСТИТЬ ВТ_ТСД
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |		ПО (ВТ_ВсеЗаказы.Заказ = ВЫРАЗИТЬ(ЗагрузкаСТСДШтрихкоды.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(СостоянияЗаказов.Доставка.Ссылка, ИСТИНА) = ИСТИНА
	               |			ТОГДА ИСТИНА
	               |		ИНАЧЕ ЛОЖЬ
	               |	КОНЕЦ КАК Перенесено
	               |ПОМЕСТИТЬ ВТ_Перенесенные
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияЗаказов КАК СостоянияЗаказов
	               |		ПО ВТ_ВсеЗаказы.Заказ.Номер = СостоянияЗаказов.Доставка.Номер
	               |ГДЕ
	               |	СостоянияЗаказов.ПричинаНеВыполнения = ЗНАЧЕНИЕ(справочник.причиныневыполнениядоставки.переносдоставки)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПривязкаМашинКРейсамСрезПоследних.Водитель КАК Водитель,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт КАК Транспорт,
	               |	ПривязкаМашинКРейсамСрезПоследних.Экспедитор КАК Экспедитор,
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс КАК Рейс
	               |ПОМЕСТИТЬ ВТ_Транспорт
	               |ИЗ
	               |	РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, ) КАК ПривязкаМашинКРейсамСрезПоследних
	               |ГДЕ
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ, ИСТИНА) <> ИСТИНА
	               |				ИЛИ ВТ_ВсеЗаказы.УдаленИзРейса
	               |			ТОГДА ""--НЕ МАРШРУТИЗИРОВАНО--""
	               |		ИНАЧЕ ""МАРШРУТИЗИРОВАНО""
	               |	КОНЕЦ КАК ВидДанных
	               |ПОМЕСТИТЬ ВТ_Маршрутизировано
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтклоненияСпискаЗаказовПриПогрузкеВАвто КАК ОтклоненияСпискаЗаказовПриПогрузкеВАвто
	               |		ПО ВТ_ВсеЗаказы.Заказ = ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ПогрузкаВАвтоЗаказы.КоличествоМест, ИСТИНА) = ИСТИНА
	               |			ТОГДА 0
	               |		ИНАЧЕ ПогрузкаВАвтоЗаказы.КоличествоМест
	               |	КОНЕЦ КАК КоличествоМест,
	               |	ВТ_ВсеЗаказы.Заказ.Ссылка КАК Заказ
	               |ПОМЕСТИТЬ ВТ_КоличествоМест
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы.Заказ.Ссылка = ПогрузкаВАвтоЗаказы.Заказ.Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер КАК НомерЗаказаСтриж,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара КАК ИнтернетМагазин,
	               |	ЕСТЬNULL(РеализацияТоваровУслугТовары.Номенклатура, ""Товарное вложение"") КАК Номенклатура,
	               |	РеализацияТоваровУслугТовары.Номенклатура.Артикул КАК Артикул,
	               |	РеализацияТоваровУслугТовары.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	РеализацияТоваровУслугТовары.Сумма КАК Сумма,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслугТовары.Ссылка.КоличествоМест) КАК Количество,
	               |	ВТ_ВсеЗаказы.Рейс КАК Рейс,
	               |	ВТ_ВсеЗаказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Заказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслугТовары.Ссылка.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара,
	               |	ВозвратТоваровОтПокупателяТовары.Номенклатура,
	               |	ВозвратТоваровОтПокупателяТовары.Номенклатура.Артикул,
	               |	ВозвратТоваровОтПокупателяТовары.ШтрихкодНоменклатуры,
	               |	-ВозвратТоваровОтПокупателяТовары.Сумма,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, ВТ_ВсеЗаказы.Заказ.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтПокупателя.Товары КАК ВозвратТоваровОтПокупателяТовары
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |			ПО (РеализацияТоваровУслугТовары.Ссылка.Номер = ВозвратТоваровОтПокупателяТовары.Ссылка.Номер)
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = ВозвратТоваровОтПокупателяТовары.Ссылка.Номер)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	""Предоплата по кредиту"",
	               |	""-"",
	               |	""-"",
	               |	-РеализацияТоваровУслуг.Ссылка.ПредоплатаПоКредиту,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.ТипОплаты = 2
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	""------------ОТКАЗНОЙ ТОВАР------------"",
	               |	""-"",
	               |	""-"",
	               |	0,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.СтатусИнтернетМагазина = 4
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_Заказы.Номенклатура КАК Номенклатура,
	               |	ВТ_Заказы.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Заказы.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Транспорт.Водитель КАК Водитель,
	               |	ВТ_Транспорт.Транспорт КАК Транспорт,
	               |	ВТ_Транспорт.Экспедитор КАК Экспедитор,
	               |	ВТ_ТСД.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Заказы.Заказ КАК Заказ,
	               |	ВТ_ТСД.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Заказы.Артикул КАК Артикул,
	               |	ВТ_Заказы.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	ВТ_Заказы.Количество КАК Количество,
	               |	ВТ_Заказы.Сумма КАК Сумма,
	               |	ВТ_Заказы.Заказ КАК КоличествоЗаказов,
	               |	ВТ_КоличествоМест.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Перенесенные.Перенесено КАК Перенесено,
	               |	ВТ_Заказы.Рейс КАК Рейс,
	               |	ВТ_Заказы.Рейс.НомерПалетты КАК НомерСклад,
	               |	ВТ_Заказы.Рейс.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Заказы.Рейс.РейсМестнойДоставки КАК РейсМД,
	               |	ВТ_Маршрутизировано.ВидДанных КАК ВидДанных,
	               |	ВТ_Заказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Финиш
	               |ИЗ
	               |	ВТ_Заказы КАК ВТ_Заказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТСД КАК ВТ_ТСД
	               |		ПО (ВТ_Заказы.Заказ = ВЫРАЗИТЬ(ВТ_ТСД.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Маршрутизировано КАК ВТ_Маршрутизировано
	               |		ПО ВТ_Заказы.Заказ = ВТ_Маршрутизировано.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Перенесенные КАК ВТ_Перенесенные
	               |		ПО ВТ_Заказы.Заказ = ВТ_Перенесенные.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КоличествоМест КАК ВТ_КоличествоМест
	               |		ПО ВТ_Заказы.Заказ = ВТ_КоличествоМест.Заказ,
	               |	ВТ_Транспорт КАК ВТ_Транспорт
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_Финиш.Номенклатура КАК Номенклатура,
	               |	ВТ_Финиш.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель КАК Водитель,
	               |	ВТ_Финиш.Транспорт КАК Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ КАК Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор КАК Экспедитор,
	               |	ВТ_Финиш.Артикул КАК Артикул,
	               |	ВТ_Финиш.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	ВТ_Финиш.Количество КАК Количество,
	               |	ВТ_Финиш.Сумма КАК Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов КАК КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Финиш.Перенесено КАК Перенесено,
	               |	ВТ_Финиш.Рейс КАК Рейс,
	               |	ВТ_Финиш.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Финиш.НомерСклад КАК НомерСклад,
	               |	ВТ_Финиш.РейсМД КАК РейсМД,
	               |	ВТ_Финиш.ВидДанных КАК ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе КАК ЗаказВРейсе
	               |ИЗ
	               |	ВТ_Финиш КАК ВТ_Финиш
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_Финиш.Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор,
	               |	ВТ_Финиш.НомерЗаказаСтриж,
	               |	ВТ_Финиш.Номенклатура,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель,
	               |	ВТ_Финиш.Артикул,
	               |	ВТ_Финиш.ШтрихкодНоменклатуры,
	               |	ВТ_Финиш.Количество,
	               |	ВТ_Финиш.Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест,
	               |	ВТ_Финиш.Перенесено,
	               |	ВТ_Финиш.Рейс,
	               |	ВТ_Финиш.ДатаРейса,
	               |	ВТ_Финиш.НомерСклад,
	               |	ВТ_Финиш.РейсМД,
	               |	ВТ_Финиш.ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВТ_Финиш.ИнтернетМагазин.Наименование,
	               |	ВТ_Финиш.Заказ.Номер,
	               |	ВТ_Финиш.Номенклатура.Наименование
	               |ИТОГИ
	               |	МАКСИМУМ(НомерЗаказаСтриж),
	               |	МАКСИМУМ(НомерВнешнегоЗаказа),
	               |	МАКСИМУМ(Водитель),
	               |	МАКСИМУМ(Транспорт),
	               |	МАКСИМУМ(ЕстьНаТСД),
	               |	МАКСИМУМ(ДатаВремяНаТСД),
	               |	МАКСИМУМ(Экспедитор),
	               |	МАКСИМУМ(Артикул),
	               |	МАКСИМУМ(ШтрихкодНоменклатуры),
	               |	МАКСИМУМ(Количество),
	               |	СУММА(Сумма),
	               |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ КоличествоЗаказов),
	               |	МАКСИМУМ(КоличествоМест),
	               |	МАКСИМУМ(Перенесено),
	               |	МАКСИМУМ(ДатаРейса),
	               |	МАКСИМУМ(НомерСклад),
	               |	МАКСИМУМ(РейсМД),
	               |	МАКСИМУМ(ЗаказВРейсе)
	               |ПО
	               |	Рейс,
	               |	ВидДанных,
	               |	ИнтернетМагазин,
	               |	Заказ,
	               |	Номенклатура";
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ПолучитьТекстЗапросаКопия()
	
	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	РейсЗаказы.Заказ.Ссылка КАК Заказ,
	               |	РейсЗаказы.Ссылка.Ссылка КАК Рейс
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы0
	               |ИЗ
	               |	Документ.Рейс.Заказы КАК РейсЗаказы
	               |ГДЕ
	               |	РейсЗаказы.Ссылка.Ссылка = &Рейс
	               |	И РейсЗаказы.Заказ.Ссылка ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ПогрузкаВАвтоЗаказы.Заказ.Ссылка,
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс
	               |ИЗ
	               |	Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |ГДЕ
	               |	ПогрузкаВАвтоЗаказы.Ссылка.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_ВсеЗаказы0.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы0.Рейс КАК Рейс,
	               |	РейсЗаказы.УдаленИзРейса КАК УдаленИзРейса,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(РейсЗаказы.УдаленИзРейса, ИСТИНА) = ИСТИНА
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ЗаказВРейсе,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ПогрузкаВАвтоЗаказы.Ссылка.Ссылка, ИСТИНА) = ИСТИНА
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ВАвто
	               |ПОМЕСТИТЬ ВТ_ВсеЗаказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы0 КАК ВТ_ВсеЗаказы0
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Рейс.Заказы КАК РейсЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = РейсЗаказы.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы0.Заказ = ПогрузкаВАвтоЗаказы.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ КАК ЕстьНаТСД,
	               |	МАКСИМУМ(ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.ДатаВремя, ""--"")) КАК ДатаВремяНаТСД,
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ
	               |ПОМЕСТИТЬ ВТ_ТСД
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗагрузкаСТСД.Штрихкоды КАК ЗагрузкаСТСДШтрихкоды
	               |		ПО (ВТ_ВсеЗаказы.Заказ = ВЫРАЗИТЬ(ЗагрузкаСТСДШтрихкоды.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ЗагрузкаСТСДШтрихкоды.Заказ, ИСТИНА) = ИСТИНА
	               |			ТОГДА ""--""
	               |		ИНАЧЕ ""ДА""
	               |	КОНЕЦ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(СостоянияЗаказов.Доставка.Ссылка, ИСТИНА) = ИСТИНА
	               |			ТОГДА ИСТИНА
	               |		ИНАЧЕ ЛОЖЬ
	               |	КОНЕЦ КАК Перенесено
	               |ПОМЕСТИТЬ ВТ_Перенесенные
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияЗаказов КАК СостоянияЗаказов
	               |		ПО ВТ_ВсеЗаказы.Заказ.Номер = СостоянияЗаказов.Доставка.Номер
	               |ГДЕ
	               |	СостоянияЗаказов.ПричинаНеВыполнения = ЗНАЧЕНИЕ(справочник.причиныневыполнениядоставки.переносдоставки)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПривязкаМашинКРейсамСрезПоследних.Водитель КАК Водитель,
	               |	ПривязкаМашинКРейсамСрезПоследних.Транспорт КАК Транспорт,
	               |	ПривязкаМашинКРейсамСрезПоследних.Экспедитор КАК Экспедитор,
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс КАК Рейс
	               |ПОМЕСТИТЬ ВТ_Транспорт
	               |ИЗ
	               |	РегистрСведений.ПривязкаМашинКРейсам.СрезПоследних(, ) КАК ПривязкаМашинКРейсамСрезПоследних
	               |ГДЕ
	               |	ПривязкаМашинКРейсамСрезПоследних.Рейс = &Рейс
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ, ИСТИНА) <> ИСТИНА
	               |				ИЛИ ВТ_ВсеЗаказы.УдаленИзРейса
	               |			ТОГДА ""--НЕ МАРШРУТИЗИРОВАНО--""
	               |		ИНАЧЕ ""МАРШРУТИЗИРОВАНО""
	               |	КОНЕЦ КАК ВидДанных
	               |ПОМЕСТИТЬ ВТ_Маршрутизировано
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтклоненияСпискаЗаказовПриПогрузкеВАвто КАК ОтклоненияСпискаЗаказовПриПогрузкеВАвто
	               |		ПО ВТ_ВсеЗаказы.Заказ = ОтклоненияСпискаЗаказовПриПогрузкеВАвто.Заказ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ПогрузкаВАвтоЗаказы.КоличествоМест, ИСТИНА) = ИСТИНА
	               |			ТОГДА 0
	               |		ИНАЧЕ ПогрузкаВАвтоЗаказы.КоличествоМест
	               |	КОНЕЦ КАК КоличествоМест,
	               |	ВТ_ВсеЗаказы.Заказ.Ссылка КАК Заказ
	               |ПОМЕСТИТЬ ВТ_КоличествоМест
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПогрузкаВАвто.Заказы КАК ПогрузкаВАвтоЗаказы
	               |		ПО ВТ_ВсеЗаказы.Заказ.Ссылка = ПогрузкаВАвтоЗаказы.Заказ.Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ КАК Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер КАК НомерЗаказаСтриж,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара КАК ИнтернетМагазин,
	               |	ЕСТЬNULL(РеализацияТоваровУслугТовары.Номенклатура, ""Товарное вложение"") КАК Номенклатура,
	               |	РеализацияТоваровУслугТовары.Номенклатура.Артикул КАК Артикул,
	               |	РеализацияТоваровУслугТовары.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	РеализацияТоваровУслугТовары.Сумма КАК Сумма,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслугТовары.Ссылка.КоличествоМест) КАК Количество,
	               |	ВТ_ВсеЗаказы.Рейс КАК Рейс,
	               |	ВТ_ВсеЗаказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Заказы
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслугТовары.Ссылка.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	ВТ_ВсеЗаказы.Заказ.Номер,
	               |	ВТ_ВсеЗаказы.Заказ.НомерВнешнегоЗаказа,
	               |	ВТ_ВсеЗаказы.Заказ.ВладелецТовара,
	               |	ВозвратТоваровОтПокупателяТовары.Номенклатура,
	               |	ВозвратТоваровОтПокупателяТовары.Номенклатура.Артикул,
	               |	ВозвратТоваровОтПокупателяТовары.ШтрихкодНоменклатуры,
	               |	-ВозвратТоваровОтПокупателяТовары.Сумма,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, ВТ_ВсеЗаказы.Заказ.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтПокупателя.Товары КАК ВозвратТоваровОтПокупателяТовары
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |			ПО (РеализацияТоваровУслугТовары.Ссылка.Номер = ВозвратТоваровОтПокупателяТовары.Ссылка.Номер)
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = ВозвратТоваровОтПокупателяТовары.Ссылка.Номер)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	""Предоплата по кредиту"",
	               |	""-"",
	               |	""-"",
	               |	-РеализацияТоваровУслуг.Ссылка.ПредоплатаПоКредиту,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.ТипОплаты = 2
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВТ_ВсеЗаказы.Заказ,
	               |	РеализацияТоваровУслуг.Номер,
	               |	РеализацияТоваровУслуг.НомерВнешнегоЗаказа,
	               |	РеализацияТоваровУслуг.ВладелецТовара,
	               |	""------------ОТКАЗНОЙ ТОВАР------------"",
	               |	""-"",
	               |	""-"",
	               |	0,
	               |	ЕСТЬNULL(Накладная003Заказы.КоличествоМест, РеализацияТоваровУслуг.Ссылка.КоличествоМест),
	               |	ВТ_ВсеЗаказы.Рейс,
	               |	NULL
	               |ИЗ
	               |	ВТ_ВсеЗаказы КАК ВТ_ВсеЗаказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка = РеализацияТоваровУслуг.Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Накладная003.Заказы КАК Накладная003Заказы
	               |		ПО (ВЫРАЗИТЬ(ВТ_ВсеЗаказы.Заказ КАК Документ.РеализацияТоваровУслуг).Номер = Накладная003Заказы.НомерЗаказа)
	               |ГДЕ
	               |	ВТ_ВсеЗаказы.Заказ ССЫЛКА Документ.РеализацияТоваровУслуг
	               |	И РеализацияТоваровУслуг.СтатусИнтернетМагазина = 4
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_Заказы.Номенклатура КАК Номенклатура,
	               |	ВТ_Заказы.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Заказы.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Заказы.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Транспорт.Водитель КАК Водитель,
	               |	ВТ_Транспорт.Транспорт КАК Транспорт,
	               |	ВТ_Транспорт.Экспедитор КАК Экспедитор,
	               |	ВТ_ТСД.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Заказы.Заказ КАК Заказ,
	               |	ВТ_ТСД.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Заказы.Артикул КАК Артикул,
	               |	ВТ_Заказы.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	ВТ_Заказы.Количество КАК Количество,
	               |	ВТ_Заказы.Сумма КАК Сумма,
	               |	ВТ_Заказы.Заказ КАК КоличествоЗаказов,
	               |	ВТ_КоличествоМест.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Перенесенные.Перенесено КАК Перенесено,
	               |	ВТ_Заказы.Рейс КАК Рейс,
	               |	ВТ_Заказы.Рейс.НомерПалетты КАК НомерСклад,
	               |	ВТ_Заказы.Рейс.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Заказы.Рейс.РейсМестнойДоставки КАК РейсМД,
	               |	ВТ_Маршрутизировано.ВидДанных КАК ВидДанных,
	               |	ВТ_Заказы.ЗаказВРейсе КАК ЗаказВРейсе
	               |ПОМЕСТИТЬ ВТ_Финиш
	               |ИЗ
	               |	ВТ_Заказы КАК ВТ_Заказы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТСД КАК ВТ_ТСД
	               |		ПО (ВТ_Заказы.Заказ = ВЫРАЗИТЬ(ВТ_ТСД.Заказ КАК Документ.РеализацияТоваровУслуг).Ссылка)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Маршрутизировано КАК ВТ_Маршрутизировано
	               |		ПО ВТ_Заказы.Заказ = ВТ_Маршрутизировано.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Перенесенные КАК ВТ_Перенесенные
	               |		ПО ВТ_Заказы.Заказ = ВТ_Перенесенные.Заказ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КоличествоМест КАК ВТ_КоличествоМест
	               |		ПО ВТ_Заказы.Заказ = ВТ_КоличествоМест.Заказ,
	               |	ВТ_Транспорт КАК ВТ_Транспорт
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_Финиш.Номенклатура КАК Номенклатура,
	               |	ВТ_Финиш.НомерЗаказаСтриж КАК НомерЗаказаСтриж,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа КАК НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин КАК ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель КАК Водитель,
	               |	ВТ_Финиш.Транспорт КАК Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД КАК ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ КАК Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД КАК ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор КАК Экспедитор,
	               |	ВТ_Финиш.Артикул КАК Артикул,
	               |	ВТ_Финиш.ШтрихкодНоменклатуры КАК ШтрихкодНоменклатуры,
	               |	ВТ_Финиш.Количество КАК Количество,
	               |	ВТ_Финиш.Сумма КАК Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов КАК КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест КАК КоличествоМест,
	               |	ВТ_Финиш.Перенесено КАК Перенесено,
	               |	ВТ_Финиш.Рейс КАК Рейс,
	               |	ВТ_Финиш.ДатаРейса КАК ДатаРейса,
	               |	ВТ_Финиш.НомерСклад КАК НомерСклад,
	               |	ВТ_Финиш.РейсМД КАК РейсМД,
	               |	ВТ_Финиш.ВидДанных КАК ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе КАК ЗаказВРейсе
	               |ИЗ
	               |	ВТ_Финиш КАК ВТ_Финиш
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВТ_Финиш.Транспорт,
	               |	ВТ_Финиш.ЕстьНаТСД,
	               |	ВТ_Финиш.Заказ,
	               |	ВТ_Финиш.ДатаВремяНаТСД,
	               |	ВТ_Финиш.Экспедитор,
	               |	ВТ_Финиш.НомерЗаказаСтриж,
	               |	ВТ_Финиш.Номенклатура,
	               |	ВТ_Финиш.НомерВнешнегоЗаказа,
	               |	ВТ_Финиш.ИнтернетМагазин,
	               |	ВТ_Финиш.Водитель,
	               |	ВТ_Финиш.Артикул,
	               |	ВТ_Финиш.ШтрихкодНоменклатуры,
	               |	ВТ_Финиш.Количество,
	               |	ВТ_Финиш.Сумма,
	               |	ВТ_Финиш.КоличествоЗаказов,
	               |	ВТ_Финиш.КоличествоМест,
	               |	ВТ_Финиш.Перенесено,
	               |	ВТ_Финиш.Рейс,
	               |	ВТ_Финиш.ДатаРейса,
	               |	ВТ_Финиш.НомерСклад,
	               |	ВТ_Финиш.РейсМД,
	               |	ВТ_Финиш.ВидДанных,
	               |	ВТ_Финиш.ЗаказВРейсе
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВТ_Финиш.ИнтернетМагазин.Наименование,
	               |	ВТ_Финиш.Заказ.Номер,
	               |	ВТ_Финиш.Номенклатура.Наименование
	               |ИТОГИ
	               |	МАКСИМУМ(НомерЗаказаСтриж),
	               |	МАКСИМУМ(НомерВнешнегоЗаказа),
	               |	МАКСИМУМ(Водитель),
	               |	МАКСИМУМ(Транспорт),
	               |	МАКСИМУМ(ЕстьНаТСД),
	               |	МАКСИМУМ(ДатаВремяНаТСД),
	               |	МАКСИМУМ(Экспедитор),
	               |	МАКСИМУМ(Артикул),
	               |	МАКСИМУМ(ШтрихкодНоменклатуры),
	               |	МАКСИМУМ(Количество),
	               |	СУММА(Сумма),
	               |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ КоличествоЗаказов),
	               |	МАКСИМУМ(КоличествоМест),
	               |	МАКСИМУМ(Перенесено),
	               |	МАКСИМУМ(ДатаРейса),
	               |	МАКСИМУМ(НомерСклад),
	               |	МАКСИМУМ(РейсМД),
	               |	МАКСИМУМ(ЗаказВРейсе)
	               |ПО
	               |	Рейс,
	               |	ВидДанных,
	               |	ИнтернетМагазин,
	               |	Заказ,
	               |	Номенклатура";
	
	Возврат ТекстЗапроса;
КонецФункции
